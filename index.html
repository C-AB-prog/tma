<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Diamond Feed ‚Ä¢ TMA</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<style>
:root{--bg:#0b0f18;--surface:#0f1422;--card:#151b2e;--muted:#9aa3b5;--text:#f4f7ff;--brand:#7da9ff;--brand-2:#a67aff;--ok:#44d6a3;--err:#ff7f88;--radius:16px;--shadow:0 16px 56px rgba(0,0,0,.4);--ring:0 0 0 2px rgba(125,169,255,.45)}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:
  radial-gradient(1200px 520px at 15% -10%, rgba(125,169,255,.16), transparent 55%),
  radial-gradient(900px 420px at 105% -15%, rgba(166,122,255,.14), transparent 60%),
  linear-gradient(180deg,#0b0f18,#0a0d16 50%,#0b0f18);
  color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Inter,Roboto,Segoe UI,Arial,sans-serif}
.container{max-width:760px;margin:0 auto;padding:0 14px calc(88px + env(safe-area-inset-bottom))}
.topbar{position:sticky;top:0;z-index:70;backdrop-filter:saturate(1.2) blur(12px);background:linear-gradient(to bottom, rgba(11,15,24,.92), rgba(11,15,24,.55));border-bottom:1px solid rgba(255,255,255,.06)}
.topbar-row{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:34px;height:34px;border-radius:12px;display:grid;place-items:center;background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 150deg, var(--brand) 360deg);box-shadow:0 14px 32px rgba(125,169,255,.45)}
.logo i{color:#fff}.title{font-weight:900}
.head-kpis{display:flex;gap:8px;align-items:center}
.pill{display:flex;gap:8px;align-items:center;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));font-size:12px;font-weight:900}
.meta-line{padding:0 14px 10px;color:var(--muted);font-size:12px}
.meta-line .chip{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05)}
.progress{height:3px;background:rgba(255,255,255,.08)} .progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand-2));transition:width .4s}
.section{display:none;animation:.25s fade ease} .section.active{display:block}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.card{background:linear-gradient(180deg,#151b2e,#141a2a);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:14px;margin:12px 0;box-shadow:var(--shadow)}
.row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.user{display:flex;gap:10px;align-items:center;cursor:pointer}
.avatar{position:relative;width:42px;height:42px;border-radius:50%;overflow:hidden;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#0b0f18}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.dot{position:absolute;right:-2px;bottom:-2px;width:12px;height:12px;border-radius:50%;border:2px solid var(--card)}
.dot.online{background:var(--ok)}
.name{font-weight:900}.muted{color:var(--muted)} .meta{color:var(--muted);font-size:12px;margin-top:2px}
.content{margin:10px 0 8px;line-height:1.6;font-size:15px}
.stats{display:flex;gap:14px;color:var(--muted);font-size:12px}
.actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
.btn{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);font-weight:900;cursor:pointer}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.badge{display:inline-flex;gap:6px;align-items:center;padding:5px 9px;border-radius:10px;border:1px solid rgba(255,255,255,.13);font-size:11px}
.badge.rocket{color:var(--ok);border-color:rgba(68,214,163,.4);background:linear-gradient(180deg, rgba(68,214,163,.18), rgba(255,255,255,.02))}
.empty{padding:44px 18px;text-align:center;color:var(--muted)}

/* PIN –∫—Ä–∞—Å–∏–≤—ã–π */
.pinned{margin:12px 0;border-radius:18px;display:none}
.pinned .card{background:linear-gradient(180deg, rgba(125,169,255,.12), rgba(125,169,255,.03)),linear-gradient(180deg,#151b2e,#141a2a);border:1px solid rgba(125,169,255,.25);box-shadow:0 18px 50px rgba(125,169,255,.18);position:relative;overflow:hidden}
.pinned .card:before{content:"";position:absolute;left:0;top:0;bottom:0;width:4px;background:linear-gradient(180deg,var(--brand),var(--brand-2));opacity:.8}
.pinned .head{display:flex;align-items:center;justify-content:space-between;padding:8px 10px 10px;border-bottom:1px dashed rgba(255,255,255,.14);gap:10px}
.pin-left{display:flex;gap:8px;align-items:center}
.pin-chip{display:inline-flex;gap:8px;align-items:center;padding:7px 12px;border-radius:12px;background:rgba(125,169,255,.12);border:1px solid rgba(125,169,255,.35);font-weight:900;color:var(--brand)}
.pin-author{display:inline-flex;gap:8px;align-items:center;padding:7px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);font-weight:800}
.pin-timer{display:inline-flex;gap:8px;align-items:center;padding:7px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);font-weight:800;color:var(--muted)}
.pinned .body{padding:14px}
.pinned .body .content{margin:6px 0 8px;font-size:17px;line-height:1.75;font-weight:600;white-space:pre-wrap;word-break:break-word;text-shadow:0 0 1px rgba(255,255,255,.05)}
.pin-meta{display:flex;gap:14px;color:var(--muted);font-size:12px;margin-top:6px}
#pin-cta .btn{padding:11px 14px}

/* Nav */
.nav{position:fixed;left:0;right:0;bottom:0;z-index:90;backdrop-filter:blur(12px);background:linear-gradient(to top, rgba(11,15,24,.92), rgba(11,15,24,.55));border-top:1px solid rgba(255,255,255,.08);padding:10px 8px calc(10px + env(safe-area-inset-bottom));display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.nav button{border:none;background:none;color:var(--muted);display:flex;flex-direction:column;gap:4px;align-items:center;padding:8px 6px;border-radius:10px;font-size:11px}
.nav button.active{color:var(--brand);background:rgba(125,169,255,.16)}
.fab{position:fixed;right:14px;bottom:calc(84px + env(safe-area-inset-bottom));width:58px;height:58px;border-radius:50%;display:grid;place-items:center;border:none;cursor:pointer;color:white;z-index:120;background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 160deg, var(--brand) 360deg);box-shadow:0 22px 62px rgba(125,169,255,.6)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.62);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:150}
.modal__card{width:min(92vw,460px);max-height:84vh;overflow:auto;border-radius:18px;border:1px solid rgba(255,255,255,.09);background:var(--card);padding:18px}
.modal__head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}.modal__title{font-weight:900}.close{border:none;background:none;color:var(--muted);font-size:20px;cursor:pointer}
.label{font-size:13px;color:var(--muted);margin:6px 0}
.input,.textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.09);background:#0f1426;color:var(--text)}
.textarea{min-height:120px;resize:vertical}.submit{width:100%;margin-top:10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;text-align:center}
.stat .v{font-size:18px;font-weight:900}
.prof{display:flex;gap:12px;align-items:center}
.prof-ava{width:64px;height:64px;border-radius:50%;overflow:hidden;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#0b0f18}
.prof-ava img{width:100%;height:100%;object-fit:cover;display:block}
.prof-name{font-size:18px;font-weight:900}
.section-title{font-weight:900;margin:8px 0 6px}
.toast{position:fixed;right:14px;top:78px;z-index:160;display:grid;gap:8px}
.toast .t{padding:11px 13px;border-radius:12px;color:#0b0b0f;font-weight:900}
.t.ok{background:#44d6a3}.t.err{background:#ff7f88}.t.info{background:#7da9ff}

/* user modal */
.u-head{display:flex;gap:12px;align-items:center}
.u-ava{width:58px;height:58px;border-radius:50%;overflow:hidden;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,var(--brand),var(--brand-2))}
.u-ava img{width:100%;height:100%;object-fit:cover;display:block}
.u-name{font-weight:900}
.u-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
</style>
</head>
<body>

<!-- Gate: —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram -->
<script>
(function(){
  const tg=window.Telegram?.WebApp; let BOT='t11stMini_bot'; if(BOT.startsWith('@')) BOT=BOT.slice(1);
  if(!tg || !tg.initDataUnsafe?.user){
    document.body.innerHTML=`
      <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0f18;color:#f4f7ff;padding:24px;text-align:center">
        <div style="max-width:520px;background:#151b2e;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:22px">
          <div style="font-size:20px;font-weight:900;margin-bottom:6px">–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram</div>
          <div style="color:#9aa3b5;margin-bottom:12px">–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram.</div>
          <a href="https://t.me/${BOT}?startapp=tma" style="display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg,#7da9ff,#a67aff);color:#fff;font-weight:900;text-decoration:none">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</a>
          <div style="color:#9aa3b5;font-size:12px;margin-top:8px">t.me/${BOT}</div>
        </div>
      </div>`;
    window.__STOP_APP__=true; return;
  }
  try{ tg.ready(); tg.expand(); tg.disableVerticalSwipes?.(); }catch(e){}
})();
</script>

<div class="toast" id="toast"></div>

<header class="topbar">
  <div class="topbar-row container">
    <div class="brand">
      <div class="logo"><i class="fa-solid fa-gem"></i></div>
      <div class="title">Diamond Feed</div>
    </div>
    <div class="head-kpis">
      <div class="pill"><i class="fa-solid fa-gem"></i><span id="bal">0</span></div>
      <div class="pill"><i class="fa-solid fa-star"></i><span id="pts">0</span></div>
      <div class="pill"><i class="fa-solid fa-coins"></i><span id="pool-pill">0</span></div>
      <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É -->
      <button class="pill" id="admin-reset" title="–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å" style="display:none">
        <i class="fa-solid fa-broom"></i>
      </button>
    </div>
  </div>
  <div class="meta-line container"><span class="chip"><i class="fa-regular fa-clock"></i> –¥–æ 24:00 UTC: <b id="eta">--:--:--</b></span></div>
  <div class="progress"><span id="prog"></span></div>
</header>

<main class="container">
  <!-- PIN -->
  <section class="pinned" id="pin-wrap">
    <div class="card">
      <div class="head">
        <div class="pin-left">
          <span class="pin-chip"><i class="fa-solid fa-thumbtack"></i> –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ</span>
          <span class="pin-author" id="pin-author">‚Äî</span>
        </div>
        <div class="pin-timer"><i class="fa-regular fa-clock"></i> <span id="pin-left">‚Äî</span></div>
      </div>
      <div class="body">
        <div class="content" id="pin-text"></div>
        <div class="pin-meta">
          <span><i class="fa-regular fa-eye"></i> <span id="pin-views">0</span></span>
          <span><i class="fa-regular fa-heart"></i> <span id="pin-likes">0</span></span>
        </div>
        <div id="pin-cta" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <!-- FEED -->
  <section id="feed-section" class="section active">
    <div style="display:flex;gap:8px;margin:8px 0 4px">
      <button class="pill" id="tab-friends"><i class="fa-solid fa-user-group"></i> –î—Ä—É–∑—å—è</button>
      <button class="pill" id="tab-all" style="box-shadow:var(--ring)"><i class="fa-solid fa-globe"></i> –í—Å–µ</button>
    </div>
    <div id="feed"></div>
    <div id="feed-empty" class="empty" style="display:none"><i class="fa-regular fa-newspaper" style="font-size:40px"></i><div>–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞. –ù–∞–∂–º–∏—Ç–µ ¬´+¬ª.</div></div>
  </section>

  <!-- PROFILE -->
  <section id="profile-section" class="section">
    <div class="card">
      <div class="prof">
        <div class="prof-ava" id="pf-ava"><span>U</span></div>
        <div>
          <div class="prof-name" id="pf-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
          <div class="meta" id="pf-id">ID: ‚Äî</div>
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div class="stat"><div class="v" id="pf-d">0</div><div class="muted">–ê–ª–º–∞–∑–æ–≤</div></div>
        <div class="stat"><div class="v" id="pf-p">0</div><div class="muted">–ü–æ—Å—Ç–æ–≤</div></div>
        <div class="stat"><div class="v" id="pf-rd">0</div><div class="muted">–ü—Ä–æ—á—Ç–µ–Ω–∏–π</div></div>
        <div class="stat"><div class="v" id="pf-rc">0</div><div class="muted">–†–µ–∞–∫—Ü–∏–π</div></div>
        <div class="stat"><div class="v" id="pf-pts">0</div><div class="muted">–ë–∞–ª–ª–æ–≤</div></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="to-friends"><i class="fa-solid fa-user-group"></i> –î—Ä—É–∑—å—è</button>
        <button class="btn" id="to-store"><i class="fa-solid fa-store"></i> –ú–∞–≥–∞–∑–∏–Ω</button>
      </div>
    </div>
  </section>

  <!-- FRIENDS -->
  <section id="friends-section" class="section">
    <div class="section-title">–î—Ä—É–∑—å—è</div>
    <div class="card">
      <div class="label">–î–æ–±–∞–≤–∏—Ç—å –ø–æ User ID –∏–ª–∏ @username</div>
      <div style="display:flex;gap:8px">
        <input id="friend-input" class="input" placeholder="@username –∏–ª–∏ 123456"/>
        <button class="btn" id="friend-add"><i class="fa-solid fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
    <div class="grid">
      <div class="card"><div class="section-title">–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã</div><div id="following" class="muted">‚Äî</div></div>
      <div class="card"><div class="section-title">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div><div id="followers" class="muted">‚Äî</div></div>
    </div>
  </section>

  <!-- STORE -->
  <section id="store-section" class="section">
    <div class="section-title">–ú–∞–≥–∞–∑–∏–Ω –∞–ª–º–∞–∑–æ–≤</div>
    <div class="card">
      <div class="grid" style="margin-top:8px">
        <button class="btn" data-pack="100">100 üíé</button>
        <button class="btn" data-pack="500">500 üíé</button>
        <button class="btn" data-pack="1000">1000 üíé</button>
        <button class="btn" data-pack="5000">5000 üíé</button>
      </div>
      <div class="meta" style="margin-top:8px">–î–µ–º–æ-–æ–ø–ª–∞—Ç–∞: –∑–∞—á–∏—Å–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É</div>
    </div>
  </section>

  <!-- POOL -->
  <section id="pool-section" class="section">
    <div class="section-title">–ü—É–ª –Ω–∞–≥—Ä–∞–¥</div>
    <div class="card"><div class="name">–¢–µ–∫—É—â–∏–π –ø—É–ª: <b id="pool-amt">0</b> üíé</div></div>
  </section>
</main>

<nav class="nav">
  <button class="active" data-go="feed-section"><i class="fa-solid fa-home"></i><span>–õ–µ–Ω—Ç–∞</span></button>
  <button data-go="profile-section"><i class="fa-solid fa-user"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  <button data-go="friends-section"><i class="fa-solid fa-user-group"></i><span>–î—Ä—É–∑—å—è</span></button>
  <button data-go="store-section"><i class="fa-solid fa-store"></i><span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
  <button data-go="pool-section"><i class="fa-solid fa-coins"></i><span>–ü—É–ª</span></button>
</nav>

<button class="fab" id="fab"><i class="fa-solid fa-plus"></i></button>

<!-- Modals -->
<div class="modal" id="m-create"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</div><button class="close" data-close>&times;</button></div>
  <label class="label">–¢–µ–∫—Å—Ç (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤, –±–µ–∑ —Å—Å—ã–ª–æ–∫)</label>
  <textarea id="post-txt" class="textarea" maxlength="500" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —á–µ–º-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º‚Ä¶"></textarea>
  <button id="post-send" class="btn submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞ 10 üíé</button>
</div></div>

<div class="modal" id="m-boost"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">–ë—É—Å—Ç –ø–æ—Å—Ç–∞</div><button class="close" data-close>&times;</button></div>
  <div class="label">–ü–æ–¥–Ω—è—Ç—å –ø–æ—Å—Ç –≤ —Ç–æ–ø –∑–∞ 10 üíé? (–∫—É–ª–¥–∞—É–Ω 5 –º–∏–Ω—É—Ç)</div>
  <button id="boost-do" class="btn submit">–ü–æ–¥–Ω—è—Ç—å –∑–∞ 10 üíé</button>
  <div class="meta" id="boost-hint"></div>
</div></div>

<div class="modal" id="m-pin"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">–ó–∞–∫—Ä–µ–ø–∏—Ç—å –ø–æ—Å—Ç</div><button class="close" data-close>&times;</button></div>
  <div class="label">1 –º–∏–Ω—É—Ç–∞ –∑–∞–∫—Ä–µ–ø–∞ = 100 üíé. –ï—Å–ª–∏ –∑–∞–Ω—è—Ç–æ ‚Äî –ø—Ä–æ–¥–ª–∏—Ç –≤–∞—à –∂–µ –∑–∞–∫—Ä–µ–ø.</div>
  <button id="pin-do" class="btn submit">–ó–∞–∫—Ä–µ–ø–∏—Ç—å –∑–∞ 100 üíé</button>
</div></div>

<!-- USER PROFILE MODAL -->
<div class="modal" id="m-user"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">–ü—Ä–æ—Ñ–∏–ª—å</div><button class="close" data-close>&times;</button></div>
  <div class="u-head">
    <div class="u-ava" id="u-ava"></div>
    <div>
      <div class="u-name" id="u-name">‚Äî</div>
      <div class="meta" id="u-username">@‚Äî</div>
    </div>
  </div>
  <div class="u-grid" style="margin-top:10px">
    <div class="stat"><div class="v" id="u-posts">0</div><div class="muted">–ü–æ—Å—Ç–æ–≤</div></div>
    <div class="stat"><div class="v" id="u-likes">0</div><div class="muted">–õ–∞–π–∫–æ–≤</div></div>
    <div class="stat"><div class="v" id="u-views">0</div><div class="muted">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div></div>
  </div>
  <div style="display:flex;gap:8px;margin-top:12px">
    <button class="btn" id="u-follow"><i class="fa-solid fa-user-plus"></i> –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
    <button class="btn" id="u-unfollow" style="display:none"><i class="fa-solid fa-user-minus"></i> –û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
  </div>
</div></div>

<script>
if(!window.__STOP_APP__){

/* ===== –¢–ï–ú–ê ===== */
(function(){try{const tp=Telegram?.WebApp?.themeParams||{};const set=(k,v)=>v&&document.documentElement.style.setProperty(k,v);
if(tp.text_color)set('--text',tp.text_color); if(tp.bg_color)set('--bg',tp.bg_color);
if(tp.secondary_bg_color){set('--surface',tp.secondary_bg_color);set('--card',tp.secondary_bg_color);}
if(tp.button_color)set('--brand',tp.button_color); if(tp.hint_color)set('--muted',tp.hint_color);}catch(e){} })();

/* ===== –ö–û–ù–°–¢–ê–ù–¢–´/–Æ–¢–ò–õ–´ ===== */
const ADMIN_ID='955974106';             // –≤–∞—à Telegram ID (–∞–¥–º–∏–Ω)
const CLEAR_ALL_AT_SETTLE=false;        // –ø–æ—Å—Ç–∞–≤–∏—Ç—å true => –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC –±—É–¥–µ—Ç —Ç–æ—Ç–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å
const BOOST_WINDOW=5*60*1000;
const ABLY_CHANNEL='tma';
const INSTANCE=(()=>{let v=localStorage.getItem('df-instance');if(!v){v=(Date.now().toString(36)+Math.random().toString(36).slice(2,8));localStorage.setItem('df-instance',v);}return v;})();
const epochEnd=()=> new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate()+1,0,0,0));
const epochIdUTC=(d)=>`${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
const fmt=(ms)=>{if(!Number.isFinite(ms)||ms<0)ms=0;const s=(ms/1000)|0;return `${String((s/3600)|0).padStart(2,'0')}:${String(((s%3600)/60)|0).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`};
const byId=(id)=>document.getElementById(id);
const esc=(s)=>String(s??'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const toTime=(d)=>{ if(!d) return 0; if(d instanceof Date && Number.isFinite(d.getTime())) return d.getTime(); const t=Date.parse(d); return Number.isFinite(t)?t:0; };
function toast(m,kind='ok'){const t=document.createElement('div');t.className=`t ${kind==='err'?'err':kind==='info'?'info':'ok'}`;t.textContent=m;byId('toast').appendChild(t);setTimeout(()=>t.remove(),2600);}
function show(el){el.style.display='flex'} function hide(el){el.style.display='none'}
function go(id){document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active',b.dataset.go===id));document.querySelectorAll('.section').forEach(s=>s.classList.toggle('active',s.id===id));}
const avatarHTML=(u)=>{const ph=u.photo||u.photo_url;return ph?`<div class="avatar"><img src="${ph}" referrerpolicy="no-referrer" alt=""></div>`:`<div class="avatar">${(u.firstName||u.username||'U').slice(0,1).toUpperCase()}</div>`}

/* ===== CloudStorage ===== */
const CS=Telegram?.WebApp?.CloudStorage;
const cloud={avail:!!CS,get:(k)=>new Promise(res=>CS?.getItem(k,(e,v)=>res(e?null:v))),set:(k,v)=>new Promise((res,rej)=>CS?.setItem(k,v,(e)=>e?rej(e):res())),mget:(keys)=>new Promise(res=>CS?.getItems(keys,(e,items)=>res(e?{}:items||{})))};

/* ===== Realtime ===== */
const RT=(()=>{const listeners=new Set();const KEY='E9rkjQ.VFe0Fg:BHe2MLdpKyWGye0G7gZ1lAMruelNAmTxep63oVw2uoY';
let ab=null,ch=null;
const ready=(async()=>{try{ab=new Ably.Realtime.Promise(KEY);ch=ab.channels.get(ABLY_CHANNEL);
try{
  const page=await ch.history({limit:300});
  const items=page?.items||[];
  for(let i=items.length-1;i>=0;i--){
    const m=items[i];
    const data=m.data&&m.data.type?m.data:{type:m.name,payload:m.data,ts:Date.parse(m.timestamp)||Date.now(),origin:null};
    // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–æ –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞
    if(state.app?.resetAt && Date.parse(m.timestamp) < state.app.resetAt) continue;
    listeners.forEach(fn=>fn(data,true));
  }
}catch(_){}
ch.subscribe(msg=>{const d=msg.data&&msg.data.type?msg.data:{type:msg.name,payload:msg.data,ts:Date.now()};listeners.forEach(fn=>fn(d,false));});
}catch(e){toast('Ably –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è','err');}})();
return {ready,send:(type,payload)=>{try{ch&&ch.publish(type,{type,payload,ts:Date.now(),origin:INSTANCE});}catch(e){}},on:(fn)=>listeners.add(fn)};
})();

/* ===== STATE ===== */
let state={
  users:{}, current:null, posts:[],
  pool:{amt:0,epochEnds:epochEnd(),settledId:null},
  pin:{active:null}, social:{following:{},followers:{}},
  presence:{}, viewsByUser:{}, likesByUser:{}, epochPoints:{},
  app:{resetAt:0} // –º–µ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
};
const LS='diamond-feed';
function revive(o){if(!o||typeof o!=='object')return o;if(o.__d)return new Date(o.__d);if(Array.isArray(o)){for(let i=0;i<o.length;i++)o[i]=revive(o[i]);return o;}for(const k in o)o[k]=revive(o[k]);return o;}
function saveLS(){try{localStorage.setItem(LS,JSON.stringify(state,(k,v)=>v instanceof Date?{__d:v.toISOString()}:v));}catch(_){}} 
function loadLS(){try{const raw=localStorage.getItem(LS);if(!raw)return false;const d=revive(JSON.parse(raw));
d.users||={};d.posts||=[];d.pool||={};d.pin||={};d.social||={following:{},followers:{}};d.viewsByUser||={};d.likesByUser||={};d.epochPoints||={};d.app||(d.app={resetAt:0});
if(!(d.pool.epochEnds instanceof Date))d.pool.epochEnds=epochEnd();state=d;return true;}catch(_){return false;}}
async function load(){loadLS();if(cloud.avail){try{const got=await cloud.mget(['df:pool','df:pin']);if(got['df:pool']){const p=JSON.parse(got['df:pool']);state.pool.amt=+p.amt||0;state.pool.epochEnds=new Date(p.epochEnds||epochEnd());state.pool.settledId=p.settledId||null;}if(got['df:pin']){const d=JSON.parse(got['df:pin']);state.pin.active=d?.active?{postId:d.active.postId,endsAt:new Date(d.active.endsAt)}:null;}}catch(_){}}}
function save(){saveLS();if(!cloud.avail)return;try{const uid=state.current;if(uid&&state.users[uid])cloud.set(`df:user:${uid}`,JSON.stringify(state.users[uid]));cloud.set(`df:pool`,JSON.stringify({amt:state.pool.amt||0,epochEnds:state.pool.epochEnds.toISOString(),settledId:state.pool.settledId||null}));cloud.set(`df:pin`,JSON.stringify(serPin()));}catch(_){}}
function persistUserEngagement(){if(!cloud.avail)return;const uid=state.current;if(!uid)return;try{const liked=Object.keys(state.likesByUser[uid]||{}).slice(-500);cloud.set(`df:liked:${uid}`,JSON.stringify(liked));const eid=epochIdUTC(new Date());const viewed=Object.keys(state.viewsByUser[uid]||{}).slice(-1000);cloud.set(`df:viewed:${uid}:${eid}`,JSON.stringify(viewed));}catch(_){}} 

/* ===== USER ===== */
async function initUser(){const u=Telegram?.WebApp?.initDataUnsafe?.user;const id=String(u.id);
state.users[id] ||= {id,firstName:u.first_name||'User',lastName:u.last_name||'',username:u.username||('user'+id),diamonds:300,isPremium:!!u.is_premium,points:0,updatedAt:Date.now(),photo:u.photo_url||null};
state.users[id].photo = u.photo_url || state.users[id].photo || null;
if(cloud.avail){try{const raw=await cloud.get(`df:user:${id}`);if(raw){const cs=JSON.parse(raw);const cur=state.users[id];state.users[id]={...cur,...cs,diamonds:Math.max(+cur.diamonds||0,+cs.diamonds||0),points:Math.max(+cur.points||0,+cs.points||0)};}}catch(_){}} 
state.current=id;state.social.following[id] ||= [];state.social.followers[id] ||= [];state.viewsByUser[id] ||= {};state.likesByUser[id] ||= {};state.epochPoints[id] ||= 0;
const btn=byId('admin-reset'); if(btn) {btn.style.display = (String(state.current)===String(ADMIN_ID))?'inline-flex':'none'; btn.onclick = hardResetAll;}
}
const nameOf=(u)=> u.firstName && u.lastName ? `${u.firstName} ${u.lastName}` : (u.firstName || '@'+u.username);
function syncUser(uid){const u=state.users[uid]; if(!u) return; u.updatedAt=Date.now(); save(); RT.send('user:update',{uid,diamonds:u.diamonds||0,points:u.points||0,updatedAt:u.updatedAt,photo:u.photo||null,firstName:u.firstName,lastName:u.lastName,username:u.username});}

/* ===== ECONOMY/POSTS ===== */
function spend(uid,amt){const u=state.users[uid];if(!u){toast('–°–µ—Å—Å–∏—è –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞','err');return false;}
if(u.diamonds<amt){toast(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤ (${u.diamonds}/${amt})`,'err');return false;}
u.diamonds-=amt;state.pool.amt=(state.pool.amt||0)+amt;syncUser(uid);renderHUD();RT.send('pool:add',{amount:amt,from:uid});return true;}
function award(uid,points){if(!uid||!Number.isFinite(points)||points<=0)return;state.users[uid].points=(state.users[uid].points||0)+points;state.epochPoints[uid]=(state.epochPoints[uid]||0)+points;syncUser(uid);renderHUD();RT.send('points:add',{uid,points});}
function publish(uid,text){const p={id:String(Date.now()+Math.random()),authorId:uid,text,createdAt:new Date(),likes:0,views:0,boostedAt:null};state.posts.unshift(p);save();renderAll();RT.send('post:new',{post:serPost(p)});return p;}
function createPostFlow(){const txt=byId('post-txt').value.trim();if(!txt){toast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç','err');return;}if(/https?:\/\//i.test(txt)){toast('–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã','err');return;}if(txt.length>500){toast('–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ','err');return;}if(!spend(state.current,10))return;publish(state.current,txt);hide(byId('m-create'));byId('post-txt').value='';toast('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');}
function like(postId){const uid=state.current;state.likesByUser[uid] ||= {};if(state.likesByUser[uid][postId]){toast('–£–∂–µ –ª–∞–π–∫–∞–ª–∏','info');return;}const p=state.posts.find(x=>x.id===postId);if(!p||p.authorId===uid)return;state.likesByUser[uid][postId]=true;p.likes++;p.views++;award(uid,2);save();persistUserEngagement();renderFeed();RT.send('engage:like',{uid,postId});RT.send('post:stats',{id:p.id,likes:p.likes,views:p.views});}
let currentPostId=null;function openBoost(id){currentPostId=id;const p=state.posts.find(x=>x.id===id);const left=p?.boostedAt?(toTime(p.boostedAt)+BOOST_WINDOW - Date.now()):0;byId('boost-hint').textContent=left>0?`–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ ${fmt(left)}`:'';show(byId('m-boost'));}
function doBoost(){const p=state.posts.find(x=>x.id===currentPostId);if(!p)return;if(p.authorId!==state.current){toast('–¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä','err');return;}const left=p.boostedAt?(toTime(p.boostedAt)+BOOST_WINDOW - Date.now()):0;if(left>0){toast('–ö—É–ª–¥–∞—É–Ω 5 –º–∏–Ω—É—Ç','err');return;}if(!spend(state.current,10)){hide(byId('m-boost'));return;}p.boostedAt=new Date();save();hide(byId('m-boost'));renderAll();RT.send('post:boost',{id:p.id,boostedAt:p.boostedAt.toISOString()});toast('–ü–æ—Å—Ç –ø–æ–¥–Ω—è—Ç');}
function openPin(id){currentPostId=id;show(byId('m-pin')); }
function doPin(){const p=state.posts.find(x=>x.id===currentPostId);if(!p)return;if(p.authorId!==state.current){toast('–¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä','err');return;}if(!spend(state.current,100)){hide(byId('m-pin'));return;}const ends=Date.now()+60*1000;state.pin.active={postId:p.id,endsAt:new Date(ends)};save();renderPin();RT.send('pin:update',serPin());hide(byId('m-pin'));toast('–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –Ω–∞ 1 –º–∏–Ω—É—Ç—É');}
function markViewed(postId){const uid=state.current;if(!uid)return;state.viewsByUser[uid] ||= {};if(state.viewsByUser[uid][postId])return;const p=state.posts.find(x=>x.id===postId);if(!p)return;state.viewsByUser[uid][postId]=true;p.views++;award(uid,1);save();persistUserEngagement();renderFeed();RT.send('engage:view',{uid,postId});RT.send('post:stats',{id:p.id,likes:p.likes,views:p.views});}

/* ===== –ü–†–ò–°–£–¢–°–¢–í–ò–ï ===== */
setInterval(()=>{const uid=state.current;state.presence[uid]=Date.now();RT.send('presence:ping',{uid});},5000);

/* ===== –î–†–£–ó–¨–Ø ===== */
const isFollowing=(me,to)=> !!(state.social.following[me]||[]).includes(to);
function follow(me,to){if(me===to)return false;state.social.following[me] ||= [];state.social.followers[to]  ||= [];if(isFollowing(me,to))return false;state.social.following[me].push(to);state.social.followers[to].push(me);save();renderFriends();renderFeed();toast('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞');RT.send('social:follow',{from:me,to});}
function unfollow(me,to){state.social.following[me]=(state.social.following[me]||[]).filter(x=>x!==to);state.social.followers[to]=(state.social.followers[to]||[]).filter(x=>x!==me);save();renderFriends();renderFeed();toast('–ü–æ–¥–ø–∏—Å–∫–∞ —Å–Ω—è—Ç–∞','info');RT.send('social:unfollow',{from:me,to});}

/* ===== –†–ï–ù–î–ï–† ===== */
function renderHUD(){const u=state.users[state.current]||{};byId('bal').textContent=u.diamonds||0;byId('pts').textContent=u.points||0;const ends=state.pool?.epochEnds instanceof Date?state.pool.epochEnds:epochEnd();const left=ends.getTime()-Date.now();byId('eta').textContent=fmt(left);byId('prog').style.width=`${Math.max(0,Math.min(1,1-(left/(24*3600*1000))))*100}%`;byId('pool-amt').textContent=(state.pool.amt||0).toFixed(2);byId('pool-pill').textContent=(state.pool.amt||0).toFixed(0);renderProfile();}
function renderProfile(){const u=state.users[state.current]||{};const ava=byId('pf-ava');ava.innerHTML=u.photo?`<img src="${u.photo}" referrerpolicy="no-referrer" alt="">`:`<span>${(u.firstName||u.username||'U').slice(0,1).toUpperCase()}</span>`;byId('pf-name').textContent=nameOf(u);byId('pf-id').textContent='ID: '+(u.id||'-');byId('pf-d').textContent=u.diamonds||0;byId('pf-p').textContent=state.posts.filter(p=>p.authorId===state.current).length;const myLikes=state.posts.filter(p=>p.authorId===state.current).reduce((a,b)=>a+(b.likes||0),0);byId('pf-rc').textContent=myLikes;byId('pf-pts').textContent=u.points||0;}
let feedObserver=null;
function renderFeed(){const feed=byId('feed');const uid=state.current;const now=Date.now();const items=(state.posts||[]).slice().sort((a,b)=>{const ab=(toTime(b.boostedAt)&&now-toTime(b.boostedAt)<BOOST_WINDOW)?toTime(b.boostedAt):0;const aa=(toTime(a.boostedAt)&&now-toTime(a.boostedAt)<BOOST_WINDOW)?toTime(a.boostedAt):0;return (ab-aa)||(toTime(b.createdAt)-toTime(a.createdAt));});const friendsOn=byId('tab-friends').dataset.active==='1';const following=new Set(state.social?.following?.[uid]||[]);const list=friendsOn?items.filter(p=>p.authorId===uid||following.has(p.authorId)):items;feed.innerHTML=list.map(p=>{const a=state.users[p.authorId]||{firstName:'User',username:''};const liked=!!(state.likesByUser[uid]&&state.likesByUser[uid][p.id]);const boostedActive=toTime(p.boostedAt)&&(now-toTime(p.boostedAt)<BOOST_WINDOW);const addBtn=p.authorId===uid?`<button class="btn" disabled><i class="fa-solid fa-user"></i> –í—ã</button>`:isFollowing(uid,p.authorId)?`<button class="btn" disabled><i class="fa-solid fa-user-check"></i> –£–∂–µ</button>`:`<button class="btn" onclick="follow('${uid}','${p.authorId}')"><i class="fa-solid fa-user-plus"></i> –î—Ä</button>`;return `
<article class="card post" data-id="${p.id}">
  <div class="row">
    <div class="user" data-uid="${p.authorId}">
      ${avatarHTML(a)}
      <div>
        <div class="name">${nameOf(a)} ${a.isPremium?'<i class="fa-solid fa-star" style="color:var(--ok)"></i>':''} ${p.authorId===uid?'<span class="muted">(–í—ã)</span>':''}</div>
        <div class="meta">${new Date(p.createdAt).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}${boostedActive?' ‚Ä¢ <span class="badge rocket"><i class="fa-solid fa-rocket"></i> Boost</span>':''}</div>
      </div>
    </div>
    <div><button class="btn" onclick="openPin('${p.id}')" ${p.authorId!==uid?'disabled':''}><i class="fa-solid fa-thumbtack"></i></button></div>
  </div>
  <div class="content">${esc(p.text)}</div>
  <div class="stats"><span><i class="fa-regular fa-eye"></i> ${p.views||0}</span><span><i class="fa-regular fa-heart"></i> ${p.likes||0}</span></div>
  <div class="actions">
    <button class="btn" ${p.authorId===uid||liked?'disabled':''} onclick="like('${p.id}')"><i class="fa-regular fa-heart"></i> –õ–∞–π–∫</button>
    <button class="btn" ${p.authorId!==uid?'disabled':''} onclick="openBoost('${p.id}')"><i class="fa-solid fa-rocket"></i> –ë—É—Å—Ç</button>
    ${addBtn}
  </div>
</article>`;}).join('');byId('feed-empty').style.display=list.length?'none':'block';renderPin();if(feedObserver)feedObserver.disconnect();feedObserver=new IntersectionObserver((ents)=>{ents.forEach(en=>{if(en.isIntersecting&&en.intersectionRatio>=0.5){markViewed(en.target.getAttribute('data-id'));feedObserver.unobserve(en.target);}})},{threshold:[0.5]});document.querySelectorAll('.post').forEach(el=>feedObserver.observe(el));}
function renderPin(){const w=byId('pin-wrap');if(!state.pin.active){w.style.display='none';return;}const p=state.posts.find(x=>x.id===state.pin.active.postId);if(!p){state.pin.active=null;save();RT.send('pin:update',serPin());w.style.display='none';return;}const a=state.users[p.authorId]||{firstName:'User'};w.style.display='block';byId('pin-author').textContent=nameOf(a);byId('pin-text').textContent=p.text;byId('pin-views').textContent=p.views||0;byId('pin-likes').textContent=p.likes||0;const leftMs=Math.max(0,toTime(state.pin.active.endsAt)-Date.now());byId('pin-left').textContent=leftMs>0?fmt(leftMs):'‚Äî';byId('pin-cta').innerHTML=p.authorId===state.current?`<button class="btn" onclick="openPin('${p.id}')"><i class="fa-solid fa-plus"></i> –ü—Ä–æ–¥–ª–∏—Ç—å</button>`:'';}
function renderFriends(){const uid=state.current;const followingIds=state.social.following[uid]||[];const followersIds=state.social.followers[uid]||[];const flw=followingIds.map(id=>state.users[id]?nameOf(state.users[id]):('@'+id)).join('<br/>')||'‚Äî';const fol=followersIds.map(id=>state.users[id]?nameOf(state.users[id]):('@'+id)).join('<br/>')||'‚Äî';byId('following').innerHTML=flw;byId('followers').innerHTML=fol;}
function renderAll(){renderHUD();renderFeed();renderFriends();}

/* ===== –ü–†–û–§–ò–õ–¨ –Æ–ó–ï–†–ê (–º–æ–¥–∞–ª–∫–∞) ===== */
function openUser(uid){const me=state.current;const u=state.users[uid]||{id:uid,firstName:'User',username:String(uid)};const posts=state.posts.filter(p=>p.authorId===uid);const likes=posts.reduce((a,b)=>a+(b.likes||0),0);const views=posts.reduce((a,b)=>a+(b.views||0),0);byId('u-ava').innerHTML = u.photo? `<img src="${u.photo}" referrerpolicy="no-referrer" alt="">` : `<div class="u-ava">${(u.firstName||u.username||'U').slice(0,1).toUpperCase()}</div>`;byId('u-name').textContent=nameOf(u);byId('u-username').textContent='@'+(u.username||'');byId('u-posts').textContent=posts.length;byId('u-likes').textContent=likes;byId('u-views').textContent=views;const following=isFollowing(me,uid);byId('u-follow').style.display = (!following && me!==uid)?'inline-flex':'none';byId('u-unfollow').style.display = (following && me!==uid)?'inline-flex':'none';byId('u-follow').onclick=()=>{follow(me,uid); hide(byId('m-user'));};byId('u-unfollow').onclick=()=>{unfollow(me,uid); hide(byId('m-user'));};show(byId('m-user'));}

/* ===== –°–ï–†–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===== */
function serPost(p){return {...p,createdAt:p.createdAt instanceof Date?p.createdAt.toISOString():p.createdAt,boostedAt:p.boostedAt?(p.boostedAt instanceof Date?p.boostedAt.toISOString():p.boostedAt):null};}
function serPin(){return {active:state.pin.active?{postId:state.pin.active.postId,endsAt:state.pin.active.endsAt.toISOString()}:null};}

/* ===== –°–ë–†–û–° –î–õ–Ø –í–°–ï–• ===== */
function hardResetAll(){
  if(String(state.current)!==String(ADMIN_ID)){toast('–ù–µ—Ç –ø—Ä–∞–≤','err');return;}
  const at=Date.now();
  state.app.resetAt=at;
  state.posts=[]; state.pin.active=null;
  state.pool.amt=0; state.pool.settledId=null;
  state.epochPoints={}; state.viewsByUser={}; state.likesByUser={};
  for(const uid in state.users) state.users[uid].points=0;
  save(); renderAll();
  try{
    if(Telegram?.WebApp?.CloudStorage){
      const cs=Telegram.WebApp.CloudStorage;
      cs.setItem('df:pin', JSON.stringify({active:null}), ()=>{});
      cs.setItem('df:pool', JSON.stringify({amt:0, epochEnds:epochEnd().toISOString(), settledId:null}), ()=>{});
      cs.setItem(`df:liked:${state.current}`, '[]', ()=>{});
      cs.setItem(`df:viewed:${state.current}:${epochIdUTC(new Date())}`, '[]', ()=>{});
    }
  }catch(_){}
  RT.send('app:reset',{at});
}

/* ===== –¢–∞–π–º–µ—Ä—ã –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É–ª–∞ ===== */
function settleIfNeeded(){
  const now=new Date();
  const left=state.pool.epochEnds.getTime()-now.getTime();
  if(left>0) return;

  const justFinished=new Date(state.pool.epochEnds.getTime()); justFinished.setUTCDate(justFinished.getUTCDate()-1);
  const eid=epochIdUTC(justFinished);
  if(state.pool.settledId===eid){ state.pool.epochEnds=epochEnd(); save(); renderHUD(); return; }

  const totalPts=Object.values(state.epochPoints||{}).reduce((a,b)=>a+(+b||0),0);
  const amount=state.pool.amt||0;
  const results={};
  if(totalPts>0&&amount>0){
    for(const uid in state.epochPoints){
      const share=(state.epochPoints[uid]||0)/totalPts;
      const gain=+(amount*share).toFixed(2);
      if(gain>0){ state.users[uid] ||= {diamonds:0,points:0,firstName:'User',id:uid,username:uid}; state.users[uid].diamonds=(state.users[uid].diamonds||0)+gain; results[uid]=gain; }
    }
  }
  state.pool.amt=0;
  state.pool.epochEnds=epochEnd();
  state.pool.settledId=eid;
  state.epochPoints={};
  for(const uid in state.users) state.users[uid].points=0;
  save(); renderHUD();
  RT.send('pool:settle',{eid,results,next:state.pool.epochEnds.toISOString(),resetPoints:true});

  if(CLEAR_ALL_AT_SETTLE){ RT.send('app:reset',{at:Date.now()}); }
}
function tick(){
  if(state.pin.active&&toTime(state.pin.active.endsAt)<=Date.now()){state.pin.active=null;save();RT.send('pin:update',serPin());}
  if(!(state.pool?.epochEnds instanceof Date)) state.pool.epochEnds=epochEnd();
  settleIfNeeded(); renderHUD(); renderPin();
}
setInterval(tick,1000);

/* ===== –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π RT ===== */
RT.on((evt)=>{ if(!evt||!evt.type) return;
  switch(evt.type){
    case 'app:reset':{
      const at=evt.payload?.at || Date.now();
      state.app.resetAt=at;
      state.posts=[]; state.pin.active=null;
      state.pool.amt=0; state.pool.settledId=null;
      state.epochPoints={}; state.viewsByUser={}; state.likesByUser={};
      for(const uid in state.users) state.users[uid].points=0;
      save(); renderAll();
      try{
        if(Telegram?.WebApp?.CloudStorage){
          const cs=Telegram.WebApp.CloudStorage;
          cs.setItem('df:pin', JSON.stringify({active:null}), ()=>{});
          cs.setItem('df:pool', JSON.stringify({amt:0, epochEnds:epochEnd().toISOString(), settledId:null}), ()=>{});
          cs.setItem(`df:liked:${state.current}`, '[]', ()=>{});
          cs.setItem(`df:viewed:${state.current}:${epochIdUTC(new Date())}`, '[]', ()=>{});
        }
      }catch(_){}
      toast('–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω','info');
      break;
    }
    case 'user:upsert':{const u=evt.payload.user;if(!u)break;state.users[u.id]={...(state.users[u.id]||{}),...u};save();renderFeed();renderFriends();break;}
    case 'user:update':{const {uid,diamonds,points,updatedAt,photo,firstName,lastName,username}=evt.payload||{};if(!uid)return;state.users[uid] ||= {id:uid,diamonds:0,points:0,firstName:'User',username:uid};const cur=state.users[uid].updatedAt||0;if(!Number.isFinite(cur)||(Number.isFinite(updatedAt)&&updatedAt>=cur)){Object.assign(state.users[uid],{diamonds:+diamonds||0,points:+points||0,updatedAt:+updatedAt||Date.now()});if(photo)state.users[uid].photo=photo;if(firstName)state.users[uid].firstName=firstName;if(lastName!==undefined)state.users[uid].lastName=lastName;if(username)state.users[uid].username=username;if(uid===state.current){save();renderHUD();}}break;}
    case 'post:new':{const p=evt.payload.post; if(!state.posts.find(x=>x.id===p.id)){state.posts.unshift({ ...p, createdAt:new Date(p.createdAt), boostedAt:p.boostedAt?new Date(p.boostedAt):null }); save(); renderFeed();} break;}
    case 'post:stats':{const {id,likes,views}=evt.payload;const p=state.posts.find(x=>x.id===id);if(p){p.likes=Math.max(p.likes,likes);p.views=Math.max(p.views,views);save();renderFeed();}break;}
    case 'post:boost':{const {id,boostedAt}=evt.payload;const p=state.posts.find(x=>x.id===id);if(p){p.boostedAt=new Date(boostedAt);save();renderFeed();}break;}
    case 'pin:update':{const d=evt.payload;state.pin.active=d.active?{postId:d.active.postId,endsAt:new Date(d.active.endsAt)}:null;save();renderPin();break;}
    case 'social:follow':{const {from,to}=evt.payload;state.social.followers[to] ||= [];if(!state.social.followers[to].includes(from))state.social.followers[to].push(from);save();renderFriends();renderFeed();break;}
    case 'social:unfollow':{const {from,to}=evt.payload;state.social.followers[to]=(state.social.followers[to]||[]).filter(x=>x!==from);save();renderFriends();renderFeed();break;}
    case 'presence:ping':{const {uid}=evt.payload;state.presence[uid]=Date.now();break;}
    case 'points:add':{const {uid,points}=evt.payload||{};if(Number.isFinite(points)&&points>0){state.epochPoints[uid]=(state.epochPoints[uid]||0)+points;}break;}
    case 'pool:add':{ if(evt.origin===INSTANCE) break; const {amount}=evt.payload||{}; if(typeof amount==='number'){state.pool.amt=(state.pool.amt||0)+amount;save();renderHUD();} break;}
    case 'pool:settle':{const {eid,results,next,resetPoints}=evt.payload||{};if(!eid||state.pool.settledId===eid)break;for(const uid in results){state.users[uid] ||= {diamonds:0,points:0,id:uid,firstName:'User',username:uid};state.users[uid].diamonds=(state.users[uid].diamonds||0)+(+results[uid]||0);}state.pool.amt=0;state.pool.settledId=eid;if(next)state.pool.epochEnds=new Date(next);state.epochPoints={};if(resetPoints){for(const uid in state.users){state.users[uid].points=0;}}save();renderHUD();break;}
  }
});

/* ===== UI ===== */
document.addEventListener('click',e=>{
  if(e.target.closest('[data-close]'))e.target.closest('.modal').style.display='none';
  const nav=e.target.closest('.nav button');if(nav&&nav.dataset.go){go(nav.dataset.go);}
  const pack=e.target.closest('#store-section [data-pack]');if(pack){const amt=parseInt(pack.dataset.pack,10);const u=state.users[state.current];u.diamonds=(u.diamonds||0)+amt;syncUser(state.current);renderHUD();toast(`–ö—É–ø–ª–µ–Ω–æ ${amt} üíé`);}
  const userEl=e.target.closest('.user[data-uid]'); if(userEl){ openUser(userEl.dataset.uid); }
});
byId('fab').onclick=()=>show(byId('m-create'));
byId('post-send').onclick=createPostFlow;
byId('boost-do').onclick=doBoost;
byId('pin-do').onclick=doPin;
byId('tab-all').onclick=()=>{byId('tab-all').style.boxShadow='var(--ring)';byId('tab-friends').style.boxShadow='none';delete byId('tab-friends').dataset.active;renderFeed();};
byId('tab-friends').onclick=()=>{byId('tab-friends').style.boxShadow='var(--ring)';byId('tab-friends').dataset.active='1';byId('tab-all').style.boxShadow='none';renderFeed();};
byId('friend-add').onclick=()=>{const v=byId('friend-input').value.trim();if(!v)return;const me=state.current;let id=v.startsWith('@')?v.slice(1):v;state.users[id] ||= {id,firstName:v.startsWith('@')?('@'+id):('User '+id),username:id,diamonds:0,points:0};state.epochPoints[id] ||= 0;follow(me,id);byId('friend-input').value='';};
byId('to-friends').onclick=()=>go('friends-section'); byId('to-store').onclick=()=>go('store-section');

/* ===== BOOT ===== */
(async()=>{await load();await initUser();renderAll();RT.ready.finally(()=>{RT.send('user:upsert',{user:state.users[state.current]});});})();
window.like=like; window.openBoost=openBoost; window.openPin=openPin; window.follow=follow; window.unfollow=unfollow; window.hardResetAll=hardResetAll;

} // end !__STOP_APP__
</script>
</body>
</html>
