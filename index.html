<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Diamond Feed • v1.9 (Telegram-only, Ably realtime)</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
<style>
:root{
  --bg:#0b0f18;--surface:#0f1422;--card:#151b2e;--muted:#9aa3b5;--text:#f4f7ff;
  --brand:#7da9ff;--brand-2:#a67aff;--ok:#44d6a3;--err:#ff7f88;
  --radius:16px;--shadow:0 16px 56px rgba(0,0,0,.4);--ring:0 0 0 2px rgba(125,169,255,.45);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 520px at 15% -10%, rgba(125,169,255,.16), transparent 55%),
    radial-gradient(900px 420px at 105% -15%, rgba(166,122,255,.14), transparent 60%),
    linear-gradient(180deg,#0b0f18,#0a0d16 50%,#0b0f18);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Inter,Roboto,Segoe UI,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
}
.container{max-width:760px;margin:0 auto;padding:0 14px calc(88px + env(safe-area-inset-bottom))}

/* Topbar (упрощённый) */
.topbar{position:sticky;top:0;z-index:70;backdrop-filter:saturate(1.2) blur(12px);
  background:linear-gradient(to bottom, rgba(11,15,24,.9), rgba(11,15,24,.55));
  border-bottom:1px solid rgba(255,255,255,.06)}
.topbar-row{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:34px;height:34px;border-radius:12px;display:grid;place-items:center;
  background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 150deg, var(--brand) 360deg);
  box-shadow:0 14px 32px rgba(125,169,255,.45)}
.logo i{color:#fff}
.title{font-weight:900;letter-spacing:.2px}
.head-kpis{display:flex;gap:8px}
.pill{display:flex;gap:8px;align-items:center;padding:7px 12px;border-radius:12px;
  border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
  font-size:12px;font-weight:900}
.meta-line{padding:0 14px 10px;color:var(--muted);font-size:12px}
.meta-line .chip{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:12px;
  border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05)}
.progress{height:3px;background:rgba(255,255,255,.08)} .progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand-2));transition:width .4s}

/* Sections */
.section{display:none;animation:.25s fade ease} .section.active{display:block}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Pinned */
.pinned{margin:12px 0;border-radius:18px;display:none}
.pinned .card{background:linear-gradient(180deg, rgba(125,169,255,.16), rgba(125,169,255,.04));backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.1);border-radius:18px}
.pinned .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.14)}
.pinned .body{padding:12px}
.pin-meta{display:flex;gap:12px;color:var(--muted);font-size:12px;margin-top:6px}

/* Post cards */
.card{background:linear-gradient(180deg,#151b2e,#141a2a);border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);padding:14px;margin:12px 0;box-shadow:var(--shadow);transition:transform .12s ease, box-shadow .2s ease}
.card:hover{transform:translateY(-1px);box-shadow:0 20px 60px rgba(0,0,0,.45)}
.row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.user{display:flex;gap:10px;align-items:center}
.avatar{position:relative;width:42px;height:42px;border-radius:50%;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,var(--brand),var(--brand-2))}
.dot{position:absolute;right:-2px;bottom:-2px;width:11px;height:11px;border-radius:50%;border:2px solid var(--card)} .dot.online{background:var(--ok)}
.name{font-weight:900}.muted{color:var(--muted)} .meta{color:var(--muted);font-size:12px;margin-top:2px}
.content{margin:10px 0 8px;line-height:1.6;font-size:15px}
.stats{display:flex;gap:14px;color:var(--muted);font-size:12px}
.actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
.btn{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);font-weight:900;cursor:pointer;transition:transform .08s}
.btn:active{transform:translateY(1px)} .btn:hover{box-shadow:var(--ring)} .btn[disabled]{opacity:.45;cursor:not-allowed}
.btn.like.liked{border-color:rgba(255,127,136,.45);background:linear-gradient(180deg, rgba(255,127,136,.22), rgba(255,255,255,.02));color:#ff8f9a}
.badge{display:inline-flex;gap:6px;align-items:center;padding:5px 9px;border-radius:10px;border:1px solid rgba(255,255,255,.13);font-size:11px}
.badge.rocket{color:var(--ok);border-color:rgba(68,214,163,.4);background:linear-gradient(180deg, rgba(68,214,163,.18), rgba(255,255,255,.02))}
.empty{padding:44px 18px;text-align:center;color:var(--muted)}

/* Nav: 5 вкладок */
.nav{position:fixed;left:0;right:0;bottom:0;z-index:90;
  backdrop-filter:blur(12px);background:linear-gradient(to top, rgba(11,15,24,.92), rgba(11,15,24,.55));
  border-top:1px solid rgba(255,255,255,.08);padding:10px 8px calc(10px + env(safe-area-inset-bottom));
  display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.nav button{border:none;background:none;color:var(--muted);display:flex;flex-direction:column;gap:4px;align-items:center;padding:8px 6px;border-radius:10px;font-size:11px}
.nav button.active{color:var(--brand);background:rgba(125,169,255,.16)}

/* FAB — поднял z-index, чтобы точно кликабельна поверх навбара */
.fab{position:fixed;right:14px;bottom:calc(84px + env(safe-area-inset-bottom));width:58px;height:58px;border-radius:50%;
  display:grid;place-items:center;border:none;cursor:pointer;color:white;z-index:120;
  background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 160deg, var(--brand) 360deg);
  box-shadow:0 22px 62px rgba(125,169,255,.6)}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.62);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:150}
.modal__card{width:min(92vw,460px);max-height:84vh;overflow:auto;border-radius:18px;border:1px solid rgba(255,255,255,.09);background:var(--card);padding:18px}
.modal__head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.modal__title{font-weight:900}.close{border:none;background:none;color:var(--muted);font-size:20px;cursor:pointer}
.label{font-size:13px;color:var(--muted);margin:6px 0}
.input,.textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.09);background:#0f1426;color:var(--text)}
.textarea{min-height:120px;resize:vertical}
.submit{width:100%;margin-top:10px}

/* Профиль — лаконично */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);
  border-radius:14px;padding:14px;text-align:center}
.stat .v{font-size:18px;font-weight:900}
.prof{display:flex;gap:12px;align-items:center}
.prof-ava{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,var(--brand),var(--brand-2))}
.prof-name{font-size:18px;font-weight:900}
.section-title{font-weight:900;margin:8px 0 6px}

/* Toast */
.toast{position:fixed;right:14px;top:78px;z-index:160;display:grid;gap:8px}
.toast .t{padding:11px 13px;border-radius:12px;color:#0b0b0f;font-weight:900}
.t.ok{background:#44d6a3}.t.err{background:#ff7f88}.t.info{background:#7da9ff}
@media(hover:hover){::-webkit-scrollbar{height:10px;width:10px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:10px}}
</style>
</head>
<body>

<!-- Телеграм-гейт -->
<script>
(function gate(){
  const tg=window.Telegram?.WebApp; let BOT='t11stMini_bot'; if(BOT.startsWith('@')) BOT=BOT.slice(1);
  if(!tg || !tg.initDataUnsafe?.user){
    const link=`https://t.me/${BOT}?startapp=go`;
    document.body.innerHTML = `
      <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0f18;color:#f4f7ff;padding:24px;text-align:center">
        <div style="max-width:520px;background:#151b2e;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:22px">
          <div style="font-size:20px;font-weight:900;margin-bottom:6px">Откройте через Telegram</div>
          <div style="color:#9aa3b5;margin-bottom:12px">Это мини-приложение доступно только внутри Telegram.</div>
          <a href="${link}" style="display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg,#7da9ff,#a67aff);color:white;font-weight:900;text-decoration:none">Открыть в Telegram</a>
          <div style="color:#9aa3b5;font-size:12px;margin-top:8px">t.me/${BOT}</div>
        </div>
      </div>`;
    window.__STOP_APP__=true; return;
  }
  window.__STOP_APP__=false;
  try{ tg.ready(); tg.expand(); tg.disableVerticalSwipes?.(); }catch(e){}
})();
</script>

<div class="toast" id="toast"></div>

<header class="topbar">
  <div class="topbar-row container">
    <div class="brand">
      <div class="logo"><i class="fa-solid fa-gem"></i></div>
      <div class="title">Diamond Feed</div>
    </div>
    <div class="head-kpis">
      <!-- убрали RAW/EFF из головы, только баланс -->
      <div class="pill"><i class="fa-solid fa-gem"></i><span id="bal">0</span></div>
    </div>
  </div>
  <div class="meta-line container">
    <span class="chip"><i class="fa-regular fa-clock"></i> до 24:00 UTC: <b id="eta">--:--:--</b></span>
  </div>
  <div class="progress"><span id="prog"></span></div>
</header>

<main class="container">

  <!-- PIN -->
  <section class="pinned" id="pin-wrap">
    <div class="card">
      <div class="head">
        <div class="pill" style="color:var(--brand)"><i class="fa-solid fa-thumbtack"></i> Закреплено • <span id="pin-author">—</span></div>
        <div class="pill"><i class="fa-regular fa-clock"></i> <span id="pin-left">01:00</span></div>
      </div>
      <div class="body">
        <div class="content" id="pin-text"></div>
        <div class="pin-meta">
          <span><i class="fa-regular fa-eye"></i> <span id="pin-views">0</span></span>
          <span><i class="fa-regular fa-heart"></i> <span id="pin-likes">0</span></span>
        </div>
        <div id="pin-cta" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <!-- FEED -->
  <section id="feed-section" class="section active">
    <div style="display:flex;gap:8px;margin:8px 0 4px">
      <button class="pill" id="tab-friends"><i class="fa-solid fa-user-group"></i> Друзья</button>
      <button class="pill" id="tab-all" style="box-shadow:var(--ring)"><i class="fa-solid fa-globe"></i> Все</button>
    </div>
    <div id="feed"></div>
    <div id="feed-empty" class="empty" style="display:none"><i class="fa-regular fa-newspaper" style="font-size:40px"></i><div>Лента пуста. Нажмите «+», чтобы написать пост.</div></div>
  </section>

  <!-- PROFILE (лаконичный) -->
  <section id="profile-section" class="section">
    <div class="card">
      <div class="prof">
        <div class="prof-ava" id="pf-ava">U</div>
        <div>
          <div class="prof-name" id="pf-name">Пользователь</div>
          <div class="meta" id="pf-id">ID: —</div>
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div class="stat"><div class="v" id="pf-d">0</div><div class="muted">Алмазов</div></div>
        <div class="stat"><div class="v" id="pf-p">0</div><div class="muted">Постов</div></div>
        <div class="stat"><div class="v" id="pf-rd">0</div><div class="muted">Прочтений</div></div>
        <div class="stat"><div class="v" id="pf-rc">0</div><div class="muted">Реакций</div></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="to-friends"><i class="fa-solid fa-user-group"></i> Друзья</button>
        <button class="btn" id="to-store"><i class="fa-solid fa-store"></i> Магазин</button>
      </div>
    </div>
  </section>

  <!-- FRIENDS -->
  <section id="friends-section" class="section">
    <div class="section-title">Друзья</div>
    <div class="card">
      <div class="label">Добавить по User ID или @username</div>
      <div style="display:flex;gap:8px">
        <input id="friend-input" class="input" placeholder="@username или 123456"/>
        <button class="btn" id="friend-add"><i class="fa-solid fa-user-plus"></i> Добавить</button>
      </div>
    </div>
    <div class="grid">
      <div class="card"><div class="section-title">Вы подписаны</div><div id="following" class="muted">—</div></div>
      <div class="card"><div class="section-title">Подписчики</div><div id="followers" class="muted">—</div></div>
    </div>
  </section>

  <!-- STORE -->
  <section id="store-section" class="section">
    <div class="section-title">Магазин алмазов</div>
    <div class="card">
      <div class="label">Оплата (демо)</div>
      <div class="grid" style="margin-top:8px">
        <button class="btn" data-pack="100">100 💎</button>
        <button class="btn" data-pack="500">500 💎</button>
        <button class="btn" data-pack="1000">1000 💎</button>
        <button class="btn" data-pack="5000">5000 💎</button>
      </div>
      <div class="meta" style="margin-top:8px">Средства зачисляются мгновенно (эмуляция)</div>
    </div>
  </section>

  <!-- POOL -->
  <section id="pool-section" class="section">
    <div class="section-title">Пул наград</div>
    <div class="card"><div class="name">Текущий пул: <b id="pool-amt">0</b> 💎</div></div>
  </section>

</main>

<nav class="nav">
  <button class="active" data-go="feed-section"><i class="fa-solid fa-home"></i><span>Лента</span></button>
  <button data-go="profile-section"><i class="fa-solid fa-user"></i><span>Профиль</span></button>
  <button data-go="friends-section"><i class="fa-solid fa-user-group"></i><span>Друзья</span></button>
  <button data-go="store-section"><i class="fa-solid fa-store"></i><span>Магазин</span></button>
  <button data-go="pool-section"><i class="fa-solid fa-coins"></i><span>Пул</span></button>
</nav>

<button class="fab" id="fab"><i class="fa-solid fa-plus"></i></button>

<!-- Modals -->
<div class="modal" id="m-create"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">Создать пост</div><button class="close" data-close>&times;</button></div>
  <label class="label">Текст (до 500 символов, без ссылок)</label>
  <textarea id="post-txt" class="textarea" maxlength="500" placeholder="Поделитесь чем-то интересным…"></textarea>
  <button id="post-send" class="btn submit">Опубликовать за 10 💎</button>
</div></div>

<div class="modal" id="m-boost"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">Буст поста</div><button class="close" data-close>&times;</button></div>
  <div class="label">Поднять пост в топ за 10 💎? (кулдаун 5 минут)</div>
  <button id="boost-do" class="btn submit">Поднять за 10 💎</button>
  <div class="meta" id="boost-hint"></div>
</div></div>

<div class="modal" id="m-pin"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">Закрепить пост</div><button class="close" data-close>&times;</button></div>
  <div class="label">1 минута закрепа = 100 💎. Если занято — встанет в очередь.</div>
  <button id="pin-do" class="btn submit">Закрепить за 100 💎</button>
</div></div>

<script>
if(!window.__STOP_APP__){

/* ---- safe theme (не ломаем читаемость) ---- */
(function safeTheme(){
  try{
    const tp = Telegram?.WebApp?.themeParams || {};
    const set=(k,v)=> v && document.documentElement.style.setProperty(k,v);
    if(tp.text_color) set('--text',tp.text_color);
    if(tp.bg_color)   set('--bg',tp.bg_color);
    if(tp.secondary_bg_color) { set('--surface',tp.secondary_bg_color); set('--card',tp.secondary_bg_color); }
    if(tp.button_color) set('--brand',tp.button_color);
    if(tp.hint_color)   set('--muted',tp.hint_color);
  }catch(e){}
})();

/* ---- constants ---- */
const ECON=Object.freeze({ COST_POST:10, COST_BOOST:10, COST_PIN:100, BOOST_CD:5*60*1000 });
const now=()=>new Date();
const epochEnd=()=> new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate()+1,0,0,0));
const fmt=(ms)=>{ if(ms<0) ms=0; const s=(ms/1000)|0; const h=String((s/3600)|0).padStart(2,'0'); const m=String(((s%3600)/60)|0).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}` };
const byId=(id)=>document.getElementById(id);

/* ---- realtime (Ably; ключ встроен) ---- */
const RT=(()=>{ 
  const listeners=new Set();
  const DEFAULT_KEY='M0ySVA.pJLtkQ:SQP5uiSTbYG8Q7YbpWxq_T_YS5LcALRE5KXktyfOl5Y';
  const CHANNEL='diamond-feed';
  let ab=null,ch=null,ready=false;

  (async()=>{
    try{
      ab=new Ably.Realtime.Promise(DEFAULT_KEY);
      ch=ab.channels.get(CHANNEL);
      ch.subscribe(m=>{ const data=m.data&&m.data.type?m.data:{type:m.name,payload:m.data,ts:Date.now()}; listeners.forEach(f=>f(data)); });
      // history (последние 200 сообщений)
      try{
        const pg=await ch.history({limit:200});
        const items=pg?.items||[];
        for(let i=items.length-1;i>=0;i--){
          const m=items[i]; const data=m.data&&m.data.type?m.data:{type:m.name,payload:m.data,ts:Date.parse(m.timestamp)||Date.now()};
          listeners.forEach(f=>f(data));
        }
      }catch(e){ toast('Ably: история недоступна (включите Persist all messages)','info'); }
      ready=true;
    }catch(e){ console.error(e); toast('Ably не подключился. Работает только локально.','err'); }
  })();

  return {
    send:(type,payload)=>{ const msg={type,payload,ts:Date.now()}; if(ch) try{ ch.publish(type,msg);}catch(e){}; },
    on:(fn)=> listeners.add(fn)
  };
})();

/* ---- state ---- */
let state={
  users:{}, current:null, posts:[],
  pool:{ amt:0, epochEnds:epochEnd() },
  pin:{ active:null, queue:[] },
  points:{}, caps:{}, social:{ following:{}, followers:{} }
};
const LSKEY='df-v19';
const save=()=>localStorage.setItem(LSKEY, JSON.stringify(state,(k,v)=>v instanceof Date?{__d:v.toISOString()}:v));
const revive=(o)=>{ if(!o||typeof o!=='object') return o; if(o.__d) return new Date(o.__d); for(const k in o) o[k]=revive(o[k]); return o; };
const load=()=>{ const raw=localStorage.getItem(LSKEY); if(!raw) return false; try{ state=revive(JSON.parse(raw)); return true; }catch(e){ return false; }};

/* ---- user ---- */
function initUser(){
  const u=Telegram?.WebApp?.initDataUnsafe?.user;
  if(!u) throw new Error('no TG user');
  const id=String(u.id);
  state.users[id] ||= {id, firstName:u.first_name||'User', lastName:u.last_name||'', username:u.username||('user'+id), diamonds:300, isPremium:!!u.is_premium};
  state.current=id;
  state.social.following[id] ||= new Set();
  state.social.followers[id] ||= new Set();
}

/* ---- helpers ---- */
const avatar=(u)=> (u.firstName||u.username||'U').slice(0,1).toUpperCase();
const nameOf=(u)=> u.firstName && u.lastName ? `${u.firstName} ${u.lastName}` : (u.firstName || '@'+u.username);
function toast(msg,kind='ok'){ const t=document.createElement('div'); t.className=`t ${kind==='err'?'err':kind==='info'?'info':'ok'}`; t.textContent=msg; byId('toast').appendChild(t); setTimeout(()=>t.remove(),2600); }
function show(el){ el.style.display='flex'; } function hide(el){ el.style.display='none'; }
function go(id){ document.querySelectorAll('.nav button').forEach(b=> b.classList.toggle('active', b.dataset.go===id)); document.querySelectorAll('.section').forEach(s=> s.classList.toggle('active', s.id===id)); }

/* ---- economy ---- */
function spend(uid,amt){ const u=state.users[uid]; if(!u||u.diamonds<amt) return false; u.diamonds-=amt; state.pool.amt+=amt; return true; }
function publish(uid,text){ const p={id:String(Date.now()+Math.random()), authorId:uid, text, createdAt:new Date(), views:0, likes:0, boostedAt:null}; state.posts.unshift(p); return p; }

/* ---- actions ---- */
function createPostFlow(){
  const txt=byId('post-txt').value.trim();
  if(!txt){ toast('Введите текст','err'); return; }
  if(/https?:\/\//i.test(txt)){ toast('Ссылки запрещены в MVP','err'); return; }
  if(txt.length>500){ toast('Слишком длинно','err'); return; }
  if(!spend(state.current, ECON.COST_POST)){ toast('Недостаточно алмазов','err'); go('store-section'); return; }
  const p=publish(state.current,txt); save();
  hide(byId('m-create')); byId('post-txt').value=''; renderAll(); RT.send('post:new',{post:serPost(p)}); toast('Пост опубликован!');
}
function like(postId){
  const p=state.posts.find(x=>x.id===postId); if(!p) return;
  if(p.authorId===state.current) return; // нельзя лайкать своё
  p.likes++; p.views++; save(); renderFeed(); RT.send('post:stats',{id:p.id, likes:p.likes, views:p.views});
}

/* ---- pin/boost ---- */
let currentPostId=null;
function openBoost(id){ currentPostId=id; const p=state.posts.find(x=>x.id===id); const left=p?.boostedAt?(p.boostedAt.getTime()+ECON.BOOST_CD - Date.now()):0; byId('boost-hint').textContent=left>0?`Доступно через ${fmt(left)}`:''; show(byId('m-boost')); }
function doBoost(){ const p=state.posts.find(x=>x.id===currentPostId); if(!p) return; if(p.authorId!==state.current){ toast('Только автор','err'); return; }
  const left=p.boostedAt?(p.boostedAt.getTime()+ECON.BOOST_CD - Date.now()):0; if(left>0){ toast('Кулдаун 5 минут','err'); return; }
  if(!spend(state.current, ECON.COST_BOOST)){ toast('Нет алмазов','err'); go('store-section'); hide(byId('m-boost')); return; }
  p.boostedAt=new Date(); save(); hide(byId('m-boost')); renderAll(); RT.send('post:boost',{id:p.id, boostedAt:p.boostedAt.toISOString()}); toast('Пост поднят');
}
function openPin(id){ currentPostId=id; show(byId('m-pin')); }
function doPin(){
  const id=currentPostId; const p=state.posts.find(x=>x.id===id); if(!p) return; if(p.authorId!==state.current){ toast('Только автор','err'); return; }
  if(!spend(state.current, ECON.COST_PIN)){ toast('Нет алмазов','err'); go('store-section'); hide(byId('m-pin')); return; }
  const plus=60*1000;
  if(state.pin.active && state.pin.active.postId===id){ state.pin.active.endsAt=new Date(state.pin.active.endsAt.getTime()+plus); }
  else if(!state.pin.active){ state.pin.active={postId:id, endsAt:new Date(Date.now()+plus)}; }
  else { state.pin.queue.push({postId:id, userId:state.current, minutes:1, at:new Date()}); }
  save(); hide(byId('m-pin')); renderAll(); RT.send('pin:update', serPin()); toast('Закреплено');
}
function serPin(){ return {active: state.pin.active? {postId:state.pin.active.postId, endsAt:state.pin.active.endsAt.toISOString()}:null,
                           queue: state.pin.queue.map(q=>({...q, at:q.at.toISOString()}))}; }
function pinTick(){
  if(!state.pin.active) return;
  const left=state.pin.active.endsAt.getTime()-Date.now();
  if(left<=0){
    const next=state.pin.queue.shift();
    if(next){ state.pin.active={postId:next.postId, endsAt:new Date(Date.now()+next.minutes*60*1000)}; }
    else state.pin.active=null;
    save(); renderAll(); RT.send('pin:update', serPin());
  }
}

/* ---- render ---- */
function renderHUD(){
  const u=state.users[state.current]; byId('bal').textContent=(u?.diamonds||0);
  const left=state.pool.epochEnds.getTime()-Date.now();
  byId('eta').textContent=fmt(left);
  byId('prog').style.width=`${Math.max(0, Math.min(1, 1-(left/(24*3600*1000))))*100}%`;

  // профиль
  if(u){ byId('pf-ava').textContent=avatar(u); byId('pf-name').textContent=nameOf(u); byId('pf-id').textContent='ID: '+u.id; byId('pf-d').textContent=u.diamonds; }
  const myPosts=state.posts.filter(p=>p.authorId===state.current).length; byId('pf-p').textContent=myPosts;
  byId('pool-amt').textContent=state.pool.amt.toFixed(2);
}
function escapeHtml(s){return s.replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function renderFeed(){
  const feed=byId('feed'); const uid=state.current;
  const items=[...state.posts].sort((a,b)=> (b.boostedAt?b.boostedAt.getTime():0) - (a.boostedAt?a.boostedAt.getTime():0) || b.createdAt.getTime()-a.createdAt.getTime());
  const following=state.social.following[uid]||new Set();
  const filterFriends = byId('tab-friends').dataset.active==='1';
  const list = filterFriends? items.filter(p=> p.authorId===uid || following.has(p.authorId)) : items;

  feed.innerHTML = list.map(p=>{
    const a=state.users[p.authorId]||{firstName:'User'}; const mine=p.authorId===uid;
    const online = (Date.now()-(state.presence?.[p.authorId]||0) < 30000);
    return `
    <article class="card" data-id="${p.id}">
      <div class="row">
        <div class="user">
          <div class="avatar">${avatar(a)}${online?'<span class="dot online"></span>':''}</div>
          <div>
            <div class="name">${nameOf(a)} ${a.isPremium?'<i class="fa-solid fa-star" style="color:var(--ok)"></i>':''} ${mine?'<span class="muted">(Вы)</span>':''}</div>
            <div class="meta">${p.createdAt.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})} ${p.boostedAt? ' • <span class="badge rocket"><i class="fa-solid fa-rocket"></i> Boost</span>':''}</div>
          </div>
        </div>
        <div><button class="btn" onclick="openPin('${p.id}')" ${!mine?'disabled':''}><i class="fa-solid fa-thumbtack"></i></button></div>
      </div>
      <div class="content">${escapeHtml(p.text)}</div>
      <div class="stats"><span><i class="fa-regular fa-eye"></i> ${p.views}</span><span><i class="fa-regular fa-heart"></i> ${p.likes}</span></div>
      <div class="actions">
        <button class="btn like" ${mine?'disabled':''} onclick="like('${p.id}')"><i class="fa-regular fa-heart"></i> Лайк</button>
        <button class="btn" ${!mine?'disabled':''} onclick="openBoost('${p.id}')"><i class="fa-solid fa-rocket"></i> Буст</button>
        <button class="btn" ${mine?'disabled':''} onclick="follow('${uid}','${p.authorId}')"><i class="fa-solid fa-user-plus"></i> Др</button>
      </div>
    </article>`;
  }).join('');

  byId('feed-empty').style.display = list.length? 'none':'block';
  renderPin();
}
function renderPin(){
  const w=byId('pin-wrap'); if(!state.pin.active){ w.style.display='none'; return; }
  const p=state.posts.find(x=>x.id===state.pin.active.postId); if(!p){ w.style.display='none'; return; }
  const a=state.users[p.authorId]||{firstName:'User'};
  w.style.display='block';
  byId('pin-author').textContent=nameOf(a); byId('pin-text').textContent=p.text;
  byId('pin-views').textContent=p.views; byId('pin-likes').textContent=p.likes;
  byId('pin-left').textContent=fmt(state.pin.active.endsAt.getTime()-Date.now());
  byId('pin-cta').innerHTML = p.authorId===state.current ? `<button class="btn" onclick="openPin('${p.id}')"><i class="fa-solid fa-plus"></i> Продлить</button>` : '';
}
function renderFriends(){
  const uid=state.current;
  const flw=[...(state.social.following[uid]||new Set())].map(id=> (state.users[id]?nameOf(state.users[id]):id) + ` <a href="#" onclick="unfollow('${uid}','${id}');return false">(удалить)</a>`).join('<br/>') || '—';
  const fol=[...(state.social.followers[uid]||new Set())].map(id=> state.users[id]?nameOf(state.users[id]):id).join('<br/>') || '—';
  byId('following').innerHTML=flw; byId('followers').innerHTML=fol;
}
function renderAll(){ renderHUD(); renderFeed(); renderFriends(); }

/* ---- friends ---- */
function follow(me,to){
  if(me===to) return false;
  state.social.following[me] ||= new Set();
  state.social.followers[to]  ||= new Set();
  if(state.social.following[me].has(to)) return false;
  state.social.following[me].add(to); state.social.followers[to].add(me);
  save(); renderFriends(); toast('Добавлен в друзья'); RT.send('social:follow',{from:me,to});
}
function unfollow(me,to){
  if(!state.social.following[me]?.has(to)) return false;
  state.social.following[me].delete(to); state.social.followers[to]?.delete(me);
  save(); renderFriends(); toast('Удалён из друзей','info'); RT.send('social:unfollow',{from:me,to});
}

/* ---- serialize ---- */
function serPost(p){ return {...p, createdAt:p.createdAt.toISOString(), boostedAt:p.boostedAt? p.boostedAt.toISOString():null}; }
function dePost(p){ return {...p, createdAt:new Date(p.createdAt), boostedAt:p.boostedAt? new Date(p.boostedAt):null}; }

/* ---- presence (минимально) ---- */
state.presence={};
setInterval(()=>{ const uid=state.current; state.presence[uid]=Date.now(); RT.send('presence:ping',{uid}); }, 5000);

/* ---- events bus ---- */
RT.on(evt=>{
  if(!evt||!evt.type) return;
  switch(evt.type){
    case 'post:new':{
      const p=dePost(evt.payload.post); state.users[p.authorId] ||= {id:p.authorId, firstName:'User '+p.authorId, username:'user'+p.authorId, diamonds:0};
      if(!state.posts.find(x=>x.id===p.id)){ state.posts.unshift(p); save(); renderFeed(); }
      break;
    }
    case 'post:stats':{
      const {id,likes,views}=evt.payload; const p=state.posts.find(x=>x.id===id); if(p){ p.likes=Math.max(p.likes,likes); p.views=Math.max(p.views,views); save(); renderFeed(); }
      break;
    }
    case 'post:boost':{
      const {id,boostedAt}=evt.payload; const p=state.posts.find(x=>x.id===id); if(p){ p.boostedAt=new Date(boostedAt); save(); renderFeed(); }
      break;
    }
    case 'pin:update':{
      const d=evt.payload; state.pin.active=d.active? {postId:d.active.postId, endsAt:new Date(d.active.endsAt)}:null; state.pin.queue=[]; save(); renderPin(); break;
    }
    case 'social:follow':{
      const {from,to}=evt.payload; state.social.followers[to] ||= new Set(); state.social.followers[to].add(from); renderFriends(); break;
    }
    case 'social:unfollow':{
      const {from,to}=evt.payload; state.social.followers[to]?.delete(from); renderFriends(); break;
    }
    case 'presence:ping':{
      const {uid}=evt.payload; state.presence[uid]=Date.now(); break;
    }
  }
});

/* ---- UI wiring ---- */
document.addEventListener('click',e=>{
  if(e.target.closest('[data-close]')){ e.target.closest('.modal').style.display='none'; }
  const nav=e.target.closest('.nav button'); if(nav&&nav.dataset.go){ go(nav.dataset.go); }
  const pack=e.target.closest('#store-section [data-pack]'); if(pack){ const amt=parseInt(pack.dataset.pack,10); state.users[state.current].diamonds+=amt; save(); renderHUD(); toast(`Куплено ${amt} 💎`,'ok'); }
});
byId('fab').onclick=()=> show(byId('m-create'));
byId('post-send').onclick=createPostFlow;
byId('boost-do').onclick=doBoost;
byId('pin-do').onclick=doPin;
byId('tab-all').onclick=()=>{ byId('tab-all').style.boxShadow='var(--ring)'; byId('tab-friends').style.boxShadow='none'; delete byId('tab-friends').dataset.active; renderFeed(); };
byId('tab-friends').onclick=()=>{ byId('tab-friends').style.boxShadow='var(--ring)'; byId('tab-friends').dataset.active='1'; byId('tab-all').style.boxShadow='none'; renderFeed(); };
byId('friend-add').onclick=()=>{
  const v=byId('friend-input').value.trim(); if(!v) return; const me=state.current;
  let id=v.startsWith('@')? v.slice(1): v;
  state.users[id] ||= {id, firstName: v.startsWith('@')?('@'+id):('User '+id), username:id, diamonds:0};
  follow(me,id); byId('friend-input').value='';
};
byId('to-friends').onclick=()=> go('friends-section'); byId('to-store').onclick=()=> go('store-section');

/* ---- tickers ---- */
setInterval(()=>{ renderHUD(); pinTick(); renderPin(); if(Date.now()>state.pool.epochEnds.getTime()){ state.pool.epochEnds=epochEnd(); state.pool.amt=0; save(); }}, 1000);

/* ---- boot ---- */
try{ if(!load()) initUser(); else initUser(); }catch(e){ console.error(e); }
renderAll();

} // end if !__STOP_APP__
</script>
</body>
</html>
