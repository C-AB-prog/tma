<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Diamond Feed • TMA</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<style>
:root{
  --bg:#0b0f18;--surface:#0f1422;--card:#151b2e;--muted:#9aa3b5;--text:#f4f7ff;
  --brand:#7da9ff;--brand-2:#a67aff;--ok:#44d6a3;--err:#ff7f88;
  --radius:16px;--shadow:0 16px 56px rgba(0,0,0,.4);--ring:0 0 0 2px rgba(125,169,255,.45);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 520px at 15% -10%, rgba(125,169,255,.16), transparent 55%),
    radial-gradient(900px 420px at 105% -15%, rgba(166,122,255,.14), transparent 60%),
    linear-gradient(180deg,#0b0f18,#0a0d16 50%,#0b0f18);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Inter,Roboto,Segoe UI,Arial,sans-serif;
}
.container{max-width:760px;margin:0 auto;padding:0 14px calc(88px + env(safe-area-inset-bottom))}
.topbar{position:sticky;top:0;z-index:70;backdrop-filter:saturate(1.2) blur(12px);
  background:linear-gradient(to bottom, rgba(11,15,24,.92), rgba(11,15,24,.55));
  border-bottom:1px solid rgba(255,255,255,.06)}
.topbar-row{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:34px;height:34px;border-radius:12px;display:grid;place-items:center;
  background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 150deg, var(--brand) 360deg);
  box-shadow:0 14px 32px rgba(125,169,255,.45)}
.logo i{color:#fff}
.title{font-weight:900}
.head-kpis{display:flex;gap:8px}
.pill{display:flex;gap:8px;align-items:center;padding:8px 12px;border-radius:12px;
  border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
  font-size:12px;font-weight:900}
.pill i{opacity:.95}
.meta-line{padding:0 14px 10px;color:var(--muted);font-size:12px}
.meta-line .chip{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:12px;
  border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05)}
.progress{height:3px;background:rgba(255,255,255,.08)} .progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand-2));transition:width .4s}
.section{display:none;animation:.25s fade ease} .section.active{display:block}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.card{background:linear-gradient(180deg,#151b2e,#141a2a);border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);padding:14px;margin:12px 0;box-shadow:var(--shadow)}
.row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.user{display:flex;gap:10px;align-items:center}
.avatar{position:relative;width:42px;height:42px;border-radius:50%;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,var(--brand),var(--brand-2))}
.dot{position:absolute;right:-2px;bottom:-2px;width:12px;height:12px;border-radius:50%;border:2px solid var(--card)}
.dot.online{background:var(--ok)}
.name{font-weight:900}.muted{color:var(--muted)} .meta{color:var(--muted);font-size:12px;margin-top:2px}
.content{margin:10px 0 8px;line-height:1.6;font-size:15px}
.stats{display:flex;gap:14px;color:var(--muted);font-size:12px}
.actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
.btn{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);font-weight:900;cursor:pointer}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.badge{display:inline-flex;gap:6px;align-items:center;padding:5px 9px;border-radius:10px;border:1px solid rgba(255,255,255,.13);font-size:11px}
.badge.rocket{color:var(--ok);border-color:rgba(68,214,163,.4);background:linear-gradient(180deg, rgba(68,214,163,.18), rgba(255,255,255,.02))}
.empty{padding:44px 18px;text-align:center;color:var(--muted)}
.pinned{margin:12px 0;border-radius:18px;display:none}
.pinned .card{background:linear-gradient(180deg, rgba(125,169,255,.12), rgba(125,169,255,.03));border:1px solid rgba(255,255,255,.1)}
.pinned .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.14)}
.pinned .body{padding:12px}
.pin-meta{display:flex;gap:12px;color:var(--muted);font-size:12px;margin-top:6px}
.nav{position:fixed;left:0;right:0;bottom:0;z-index:90;
  backdrop-filter:blur(12px);background:linear-gradient(to top, rgba(11,15,24,.92), rgba(11,15,24,.55));
  border-top:1px solid rgba(255,255,255,.08);padding:10px 8px calc(10px + env(safe-area-inset-bottom));
  display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.nav button{border:none;background:none;color:var(--muted);display:flex;flex-direction:column;gap:4px;align-items:center;padding:8px 6px;border-radius:10px;font-size:11px}
.nav button.active{color:var(--brand);background:rgba(125,169,255,.16)}
.fab{position:fixed;right:14px;bottom:calc(84px + env(safe-area-inset-bottom));width:58px;height:58px;border-radius:50%;
  display:grid;place-items:center;border:none;cursor:pointer;color:white;z-index:120;
  background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 160deg, var(--brand) 360deg);
  box-shadow:0 22px 62px rgba(125,169,255,.6)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.62);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:150}
.modal__card{width:min(92vw,460px);max-height:84vh;overflow:auto;border-radius:18px;border:1px solid rgba(255,255,255,.09);background:var(--card);padding:18px}
.modal__head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.modal__title{font-weight:900}.close{border:none;background:none;color:var(--muted);font-size:20px;cursor:pointer}
.label{font-size:13px;color:var(--muted);margin:6px 0}
.input,.textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.09);background:#0f1426;color:var(--text)}
.textarea{min-height:120px;resize:vertical}
.submit{width:100%;margin-top:10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);
  border-radius:14px;padding:14px;text-align:center}
.stat .v{font-size:18px;font-weight:900}
.prof{display:flex;gap:12px;align-items:center}
.prof-ava{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,var(--brand),var(--brand-2))}
.prof-name{font-size:18px;font-weight:900}
.section-title{font-weight:900;margin:8px 0 6px}
.toast{position:fixed;right:14px;top:78px;z-index:160;display:grid;gap:8px}
.toast .t{padding:11px 13px;border-radius:12px;color:#0b0b0f;font-weight:900}
.t.ok{background:#44d6a3}.t.err{background:#ff7f88}.t.info{background:#7da9ff}
</style>
</head>
<body>

<!-- Telegram-only gate -->
<script>
(function gate(){
  const tg=window.Telegram?.WebApp; let BOT='t11stMini_bot'; if(BOT.startsWith('@')) BOT=BOT.slice(1);
  if(!tg || !tg.initDataUnsafe?.user){
    const link=`https://t.me/${BOT}?startapp=${encodeURIComponent('chan=tma')}`;
    document.body.innerHTML = `
      <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0f18;color:#f4f7ff;padding:24px;text-align:center">
        <div style="max-width:520px;background:#151b2e;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:22px">
          <div style="font-size:20px;font-weight:900;margin-bottom:6px">Откройте через Telegram</div>
          <div style="color:#9aa3b5;margin-bottom:12px">Это мини-приложение доступно только внутри Telegram.</div>
          <a href="${link}" style="display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg,#7da9ff,#a67aff);color:white;font-weight:900;text-decoration:none">Открыть в Telegram</a>
          <div style="color:#9aa3b5;font-size:12px;margin-top:8px">t.me/${BOT}</div>
        </div>
      </div>`;
    window.__STOP_APP__=true; return;
  }
  window.__STOP_APP__=false;
  try{ tg.ready(); tg.expand(); tg.disableVerticalSwipes?.(); }catch(e){}
})();
</script>

<div class="toast" id="toast"></div>

<header class="topbar">
  <div class="topbar-row container">
    <div class="brand">
      <div class="logo"><i class="fa-solid fa-gem"></i></div>
      <div class="title">Diamond Feed</div>
    </div>
    <div class="head-kpis">
      <div class="pill"><i class="fa-solid fa-gem"></i><span id="bal">0</span></div>
      <div class="pill"><i class="fa-solid fa-star"></i><span id="pts">0</span></div>
      <div class="pill"><i class="fa-solid fa-coins"></i><span id="pool-pill">0</span></div>
    </div>
  </div>
  <div class="meta-line container"><span class="chip"><i class="fa-regular fa-clock"></i> до 24:00 UTC: <b id="eta">--:--:--</b></span></div>
  <div class="progress"><span id="prog"></span></div>
</header>

<main class="container">
  <!-- PIN -->
  <section class="pinned" id="pin-wrap">
    <div class="card">
      <div class="head">
        <div class="pill" style="color:var(--brand)"><i class="fa-solid fa-thumbtack"></i> Закреплено • <span id="pin-author">—</span></div>
        <div class="pill"><i class="fa-regular fa-clock"></i> <span id="pin-left">01:00</span></div>
      </div>
      <div class="body">
        <div class="content" id="pin-text"></div>
        <div class="pin-meta">
          <span><i class="fa-regular fa-eye"></i> <span id="pin-views">0</span></span>
          <span><i class="fa-regular fa-heart"></i> <span id="pin-likes">0</span></span>
        </div>
        <div id="pin-cta" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <!-- FEED -->
  <section id="feed-section" class="section active">
    <div style="display:flex;gap:8px;margin:8px 0 4px">
      <button class="pill" id="tab-friends"><i class="fa-solid fa-user-group"></i> Друзья</button>
      <button class="pill" id="tab-all" style="box-shadow:var(--ring)"><i class="fa-solid fa-globe"></i> Все</button>
    </div>
    <div id="feed"></div>
    <div id="feed-empty" class="empty" style="display:none"><i class="fa-regular fa-newspaper" style="font-size:40px"></i><div>Лента пуста. Нажмите «+».</div></div>
  </section>

  <!-- PROFILE -->
  <section id="profile-section" class="section">
    <div class="card">
      <div class="prof">
        <div class="prof-ava" id="pf-ava">U</div>
        <div>
          <div class="prof-name" id="pf-name">Пользователь</div>
          <div class="meta" id="pf-id">ID: —</div>
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div class="stat"><div class="v" id="pf-d">0</div><div class="muted">Алмазов</div></div>
        <div class="stat"><div class="v" id="pf-p">0</div><div class="muted">Постов</div></div>
        <div class="stat"><div class="v" id="pf-rd">0</div><div class="muted">Прочтений</div></div>
        <div class="stat"><div class="v" id="pf-rc">0</div><div class="muted">Реакций</div></div>
        <div class="stat"><div class="v" id="pf-pts">0</div><div class="muted">Баллов</div></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="to-friends"><i class="fa-solid fa-user-group"></i> Друзья</button>
        <button class="btn" id="to-store"><i class="fa-solid fa-store"></i> Магазин</button>
      </div>
    </div>
  </section>

  <!-- FRIENDS -->
  <section id="friends-section" class="section">
    <div class="section-title">Друзья</div>
    <div class="card">
      <div class="label">Добавить по User ID или @username</div>
      <div style="display:flex;gap:8px">
        <input id="friend-input" class="input" placeholder="@username или 123456"/>
        <button class="btn" id="friend-add"><i class="fa-solid fa-user-plus"></i> Добавить</button>
      </div>
    </div>
    <div class="grid">
      <div class="card"><div class="section-title">Вы подписаны</div><div id="following" class="muted">—</div></div>
      <div class="card"><div class="section-title">Подписчики</div><div id="followers" class="muted">—</div></div>
    </div>
  </section>

  <!-- STORE -->
  <section id="store-section" class="section">
    <div class="section-title">Магазин алмазов</div>
    <div class="card">
      <div class="grid" style="margin-top:8px">
        <button class="btn" data-pack="100">100 💎</button>
        <button class="btn" data-pack="500">500 💎</button>
        <button class="btn" data-pack="1000">1000 💎</button>
        <button class="btn" data-pack="5000">5000 💎</button>
      </div>
      <div class="meta" style="margin-top:8px">Демо-оплата: зачисляется сразу</div>
    </div>
  </section>

  <!-- POOL -->
  <section id="pool-section" class="section">
    <div class="section-title">Пул наград</div>
    <div class="card"><div class="name">Текущий пул: <b id="pool-amt">0</b> 💎</div></div>
  </section>
</main>

<nav class="nav">
  <button class="active" data-go="feed-section"><i class="fa-solid fa-home"></i><span>Лента</span></button>
  <button data-go="profile-section"><i class="fa-solid fa-user"></i><span>Профиль</span></button>
  <button data-go="friends-section"><i class="fa-solid fa-user-group"></i><span>Друзья</span></button>
  <button data-go="store-section"><i class="fa-solid fa-store"></i><span>Магазин</span></button>
  <button data-go="pool-section"><i class="fa-solid fa-coins"></i><span>Пул</span></button>
</nav>

<button class="fab" id="fab"><i class="fa-solid fa-plus"></i></button>

<!-- Modals -->
<div class="modal" id="m-create"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">Создать пост</div><button class="close" data-close>&times;</button></div>
  <label class="label">Текст (до 500 символов, без ссылок)</label>
  <textarea id="post-txt" class="textarea" maxlength="500" placeholder="Поделитесь чем-то интересным…"></textarea>
  <button id="post-send" class="btn submit">Опубликовать за 10 💎</button>
</div></div>

<div class="modal" id="m-boost"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">Буст поста</div><button class="close" data-close>&times;</button></div>
  <div class="label">Поднять пост в топ за 10 💎? (кулдаун 5 минут)</div>
  <button id="boost-do" class="btn submit">Поднять за 10 💎</button>
  <div class="meta" id="boost-hint"></div>
</div></div>

<div class="modal" id="m-pin"><div class="modal__card">
  <div class="modal__head"><div class="modal__title">Закрепить пост</div><button class="close" data-close>&times;</button></div>
  <div class="label">1 минута закрепа = 100 💎. Если занято — продлит ваш же закреп.</div>
  <button id="pin-do" class="btn submit">Закрепить за 100 💎</button>
</div></div>

<script>
if(!window.__STOP_APP__){

/* ========== 0) Тема из Telegram ========== */
(function(){
  try{
    const tp = Telegram?.WebApp?.themeParams || {};
    const set=(k,v)=> v && document.documentElement.style.setProperty(k,v);
    if(tp.text_color) set('--text',tp.text_color);
    if(tp.bg_color)   set('--bg',tp.bg_color);
    if(tp.secondary_bg_color){ set('--surface',tp.secondary_bg_color); set('--card',tp.secondary_bg_color); }
    if(tp.button_color) set('--brand',tp.button_color);
    if(tp.hint_color)   set('--muted',tp.hint_color);
  }catch(e){}
})();

/* ========== 1) Утилиты ========== */
const epochEnd=()=> new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate()+1,0,0,0));
const epochIdUTC=(d)=>{ const y=d.getUTCFullYear(); const m=String(d.getUTCMonth()+1).padStart(2,'0'); const day=String(d.getUTCDate()).padStart(2,'0'); return `${y}-${m}-${day}`; };
const fmt=(ms)=>{ if(!Number.isFinite(ms)) ms=0; if(ms<0) ms=0; const s=(ms/1000)|0; const h=String((s/3600)|0).padStart(2,'0'); const m=String(((s%3600)/60)|0).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}` };
const byId=(id)=>document.getElementById(id);
const esc = (s) => String(s ?? '').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const toTime = (d) => { if(!d) return 0; if(d instanceof Date && Number.isFinite(d.getTime())) return d.getTime(); const t=Date.parse(d); return Number.isFinite(t)?t:0; };
function toast(message, kind='ok'){ const t=document.createElement('div'); t.className=`t ${kind==='err'?'err':kind==='info'?'info':'ok'}`; t.textContent=message; byId('toast').appendChild(t); setTimeout(()=>t.remove(),2600); }
function show(el){ el.style.display='flex'; } function hide(el){ el.style.display='none'; }
function go(id){ document.querySelectorAll('.nav button').forEach(b=> b.classList.toggle('active', b.dataset.go===id)); document.querySelectorAll('.section').forEach(s=> s.classList.toggle('active', s.id===id)); }

/* CloudStorage helpers */
const CS = Telegram?.WebApp?.CloudStorage;
const cloud = {
  avail: !!CS,
  get: (k) => new Promise(res=> CS?.getItem(k,(e,v)=> res(e?null:v))),
  set: (k,v) => new Promise((res,rej)=> CS?.setItem(k,v,(e)=> e?rej(e):res())),
  mget: (keys) => new Promise(res=> CS?.getItems(keys,(e,items)=> res(e?{}:items || {}))),
  keys: () => new Promise(res=> CS?.getKeys((e,ks)=> res(e?[]:ks || []))),
};

/* ========== 2) Realtime (Ably): публикуем только в tma, читаем tma + legacy ========== */
const RT=(()=>{
  const listeners=new Set();
  const qs = new URLSearchParams(location.search);
  const startParam = Telegram?.WebApp?.initDataUnsafe?.start_param || '';
  let spChan=null; try{ const sp=new URLSearchParams(startParam.includes('=')?startParam:`chan=${startParam}`); spChan=(sp.get('chan')||'').trim(); }catch(_){}
  const KEY='E9rkjQ.VFe0Fg:BHe2MLdpKyWGye0G7gZ1lAMruelNAmTxep63oVw2uoY'; // <-- свой ключ
  const MAIN='tma';
  const legacy=(qs.get('chan')||spChan||'').trim();
  const CHANNELS=Array.from(new Set([MAIN,legacy].filter(Boolean)));
  let ab=null, pubCh=null;

  const ready=(async()=>{
    try{
      ab=new Ably.Realtime.Promise(KEY);
      pubCh=ab.channels.get(MAIN);
      for(const name of CHANNELS){
        const ch=ab.channels.get(name);
        try{
          const page=await ch.history({limit:300});
          const items=page?.items||[];
          for(let i=items.length-1;i>=0;i--){
            const m=items[i];
            const data = m.data && m.data.type ? m.data : { type:m.name, payload:m.data, ts:Date.parse(m.timestamp)||Date.now() };
            listeners.forEach(fn=> fn(data,true));
          }
        }catch(e){}
        ch.subscribe((msg)=>{
          const data = msg.data && msg.data.type ? msg.data : { type:msg.name, payload:msg.data, ts:Date.now() };
          listeners.forEach(fn=> fn(data,false));
        });
      }
    }catch(e){ toast('Ably не подключился','err'); }
  })();

  return {
    ready,
    send:(type,payload)=>{ const msg={type,payload,ts:Date.now()}; try{ pubCh && pubCh.publish(type,msg); }catch(e){}; },
    on:(fn)=> listeners.add(fn)
  };
})();

/* ========== 3) Состояние (LS + CloudStorage) ========== */
let state={
  users:{}, current:null,
  posts:[],
  pool:{ amt:0, epochEnds:epochEnd(), settledId:null },
  pin:{ active:null },
  social:{ following:{}, followers:{} },
  presence:{},
  viewsByUser:{},    // {uid: {postId:true}}
  likesByUser:{},    // {uid: {postId:true}}
  epochPoints:{}     // {uid:number} — баллы за текущую эпоху
};

const LS_MAIN='diamond-feed';
const LS_LEGACY=['df-v22','df-v21','df-v20'];

function revive(o){ if(!o||typeof o!=='object') return o; if(o.__d) return new Date(o.__d); if(Array.isArray(o)){ for(let i=0;i<o.length;i++) o[i]=revive(o[i]); return o; } for(const k in o) o[k]=revive(o[k]); return o; }
function saveLS(){
  try{
    const json = JSON.stringify(state,(k,v)=> v instanceof Date? {__d:v.toISOString()} : v);
    localStorage.setItem(LS_MAIN, json);
  }catch(_){}
}
function loadLS(){
  try{
    let raw = localStorage.getItem(LS_MAIN);
    if(!raw){ for(const k of LS_LEGACY){ raw=localStorage.getItem(k); if(raw){ localStorage.setItem(LS_MAIN,raw); break; } } }
    if(!raw) return false;
    const data=revive(JSON.parse(raw));
    data.users ||= {}; data.posts ||= []; data.pool ||= {}; data.pin ||= {}; data.social ||= {following:{},followers:{}};
    data.viewsByUser ||= {}; data.likesByUser ||= {}; data.epochPoints ||= {};
    if(!(data.pool.epochEnds instanceof Date) || !Number.isFinite(data.pool.epochEnds.getTime())) data.pool.epochEnds=epochEnd();
    if(typeof data.pool.amt!=='number') data.pool.amt=0;
    state=data; return true;
  }catch(e){ return false; }
}
async function load(){
  loadLS();
  if(cloud.avail){
    try{
      const keys = await cloud.keys();
      const need=[];
      if(keys.includes('df:pool')) need.push('df:pool');
      if(keys.includes('df:pin'))  need.push('df:pin');
      const got = need.length ? await cloud.mget(need) : {};
      if(got['df:pool']){
        const p = JSON.parse(got['df:pool']);
        state.pool.amt = +p.amt || 0;
        state.pool.epochEnds = new Date(p.epochEnds||epochEnd());
        state.pool.settledId = p.settledId || null;
      }
      if(got['df:pin']){
        const d = JSON.parse(got['df:pin']);
        state.pin.active = d?.active ? { postId:d.active.postId, endsAt:new Date(d.active.endsAt) } : null;
      }
    }catch(_){}
  }
  state.users ||= {}; state.posts ||= []; state.social ||= {following:{},followers:{}};
  state.viewsByUser ||= {}; state.likesByUser ||= {}; state.epochPoints ||= {};
  if(!(state.pool.epochEnds instanceof Date) || !Number.isFinite(state.pool.epochEnds.getTime())) state.pool.epochEnds=epochEnd();
  return true;
}
function save(){
  saveLS();
  if(!cloud.avail) return;
  const uid = state.current;
  try{
    if(uid && state.users[uid]) cloud.set(`df:user:${uid}`, JSON.stringify(state.users[uid]));
    cloud.set(`df:pool`, JSON.stringify({ amt: state.pool.amt||0, epochEnds: state.pool.epochEnds.toISOString(), settledId: state.pool.settledId||null }));
    cloud.set(`df:pin`, JSON.stringify(serPin()));
  }catch(_){}
}

/* — персистим engagement текущего юзера между устройствами (с лимитами) — */
function persistUserEngagement(){
  if(!cloud.avail) return;
  const uid=state.current; if(!uid) return;
  try{
    const likedKeys = Object.keys(state.likesByUser[uid]||{}).slice(-500);
    cloud.set(`df:liked:${uid}`, JSON.stringify(likedKeys));
    const eid = epochIdUTC(new Date());
    const viewedKeys = Object.keys(state.viewsByUser[uid]||{}).slice(-1000);
    cloud.set(`df:viewed:${uid}:${eid}`, JSON.stringify(viewedKeys));
  }catch(_){}
}
async function loadUserEngagement(uid){
  if(!cloud.avail) return;
  const eid = epochIdUTC(new Date());
  try{
    const got = await cloud.mget([`df:liked:${uid}`, `df:viewed:${uid}:${eid}`]);
    const liked = JSON.parse(got[`df:liked:${uid}`] || '[]');
    const viewed = JSON.parse(got[`df:viewed:${uid}:${eid}`] || '[]');
    state.likesByUser[uid] ||= {}; liked.forEach(id=> state.likesByUser[uid][id]=true);
    state.viewsByUser[uid] ||= {}; viewed.forEach(id=> state.viewsByUser[uid][id]=true);
  }catch(_){}
}

/* ========== 4) Пользователь ========== */
async function initUser(){
  const u=Telegram?.WebApp?.initDataUnsafe?.user;
  const id=String(u.id);

  if(!state.users[id]){
    state.users[id]={id, firstName:u.first_name||'User', lastName:u.last_name||'', username:u.username||('user'+id), diamonds:300, isPremium:!!u.is_premium, points:0};
  }else{
    state.users[id].points = Number(state.users[id].points||0);
  }
  if(cloud.avail){
    try{
      const raw = await cloud.get(`df:user:${id}`);
      if(raw){
        const fromCS = JSON.parse(raw);
        const cur = state.users[id]||{};
        const diamonds = Math.max(+cur.diamonds||0, +fromCS.diamonds||0);
        const points   = Math.max(+cur.points||0, +fromCS.points||0);
        state.users[id] = {...cur, ...fromCS, diamonds, points};
      }
    }catch(_){}
  }

  state.current=id;
  state.social.following[id] ||= [];
  state.social.followers[id] ||= [];
  state.viewsByUser[id] ||= {};
  state.likesByUser[id] ||= {};
  state.epochPoints[id] ||= 0;

  await loadUserEngagement(id); // подтянуть liked/viewed с другого девайса
}
const avatar=(u)=> (u.firstName||u.username||'U').slice(0,1).toUpperCase();
const nameOf=(u)=> u.firstName && u.lastName ? `${u.firstName} ${u.lastName}` : (u.firstName || '@'+u.username);

/* ========== 5) Экономика, баллы, посты ========== */
function spend(uid,amt){
  const u=state.users[uid];
  if(!u){ toast('Сессия не инициализирована. Откройте мини-апп из Telegram.', 'err'); return false; }
  if(u.diamonds < amt){ toast(`Недостаточно алмазов (${u.diamonds}/${amt})`, 'err'); return false; }
  u.diamonds-=amt; state.pool.amt=(state.pool.amt||0)+amt;
  save(); renderHUD();
  RT.send('pool:add',{amount:amt,from:uid});
  return true;
}
function award(uid,points){
  if(!uid||!Number.isFinite(points)||points<=0) return;
  state.users[uid].points = (state.users[uid].points||0) + points;
  state.epochPoints[uid]  = (state.epochPoints[uid]||0) + points;
  save(); renderHUD(); renderProfile();
  RT.send('points:add',{uid,points});
}
function publish(uid,text){
  const p={id:String(Date.now()+Math.random()), authorId:uid, text, createdAt:new Date(), likes:0, views:0, boostedAt:null};
  state.posts.unshift(p); save(); renderAll();
  RT.send('post:new',{post: serPost(p)});
  return p;
}

/* ========== 6) Действия ========== */
function createPostFlow(){
  const txt=byId('post-txt').value.trim();
  if(!txt){ toast('Введите текст','err'); return; }
  if(/https?:\/\//i.test(txt)){ toast('Ссылки запрещены в MVP','err'); return; }
  if(txt.length>500){ toast('Слишком длинно','err'); return; }
  if(!spend(state.current,10)) return;
  publish(state.current, txt);
  hide(byId('m-create')); byId('post-txt').value='';
  toast('Пост опубликован!');
}
function like(postId){
  const uid=state.current;
  state.likesByUser[uid] ||= {};
  if(state.likesByUser[uid][postId]){ toast('Вы уже лайкали этот пост','info'); return; }
  const p=state.posts.find(x=>x.id===postId); if(!p || p.authorId===uid) return;
  state.likesByUser[uid][postId]=true;
  p.likes++; p.views++; award(uid,2);
  save(); persistUserEngagement(); renderFeed();
  RT.send('post:stats',{id:p.id,likes:p.likes,views:p.views});
}
let currentPostId=null;
function openBoost(id){
  currentPostId=id; const p=state.posts.find(x=>x.id===id);
  const left=p?.boostedAt?(toTime(p.boostedAt)+5*60*1000 - Date.now()):0;
  byId('boost-hint').textContent=left>0?`Доступно через ${fmt(left)}`:'';
  show(byId('m-boost'));
}
function doBoost(){
  const p=state.posts.find(x=>x.id===currentPostId); if(!p) return;
  if(p.authorId!==state.current){ toast('Только автор','err'); return; }
  const left=p.boostedAt?(toTime(p.boostedAt)+5*60*1000 - Date.now()):0;
  if(left>0){ toast('Кулдаун 5 минут','err'); return; }
  if(!spend(state.current,10)){ hide(byId('m-boost')); return; }
  p.boostedAt=new Date(); save(); hide(byId('m-boost')); renderAll();
  RT.send('post:boost',{id:p.id,boostedAt:p.boostedAt.toISOString()});
  toast('Пост поднят');
}
function openPin(id){ currentPostId=id; show(byId('m-pin')); }
function doPin(){
  const p=state.posts.find(x=>x.id===currentPostId); if(!p) return;
  if(p.authorId!==state.current){ toast('Только автор','err'); return; }
  if(!spend(state.current,100)){ hide(byId('m-pin')); return; }
  const ends = Date.now()+60*1000;
  state.pin.active={postId:p.id, endsAt:new Date(ends)}; save(); renderPin();
  RT.send('pin:update', serPin()); hide(byId('m-pin'));
  toast('Закреплено на 1 минуту');
}

/* Просмотры: 1 раз в эпоху на пользователя */
function markViewed(postId){
  const uid=state.current; if(!uid) return;
  state.viewsByUser[uid] ||= {};
  if(state.viewsByUser[uid][postId]) return;
  const p=state.posts.find(x=>x.id===postId); if(!p) return;
  state.viewsByUser[uid][postId]=true;
  p.views++; award(uid,1);
  save(); persistUserEngagement(); renderFeed();
  RT.send('post:stats',{id:p.id,likes:p.likes,views:p.views});
}

/* ========== 7) Присутствие ========== */
setInterval(()=>{ const uid=state.current; state.presence[uid]=Date.now(); RT.send('presence:ping',{uid}); }, 5000);
function isOnline(uid){ const t=state.presence[uid]||0; return Date.now()-t<30000; }

/* ========== 8) Рендер ========== */
function renderHUD(){
  const u=state.users[state.current]||{};
  byId('bal').textContent=u.diamonds||0;
  byId('pts').textContent=u.points||0;
  const ends = state.pool?.epochEnds instanceof Date ? state.pool.epochEnds : epochEnd();
  const left=ends.getTime()-Date.now();
  byId('eta').textContent=fmt(left);
  byId('prog').style.width=`${Math.max(0,Math.min(1,1-(left/(24*3600*1000))))*100}%`;
  byId('pool-amt').textContent=(state.pool.amt||0).toFixed(2);
  byId('pool-pill').textContent=(state.pool.amt||0).toFixed(0);
  renderProfile();
}
function renderProfile(){
  const u=state.users[state.current]||{};
  byId('pf-ava').textContent=avatar(u);
  byId('pf-name').textContent=nameOf(u);
  byId('pf-id').textContent='ID: '+(u.id||'-');
  byId('pf-d').textContent=u.diamonds||0;
  byId('pf-p').textContent=state.posts.filter(p=>p.authorId===state.current).length;
  byId('pf-pts').textContent=u.points||0;
}
let feedObserver=null;
function renderFeed(){
  const feed=byId('feed'); const uid=state.current;

  try{
    const items=(Array.isArray(state.posts)? state.posts : [])
      .filter(p => p && p.id && p.authorId)
      .sort((a,b)=> (toTime(b.boostedAt) - toTime(a.boostedAt)) || (toTime(b.createdAt) - toTime(a.createdAt)));

    const friendsOn = byId('tab-friends').dataset.active==='1';
    const following = new Set(state.social?.following?.[uid] || []);
    const list = friendsOn ? items.filter(p=> p.authorId===uid || following.has(p.authorId)) : items;

    feed.innerHTML = list.map(p=>{
      const a=state.users[p.authorId] || {firstName:'User',username:''};
      const liked = !!(state.likesByUser[uid] && state.likesByUser[uid][p.id]);
      return `
        <article class="card post" data-id="${p.id}">
          <div class="row">
            <div class="user">
              <div class="avatar">${avatar(a)}${isOnline(p.authorId)?'<span class="dot online"></span>':''}</div>
              <div>
                <div class="name">${nameOf(a)} ${a.isPremium?'<i class="fa-solid fa-star" style="color:var(--ok)"></i>':''} ${p.authorId===uid?'<span class="muted">(Вы)</span>':''}</div>
                <div class="meta">${new Date(p.createdAt).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}
                  ${p.boostedAt? ' • <span class="badge rocket"><i class="fa-solid fa-rocket"></i> Boost</span>':''}
                </div>
              </div>
            </div>
            <div><button class="btn" onclick="openPin('${p.id}')" ${p.authorId!==uid?'disabled':''}><i class="fa-solid fa-thumbtack"></i></button></div>
          </div>
          <div class="content">${esc(p.text)}</div>
          <div class="stats"><span><i class="fa-regular fa-eye"></i> ${p.views||0}</span><span><i class="fa-regular fa-heart"></i> ${p.likes||0}</span></div>
          <div class="actions">
            <button class="btn" ${p.authorId===uid||liked?'disabled':''} onclick="like('${p.id}')"><i class="fa-regular fa-heart"></i> Лайк</button>
            <button class="btn" ${p.authorId!==uid?'disabled':''} onclick="openBoost('${p.id}')"><i class="fa-solid fa-rocket"></i> Буст</button>
            <button class="btn" ${p.authorId===uid?'disabled':''} onclick="follow('${uid}','${p.authorId}')"><i class="fa-solid fa-user-plus"></i> Др</button>
          </div>
        </article>`;
    }).join('');

    byId('feed-empty').style.display = list.length? 'none':'block';
    renderPin();

    if(feedObserver) feedObserver.disconnect();
    feedObserver = new IntersectionObserver((entries)=>{
      entries.forEach(en=>{
        if(en.isIntersecting && en.intersectionRatio>=0.5){
          const id = en.target.getAttribute('data-id');
          markViewed(id);
          feedObserver.unobserve(en.target);
        }
      });
    },{threshold:[0.5]});
    document.querySelectorAll('.post').forEach(el=> feedObserver.observe(el));
  }catch(err){
    console.error('renderFeed error', err, state.posts);
    toast('Ошибка отображения ленты', 'err');
  }
}
function renderPin(){
  const w=byId('pin-wrap');
  if(!state.pin.active){ w.style.display='none'; return; }
  const p=state.posts.find(x=>x.id===state.pin.active.postId);
  if(!p){
    state.pin.active=null; save(); RT.send('pin:update', serPin()); w.style.display='none'; return;
  }
  const a=state.users[p.authorId]||{firstName:'User'};
  w.style.display='block';
  byId('pin-author').textContent=nameOf(a); byId('pin-text').textContent=p.text;
  byId('pin-views').textContent=p.views||0; byId('pin-likes').textContent=p.likes||0;
  byId('pin-left').textContent=fmt((state.pin.active.endsAt instanceof Date?state.pin.active.endsAt:epochEnd()).getTime()-Date.now());
  byId('pin-cta').innerHTML = p.authorId===state.current ? `<button class="btn" onclick="openPin('${p.id}')"><i class="fa-solid fa-plus"></i> Продлить</button>` : '';
}
function renderFriends(){
  const uid=state.current;
  const followingIds = state.social.following[uid]||[];
  const followersIds = state.social.followers[uid]||[];
  const flw = followingIds.map(id=> (state.users[id]?nameOf(state.users[id]):('@'+id))).join('<br/>') || '—';
  const fol = followersIds.map(id=> state.users[id]?nameOf(state.users[id]):('@'+id)).join('<br/>') || '—';
  byId('following').innerHTML=flw; byId('followers').innerHTML=fol;
}
function renderAll(){ renderHUD(); renderFeed(); renderFriends(); }

/* ========== 9) Друзья ========== */
function follow(me,to){
  if(me===to) return false;
  state.social.following[me] ||= [];
  state.social.followers[to]  ||= [];
  if(state.social.following[me].includes(to)) return false;
  state.social.following[me].push(to); state.social.followers[to].push(me);
  save(); renderFriends(); toast('Добавлен в друзья');
  RT.send('social:follow',{from:me,to});
}

/* ========== 10) Сериализация для Ably ========== */
function serPost(p){ return {...p, createdAt:p.createdAt instanceof Date? p.createdAt.toISOString():p.createdAt, boostedAt:p.boostedAt? (p.boostedAt instanceof Date?p.boostedAt.toISOString():p.boostedAt):null}; }
function dePost(p){ return {...p, createdAt:new Date(p.createdAt), boostedAt:p.boostedAt? new Date(p.boostedAt):null}; }
function serPin(){ return { active: state.pin.active ? {postId:state.pin.active.postId, endsAt:state.pin.active.endsAt.toISOString()} : null }; }

/* ========== 11) Таймеры: пул + авто-снятие закрепа ========== */
function settleIfNeeded(){
  const now = new Date();
  const left = state.pool.epochEnds.getTime()-now.getTime();
  if(left>0) return;

  const justFinished = new Date(state.pool.epochEnds.getTime());
  justFinished.setUTCDate(justFinished.getUTCDate()-1);
  const eid = epochIdUTC(justFinished);
  if(state.pool.settledId===eid) { state.pool.epochEnds=epochEnd(); save(); renderHUD(); return; }

  const totalPts = Object.values(state.epochPoints||{}).reduce((a,b)=>a+(+b||0),0);
  const amount = state.pool.amt||0;

  const results = {};
  if(totalPts>0 && amount>0){
    for(const uid in state.epochPoints){
      const share = (state.epochPoints[uid]||0)/totalPts;
      const gain = +(amount*share).toFixed(2);
      if(gain>0){
        state.users[uid] ||= {diamonds:0, points:0, firstName:'User', id:uid, username:uid};
        state.users[uid].diamonds = (state.users[uid].diamonds||0) + gain;
        results[uid]=gain;
      }
    }
    toast('Пул распределён по баллам', 'info');
  }

  state.pool.amt=0;
  state.pool.epochEnds=epochEnd();
  state.pool.settledId=eid;
  state.epochPoints={};
  save(); renderHUD();

  RT.send('pool:settle',{eid,results,next:state.pool.epochEnds.toISOString()});
}

function tick(){
  // авто-снятие закрепа
  if(state.pin.active && toTime(state.pin.active.endsAt) <= Date.now()){
    state.pin.active=null; save(); RT.send('pin:update', serPin());
  }
  // корректность эпохи + возможное распределение
  if(!(state.pool?.epochEnds instanceof Date) || !Number.isFinite(state.pool.epochEnds.getTime())){
    state.pool.epochEnds=epochEnd();
  }
  settleIfNeeded();
  renderHUD(); renderPin();
}
setInterval(tick,1000);

/* ========== 12) Realtime события ========== */
RT.on((evt,fromHistory)=>{
  if(!evt||!evt.type) return;
  switch(evt.type){
    case 'user:upsert':{
      const u=evt.payload.user; if(!u) break;
      if(!state.users[u.id]){ state.users[u.id]=u; save(); renderFeed(); renderFriends(); }
      break;}
    case 'post:new':{
      const p=dePost(evt.payload.post);
      if(!state.posts.find(x=>x.id===p.id)){ state.posts.unshift(p); save(); renderFeed(); }
      break;}
    case 'post:stats':{
      const {id,likes,views}=evt.payload; const p=state.posts.find(x=>x.id===id);
      if(p){ p.likes=Math.max(p.likes,likes); p.views=Math.max(p.views,views); save(); renderFeed(); }
      break;}
    case 'post:boost':{
      const {id,boostedAt}=evt.payload; const p=state.posts.find(x=>x.id===id);
      if(p){ p.boostedAt=new Date(boostedAt); save(); renderFeed(); }
      break;}
    case 'pin:update':{
      const d=evt.payload;
      state.pin.active = d.active ? { postId:d.active.postId, endsAt:new Date(d.active.endsAt) } : null;
      save(); renderPin(); break;}
    case 'social:follow':{
      const {from,to}=evt.payload;
      state.social.followers[to] ||= []; if(!state.social.followers[to].includes(from)) state.social.followers[to].push(from);
      save(); renderFriends(); break;}
    case 'presence:ping':{
      const {uid}=evt.payload; state.presence[uid]=Date.now(); break;}
    case 'pool:add':{
      const {amount,from}=evt.payload||{};
      if(from!==state.current && typeof amount==='number'){
        state.pool.amt = (state.pool.amt||0) + amount; save(); renderHUD();
      }
      break;}
    case 'points:add':{
      const {uid,points}=evt.payload||{};
      if(uid!==state.current && Number.isFinite(points) && points>0){
        state.epochPoints[uid]=(state.epochPoints[uid]||0)+points;
      }
      break;}
    case 'pool:settle':{
      const {eid,results,next}=evt.payload||{};
      if(!eid || state.pool.settledId===eid) break;
      for(const uid in results){
        state.users[uid] ||= {diamonds:0, points:0, id:uid, firstName:'User', username:uid};
        state.users[uid].diamonds = (state.users[uid].diamonds||0) + (+results[uid]||0);
      }
      state.pool.amt=0; state.pool.settledId=eid;
      if(next) state.pool.epochEnds=new Date(next);
      state.epochPoints={};
      save(); renderHUD();
      if(results[state.current]) toast(`Начислено ${results[state.current]} 💎 из пула`, 'ok');
      break;}
  }
});

/* ========== 13) UI wiring ========== */
document.addEventListener('click',e=>{
  if(e.target.closest('[data-close]')){ e.target.closest('.modal').style.display='none'; }
  const nav=e.target.closest('.nav button'); if(nav&&nav.dataset.go){ go(nav.dataset.go); }
  const pack=e.target.closest('#store-section [data-pack]'); if(pack){
    const amt=parseInt(pack.dataset.pack,10); const u=state.users[state.current]; u.diamonds=(u.diamonds||0)+amt; save(); renderHUD(); toast(`Куплено ${amt} 💎`);
  }
});
byId('fab').onclick=()=> show(byId('m-create'));
byId('post-send').onclick=createPostFlow;
byId('boost-do').onclick=doBoost;
byId('pin-do').onclick=doPin;
byId('tab-all').onclick=()=>{ byId('tab-all').style.boxShadow='var(--ring)'; byId('tab-friends').style.boxShadow='none'; delete byId('tab-friends').dataset.active; renderFeed(); };
byId('tab-friends').onclick=()=>{ byId('tab-friends').style.boxShadow='var(--ring)'; byId('tab-friends').dataset.active='1'; byId('tab-all').style.boxShadow='none'; renderFeed(); };
byId('friend-add').onclick=()=>{
  const v=byId('friend-input').value.trim(); if(!v) return; const me=state.current;
  let id=v.startsWith('@')? v.slice(1): v;
  state.users[id] ||= {id, firstName: v.startsWith('@')?('@'+id):('User '+id), username:id, diamonds:0, points:0};
  state.epochPoints[id] ||= 0;
  follow(me,id); byId('friend-input').value='';
};
byId('to-friends').onclick=()=> go('friends-section'); byId('to-store').onclick=()=> go('store-section');

/* ========== 14) Boot ========== */
(async ()=>{
  await load();
  await initUser();
  renderAll();
  RT.ready.finally(()=>{ const me = state.users[state.current]; RT.send('user:upsert',{user:me}); });
})();

/* ========== 15) Экспорт ========== */
window.like=like; window.openBoost=openBoost; window.openPin=openPin; window.follow=follow;

} // end !__STOP_APP__
</script>
</body>
</html>
