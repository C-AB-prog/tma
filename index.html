<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diamond Feed • TMA v1.8.1 (Telegram-only + Ably realtime)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root{
      --bg:#0a0c12;--surface:#101423;--card:#141a2e;--muted:#9aa3b5;--text:#f3f6ff;
      --brand:#78a6ff;--brand-2:#a27aff;--ok:#43d6a3;--err:#ff6b6b;
      --radius:16px;--radius-lg:20px;--shadow:0 14px 50px rgba(0,0,0,.35);--ring:0 0 0 2px rgba(120,166,255,.45);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1000px 420px at 12% 0%, rgba(120,166,255,.14), transparent 55%),
        radial-gradient(900px 380px at 100% -10%, rgba(162,122,255,.12), transparent 60%),
        linear-gradient(180deg,#0a0c12,#0a0f18 40%,#0a0c12);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,Inter,Roboto,Segoe UI,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .container{max-width:760px;margin:0 auto;padding:0 14px calc(92px + env(safe-area-inset-bottom))}
    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:60;
      backdrop-filter:saturate(1.2) blur(12px);
      background:linear-gradient(to bottom, rgba(10,12,18,.86), rgba(10,12,18,.55));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .topbar-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:12px;
      background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 150deg, var(--brand) 360deg);
      display:grid;place-items:center;box-shadow:0 14px 28px rgba(120,166,255,.45)}
    .logo i{color:#fff}
    .title{font-weight:800;letter-spacing:.2px}
    .kpi{display:flex;gap:8px}
    .pill{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      font-size:12px;font-weight:800}
    .epochbar{height:3px;background:rgba(255,255,255,.07)}
    .epochbar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand-2));transition:width .4s ease}
    /* Sections */
    .section{display:none;animation:.25s fade ease}.section.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    /* Pinned */
    .pinned{margin:14px 0;border-radius:18px;overflow:hidden;display:none}
    .pinned .wrap{background:linear-gradient(180deg,rgba(120,166,255,.16),rgba(120,166,255,.04));backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);border-radius:18px}
    .pinned .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.14)}
    .pinned .body{padding:12px}
    .pin-meta{display:flex;gap:12px;color:var(--muted);font-size:12px;margin-top:6px}
    /* Cards */
    .card{background:linear-gradient(180deg,#141a2e,#131828);border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);padding:14px;margin:12px 0;box-shadow:var(--shadow);transition:transform .12s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-1px);box-shadow:0 20px 56px rgba(0,0,0,.45)}
    .row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .user{display:flex;gap:10px;align-items:center}
    .avatar{position:relative;width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;font-weight:900}
    .dot{position:absolute;right:-2px;bottom:-2px;width:11px;height:11px;border-radius:50%;border:2px solid var(--card)}.dot.online{background:var(--ok)}
    .name{font-weight:900}.meta{color:var(--muted);font-size:12px;margin-top:2px}
    .content{margin:10px 0 8px;line-height:1.6;font-size:15px}
    .stats{display:flex;gap:14px;color:var(--muted);font-size:12px}
    .actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
    .btn{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);font-weight:900;cursor:pointer;transition:transform .08s ease}
    .btn:active{transform:translateY(1px)} .btn:hover{box-shadow:var(--ring)} .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btn.like.liked{border-color:rgba(255,107,107,.4);background:linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,255,255,.02));color:#ff8a92}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:5px 9px;border-radius:10px;border:1px solid rgba(255,255,255,.13);font-size:11px}
    .badge.rocket{color:var(--ok);border-color:rgba(67,214,163,.4);background:linear-gradient(180deg, rgba(67,214,163,.18), rgba(255,255,255,.02))}
    .burst{position:absolute;inset:0;pointer-events:none}
    .heart{position:absolute;bottom:6px;left:50%;transform:translateX(-50%) scale(.8);opacity:0;animation:fly 700ms ease forwards}
    @keyframes fly{0%{opacity:0;transform:translate(-50%,0) scale(.6)}40%{opacity:1}100%{opacity:0;transform:translate(-50%,-34px) scale(1)}}
    .empty{padding:44px 18px;text-align:center;color:var(--muted)}
    /* Bottom nav — 5 кнопок */
    .nav{position:fixed;left:0;right:0;bottom:0;z-index:70;
      backdrop-filter:blur(12px);background:linear-gradient(to top, rgba(10,12,18,.92), rgba(10,12,18,.55));
      border-top:1px solid rgba(255,255,255,.07);padding:10px 8px calc(10px + env(safe-area-inset-bottom));
      display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .nav button{border:none;background:none;color:var(--muted);display:flex;flex-direction:column;gap:4px;align-items:center;padding:8px 6px;border-radius:10px;font-size:11px}
    .nav button.active{color:var(--brand);background:rgba(120,166,255,.16)}
    .fab{position:fixed;right:14px;bottom:calc(84px + env(safe-area-inset-bottom));width:56px;height:56px;border-radius:50%;display:grid;place-items:center;border:none;cursor:pointer;
      background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 160deg, var(--brand) 360deg); color:white;
      box-shadow:0 18px 52px rgba(120,166,255,.58);z-index:65}
    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.62);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:90}
    .modal__card{width:min(92vw,460px);max-height:84vh;overflow:auto;border-radius:18px;border:1px solid rgba(255,255,255,.09);background:var(--card);padding:18px}
    .modal__head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .modal__title{font-weight:900}.close{border:none;background:none;color:var(--muted);font-size:20px;cursor:pointer}
    .label{font-size:13px;color:var(--muted);margin:6px 0}
    .input,.textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.09);background:#0f1324;color:var(--text)}
    .textarea{min-height:120px;resize:vertical}
    .submit{width:100%;margin-top:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);
      border-radius:14px;padding:14px;text-align:center}
    .stat .v{font-size:18px;font-weight:900}.muted{color:var(--muted)}
    /* Profile tidy */
    .prof-head{display:flex;gap:12px;align-items:center}
    .prof-ava{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;font-weight:900;background:linear-gradient(135deg,var(--brand),var(--brand-2))}
    .prof-name{font-size:18px;font-weight:900}
    .section-title{font-weight:900;margin:8px 0 6px}
    .toast{position:fixed;right:14px;top:78px;z-index:95;display:grid;gap:8px}
    .toast .t{padding:11px 13px;border-radius:12px;color:#0b0b0f;font-weight:900}
    .t.ok{background:#43d6a3}.t.err{background:#ff7f88}.t.info{background:#78a6ff}
    @media(hover:hover){::-webkit-scrollbar{height:10px;width:10px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:10px}::-webkit-scrollbar-track{background:transparent}}
  </style>
</head>
<body>

  <!-- Telegram-only Gate -->
  <script>
    (function telegramOnlyGate(){
      const tg = window.Telegram?.WebApp;
      let BOT = 't11stMini_bot'; if(BOT.startsWith('@')) BOT = BOT.slice(1);
      if(!tg || !tg.initDataUnsafe?.user){
        const deepLink = `https://t.me/${BOT}?startapp=go`;
        document.body.innerHTML = `
          <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0a0c12;color:#f3f6ff;font-family:Inter,system-ui,sans-serif;padding:24px;text-align:center">
            <div style="max-width:520px;background:#141a2e;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:22px">
              <div style="font-size:20px;font-weight:900;margin-bottom:6px">Откройте через Telegram</div>
              <div style="color:#9aa3b5;margin-bottom:12px">Это мини-приложение доступно только внутри Telegram.</div>
              <a href="${deepLink}" style="display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg,#78a6ff,#a27aff);color:white;font-weight:900;text-decoration:none">Открыть в Telegram</a>
              <div style="color:#9aa3b5;font-size:12px;margin-top:8px">t.me/${BOT}</div>
            </div>
          </div>`;
        window.__STOP_APP__ = true; return;
      }
      window.__STOP_APP__ = false;
      try{ tg.ready(); tg.expand(); tg.disableVerticalSwipes?.(); }catch(e){}
    })();
  </script>

  <div class="toast" id="toast"></div>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-row container">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-gem"></i></div>
        <div class="title">Diamond Feed</div>
      </div>
      <div class="kpi">
        <div class="pill"><i class="fa-solid fa-trophy"></i><span id="points-pill">0 RAW / 0 EFF</span></div>
        <div class="pill"><i class="fa-solid fa-gem"></i><span id="balance-pill">0</span></div>
      </div>
    </div>
    <div class="container" style="padding:0 14px 10px">
      <div class="pill" style="gap:10px;display:inline-flex"><i class="fa-regular fa-clock"></i> до 24:00 UTC: <span id="epoch-eta">--:--:--</span> • онлайн друзей: <span id="friends-online">0</span></div>
    </div>
    <div class="epochbar"><span id="epoch-progress"></span></div>
  </header>

  <main class="container">
    <!-- PINNED -->
    <section class="pinned" id="pinned">
      <div class="wrap">
        <div class="head">
          <div class="pill" style="color:var(--brand)"><i class="fa-solid fa-thumbtack"></i> Закреплено • <span id="pin-author">—</span></div>
          <div class="pill"><i class="fa-regular fa-clock"></i> <span id="pin-timer">01:00</span></div>
        </div>
        <div class="body">
          <div id="pin-text" class="content"></div>
          <div class="pin-meta"><span><i class="fa-regular fa-eye"></i> <span id="pin-views">0</span></span>
            <span><i class="fa-regular fa-heart"></i> <span id="pin-likes">0</span></span></div>
          <div class="pin-meta" id="pin-queue" style="display:none"><i class="fa-solid fa-list-ol"></i> В очереди: <span id="queue-len">0</span> • <span id="queue-list"></span></div>
          <div id="pin-cta" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- FEED -->
    <section id="feed-section" class="section active">
      <div style="display:flex;gap:8px;margin:6px 0 2px">
        <button class="pill" id="tab-friends" data-filter="friends"><i class="fa-solid fa-user-group"></i> Друзья</button>
        <button class="pill" id="tab-all" data-filter="all" style="box-shadow:var(--ring)"><i class="fa-solid fa-globe"></i> Все</button>
      </div>
      <div id="feed"></div>
      <div class="empty" id="feed-empty" style="display:none">
        <i class="fa-regular fa-newspaper" style="font-size:40px"></i>
        <div style="margin-top:8px">Лента пуста. Нажмите «+», чтобы написать пост.</div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile-section" class="section">
      <div class="card">
        <div class="prof-head">
          <div class="prof-ava" id="pf-avatar">U</div>
          <div>
            <div class="prof-name" id="pf-name">Пользователь</div>
            <div class="meta" id="pf-id">ID: —</div>
            <div class="meta"><i class="fa-solid fa-shield"></i> Подтверждён через Telegram</div>
          </div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div class="stat"><div class="v" id="pf-diamonds">0</div><div class="muted">Алмазов</div></div>
          <div class="stat"><div class="v" id="pf-posts">0</div><div class="muted">Постов</div></div>
          <div class="stat"><div class="v" id="pf-reads">0</div><div class="muted">Прочтений</div></div>
          <div class="stat"><div class="v" id="pf-reacts">0</div><div class="muted">Реакций</div></div>
          <div class="stat"><div class="v" id="pf-raw">0</div><div class="muted">RAW</div></div>
          <div class="stat"><div class="v" id="pf-eff">0</div><div class="muted">EFF</div></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" id="goto-friends"><i class="fa-solid fa-user-group"></i> Друзья</button>
          <button class="btn" id="goto-store"><i class="fa-solid fa-store"></i> Магазин</button>
        </div>
      </div>
    </section>

    <!-- FRIENDS -->
    <section id="friends-section" class="section">
      <div class="section-title">Друзья</div>
      <div class="card">
        <div class="label">Добавить по User ID или @username</div>
        <div style="display:flex;gap:8px">
          <input id="friend-input" class="input" placeholder="например, 123456 или @username" />
          <button class="btn" id="friend-add"><i class="fa-solid fa-user-plus"></i> Добавить</button>
        </div>
      </div>
      <div class="grid">
        <div class="card" style="text-align:left">
          <div class="section-title">Вы подписаны</div>
          <div id="following-list" class="muted">—</div>
        </div>
        <div class="card" style="text-align:left">
          <div class="section-title">Подписчики</div>
          <div id="followers-list" class="muted">—</div>
        </div>
      </div>
    </section>

    <!-- STORE -->
    <section id="store-section" class="section">
      <div class="section-title">Магазин алмазов</div>
      <div class="card">
        <div class="label">Способ оплаты</div>
        <select id="pay-method"><option value="stars">Telegram Stars (iOS)</option><option value="ton">TON (Android/PC)</option></select>
        <div class="grid" style="margin-top:10px">
          <button class="btn" data-pack="100">100 💎 • ~1 TON</button>
          <button class="btn" data-pack="500">500 💎 • ~5 TON</button>
          <button class="btn" data-pack="1000">1000 💎 • ~10 TON</button>
          <button class="btn" data-pack="5000">5000 💎 • ~50 TON</button>
        </div>
        <div class="meta" style="margin-top:8px">Демо-оплата: средства зачисляются мгновенно (эмуляция)</div>
      </div>
    </section>

    <!-- POOL -->
    <section id="pool-section" class="section">
      <div class="section-title">Пул наград</div>
      <div class="card">
        <div class="name">Текущий пул: <b id="pool-amount">0</b> 💎</div>
        <div class="meta">Участников (≥ MIN_POINTS): <span id="pool-part">0</span></div>
      </div>
      <div class="card">
        <div class="name">Математика распределения</div>
        <div class="meta" style="margin-top:6px">Доля = Ваши баллы / ΣБаллов • Выплата = Пул × Доля • Округление до 0.01, «пыль» переносится</div>
      </div>
    </section>
  </main>

  <!-- Bottom nav: 5 кнопок -->
  <nav class="nav">
    <button class="active" data-go="feed-section"><i class="fa-solid fa-home"></i><span>Лента</span></button>
    <button data-go="profile-section"><i class="fa-solid fa-user"></i><span>Профиль</span></button>
    <button data-go="friends-section"><i class="fa-solid fa-user-group"></i><span>Друзья</span></button>
    <button data-go="store-section"><i class="fa-solid fa-store"></i><span>Магазин</span></button>
    <button data-go="pool-section"><i class="fa-solid fa-coins"></i><span>Пул</span></button>
  </nav>

  <button class="fab" id="create-btn"><i class="fa-solid fa-plus"></i></button>

  <!-- Modals -->
  <div class="modal" id="modal-create"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Создать пост</div><button class="close" data-close>&times;</button></div>
    <label class="label">Текст (до 500 символов, без ссылок)</label>
    <textarea id="post-text" class="textarea" maxlength="500" placeholder="Поделитесь чем-то интересным…"></textarea>
    <button id="post-submit" class="btn submit">Опубликовать за 10 💎</button>
    <div class="meta" style="margin-top:6px">Будет списано 10 алмазов</div>
  </div></div>

  <div class="modal" id="modal-boost"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Буст поста</div><button class="close" data-close>&times;</button></div>
    <div class="label">Поднять пост в топ за 10 💎? (кулдаун 5 минут)</div>
    <button id="boost-confirm" class="btn submit">Поднять за 10 💎</button>
    <div class="meta" id="boost-hint"></div>
  </div></div>

  <div class="modal" id="modal-pin"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Закрепить пост</div><button class="close" data-close>&times;</button></div>
    <div class="label">1 минута закрепа = 100 💎. Если слот занят — ваш пост встанет в очередь FIFO. Повторные покупки продлевают время.</div>
    <button id="pin-confirm" class="btn submit">В очередь / Закрепить за 100 💎</button>
    <div class="meta">Списывается 100 алмазов за каждую минуту</div>
  </div></div>

  <div class="modal" id="modal-report"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Пожаловаться</div><button class="close" data-close>&times;</button></div>
    <label class="label">Категория</label>
    <select id="report-type"><option>Спам</option><option>NSFW</option><option>Мошенничество</option><option>Оскорбления</option></select>
    <button id="report-send" class="btn submit">Отправить жалобу</button>
    <div class="meta">Жалоба отправится модераторам (демо)</div>
  </div></div>

  <script>
  if(!window.__STOP_APP__){

  /* ========== THEME ========== */
  function applyTelegramTheme(){
    try{
      const tp = Telegram?.WebApp?.themeParams || {};
      const set=(k,v)=> v && document.documentElement.style.setProperty(k,v);
      set('--bg',tp.bg_color); set('--surface',tp.secondary_bg_color);
      set('--card',tp.secondary_bg_color); set('--text',tp.text_color);
      set('--muted',tp.hint_color); set('--brand',tp.button_color);
    }catch(e){}
  }

  /* ========== ECONOMY / EPOCH ========== */
  const ECONOMY=Object.freeze({
    COST_POST:10, COST_BOOST:10, COST_PIN_PER_MIN:100,
    BOOST_COOLDOWN_MS:5*60*1000, POOL_SHARE:1.0, PLATFORM_FEE:0,
    MIN_POINTS:5, CAPS:{ READS:200, REACTS:100, PER_AUTHOR:20 }
  });
  const now=()=>new Date();
  const toUtcYMD=(d=now())=> new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString().slice(0,10);
  const epochEndsAt=()=> new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate()+1,0,0,0));
  const fmtClock=(ms)=>{ if(ms<0) ms=0; const s=Math.floor(ms/1000);
    const h=String(Math.floor(s/3600)).padStart(2,'0');
    const m=String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}` }

  /* ========== REALTIME (BroadcastChannel + Ably с вашим ключом) ========== */
  const RT = (()=>{
    const listeners=new Set();
    const bc=('BroadcastChannel' in window)? new BroadcastChannel('diamond-feed-rt'):null;
    if(bc) bc.onmessage=(e)=> listeners.forEach(fn=> fn(e.data));

    // *** CONFIG ***
    const DEFAULT_ABLY_KEY = 'M0ySVA.pJLtkQ:SQP5uiSTbYG8Q7YbpWxq_T_YS5LcALRE5KXktyfOl5Y'; // <-- ваш ключ
    const DEFAULT_CHANNEL  = 'diamond-feed';

    const qs=new URLSearchParams(location.search);
    const ablyKey   = qs.get('ably') || DEFAULT_ABLY_KEY;
    const chanName  = qs.get('chan') || DEFAULT_CHANNEL;

    let ably=null, chan=null;
    async function initAbly(){
      if(!ablyKey || !window.Ably) return;
      try{
        ably = new Ably.Realtime.Promise(ablyKey);
        chan = ably.channels.get(chanName);

        // подписка на live
        chan.subscribe((msg)=>{
          const data = msg.data && msg.data.type ? msg.data : { type: msg.name, payload: msg.data, ts: Date.now() };
          listeners.forEach(fn=> fn(data));
        });

        // подхват последних сообщений (история)
        try{
          const page = await chan.history({limit:100});
          const items = page?.items||[];
          for(let i=items.length-1;i>=0;i--){
            const m=items[i];
            const data = m.data && m.data.type ? m.data : { type:m.name, payload:m.data, ts: Date.parse(m.timestamp) || Date.now() };
            listeners.forEach(fn=> fn(data));
          }
        }catch(e){}
      }catch(e){ console.warn('Ably init failed', e); }
    }
    initAbly();

    return {
      send:(type,payload)=>{
        const msg={type,payload,ts:Date.now()};
        if(chan){ try{ chan.publish(type,msg); }catch(e){} }
        if(bc) bc.postMessage(msg);
      },
      on:(fn)=> listeners.add(fn)
    };
  })();

  /* ========== STATE ========== */
  let state={
    users:{}, currentUserId:null, posts:[],
    interactions:{}, daily:{}, points:{}, trust:{},
    pool:{ amount:0, dust:0, participants:0, epoch:toUtcYMD(), endsAt:epochEndsAt() },
    pin:{ active:null, queue:[] },
    transactions:{}, moderation:{ reports:[] },
    social:{ following:{}, followers:{} },
    presence:{},
    ui:{ currentPostId:null, feedFilter:'all' }
  };

  const save=()=> localStorage.setItem('diamond-feed-v181', JSON.stringify(state, (k,v)=> v instanceof Date ? {__t:'d',v:v.toISOString()}: v));
  const revive=(o)=>{ if(!o||typeof o!=='object') return o; if(o.__t==='d') return new Date(o.v); for(const k of Object.keys(o)) o[k]=revive(o[k]); return o; };
  const load=()=> { const raw=localStorage.getItem('diamond-feed-v181'); if(!raw) return false; try{ state=revive(JSON.parse(raw)); return true; }catch(e){ console.warn(e); return false; } };
  function ensureSets(){ const F=state.social.following, R=state.social.followers;
    for(const uid of Object.keys(F)) if(!(F[uid] instanceof Set)) F[uid]=new Set(F[uid]);
    for(const uid of Object.keys(R)) if(!(R[uid] instanceof Set)) R[uid]=new Set(R[uid]); }

  /* ========== USER (strict Telegram) ========== */
  function initUser(){
    const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
    if(!u) throw new Error('No Telegram user');
    const id=String(u.id);
    if(!state.users[id]){
      state.users[id]={ id,
        firstName:u.first_name||'User', lastName:u.last_name||'',
        username:u.username||('user'+id), isPremium:!!u.is_premium, diamonds:250
      };
      state.trust[id]=1.0;
    }
    state.currentUserId=id;
    state.social.following[id] ||= new Set();
    state.social.followers[id] ||= new Set();
  }

  /* ========== PRESENCE & FRIENDS ========== */
  function pingPresence(){ const uid=state.currentUserId; state.presence[uid]=Date.now(); RT.send('presence:ping',{ uid }); }
  function isOnline(uid){ const last=state.presence[uid]||0; return Date.now()-last<30000; }
  function follow(me,target){
    if(me===target) return false;
    state.social.following[me] ||= new Set(); state.social.followers[target] ||= new Set();
    if(state.social.following[me].has(target)) return false;
    state.social.following[me].add(target); state.social.followers[target].add(me);
    save(); renderFriendsLists(); renderFeed(); toast('Добавлен в друзья');
    RT.send('social:follow',{from:me,to:target}); return true;
  }
  function unfollow(me,target){
    if(!state.social.following[me]?.has(target)) return false;
    state.social.following[me].delete(target); state.social.followers[target]?.delete(me);
    save(); renderFriendsLists(); renderFeed(); toast('Удалён из друзей','info');
    RT.send('social:unfollow',{from:me,to:target}); return true;
  }
  function isFollowing(me,target){ return !!state.social.following[me]?.has(target); }

  /* ========== ECONOMY OPS ========== */
  function spendDiamonds(userId,amount,meta){
    const u=state.users[userId]; if(!u||u.diamonds<amount) return false;
    u.diamonds-=amount;
    const toPool=Math.floor(amount*ECONOMY.POOL_SHARE*(1-ECONOMY.PLATFORM_FEE));
    state.pool.amount+=toPool;
    (state.transactions[userId] ||= []).push({type:'spend',amount,meta,at:now()});
    return true;
  }
  function publishPost(authorId,text){
    const post={ id:String(Date.now()+Math.random()), authorId, text, createdAt:now(), views:0, likes:0, boostedAt:null };
    state.posts.unshift(post); return post;
  }
  function createPostFlow(){
    const text=document.getElementById('post-text').value.trim();
    if(!text){ toast('Введите текст поста','err'); return; }
    if(/https?:\/\//i.test(text)){ toast('Ссылки запрещены в MVP','err'); return; }
    if(text.length>500){ toast('Слишком длинно','err'); return; }
    if(!spendDiamonds(state.currentUserId, ECONOMY.COST_POST, {op:'post'})){ toast('Недостаточно алмазов','err'); go('store-section'); return; }
    const p=publishPost(state.currentUserId,text);
    closeModal('modal-create'); document.getElementById('post-text').value='';
    renderAll(); save(); toast('Пост опубликован!'); RT.send('post:new',{ post: serializePost(p) }); haptic('success');
  }
  function openBoost(postId){
    state.ui.currentPostId=postId;
    const post=state.posts.find(p=>p.id===postId);
    const cdLeft=post?.boostedAt?(post.boostedAt.getTime()+ECONOMY.BOOST_COOLDOWN_MS - now().getTime()):0;
    byId('boost-hint').textContent=cdLeft>0?`Доступно через ${fmtClock(cdLeft)}`:'';
    showModal(byId('modal-boost'));
  }
  function doBoost(){
    const post=state.posts.find(p=>p.id===state.ui.currentPostId); if(!post) return;
    if(post.authorId!==state.currentUserId){ toast('Бустить может только автор','err'); return; }
    const cdLeft=post.boostedAt?(post.boostedAt.getTime()+ECONOMY.BOOST_COOLDOWN_MS - now().getTime()):0;
    if(cdLeft>0){ toast('Рано: кулдаун 5 минут','err'); return; }
    if(!spendDiamonds(state.currentUserId, ECONOMY.COST_BOOST, {op:'boost',postId:post.id})){ toast('Недостаточно алмазов','err'); closeModal('modal-boost'); go('store-section'); return; }
    post.boostedAt=now(); closeModal('modal-boost'); renderAll(); save(); toast('Пост поднят в топ');
    RT.send('post:boost',{ id:post.id, boostedAt:post.boostedAt.toISOString() }); haptic('success');
  }
  function openPin(postId){ state.ui.currentPostId=postId; showModal(byId('modal-pin')); }
  function doPin(){
    const postId=state.ui.currentPostId; const post=state.posts.find(p=>p.id===postId); if(!post) return;
    if(post.authorId!==state.currentUserId){ toast('Закрепляет только автор','err'); return; }
    if(!spendDiamonds(state.currentUserId, ECONOMY.COST_PIN_PER_MIN, {op:'pin',postId})){ toast('Недостаточно алмазов','err'); closeModal('modal-pin'); go('store-section'); return; }
    const plusMs=60*1000;
    if(state.pin.active && state.pin.active.postId===postId){ state.pin.active.endsAt=new Date(state.pin.active.endsAt.getTime()+plusMs); }
    else if(state.pin.queue.length && state.pin.queue[state.pin.queue.length-1].postId===postId){ state.pin.queue[state.pin.queue.length-1].minutes+=1; }
    else if(!state.pin.active){ state.pin.active={ postId, endsAt:new Date(now().getTime()+plusMs) } }
    else { state.pin.queue.push({ postId, userId:state.currentUserId, minutes:1, enqueuedAt:now() }); }
    closeModal('modal-pin'); renderAll(); save(); toast('Покупка закрепа успешна'); RT.send('pin:update', serializePin()); haptic('success');
  }
  function serializePin(){
    return { active: state.pin.active? { postId:state.pin.active.postId, endsAt:state.pin.active.endsAt.toISOString() }:null,
             queue: state.pin.queue.map(q=> ({...q, enqueuedAt:q.enqueuedAt.toISOString()})) };
  }
  function pinTicker(){
    if(!state.pin.active) return;
    const left=state.pin.active.endsAt.getTime()-now().getTime();
    if(left<=0){
      const next=state.pin.queue.shift();
      if(next){ state.pin.active={ postId:next.postId, endsAt:new Date(now().getTime()+next.minutes*60*1000) } }
      else { state.pin.active=null }
      renderAll(); save(); RT.send('pin:update', serializePin());
    }
  }

  /* ========== POINTS ========== */
  const readWatch=new Map(); let visibilityOk=document.visibilityState==='visible';
  window.addEventListener('visibilitychange',()=> visibilityOk=document.visibilityState==='visible');
  window.addEventListener('focus',()=> visibilityOk=true); window.addEventListener('blur',()=> visibilityOk=false);
  function ensureEpochStructures(ep){
    state.interactions[ep] ||= {}; state.daily[ep] ||= {}; state.points[ep] ||= {};
    const uid=state.currentUserId; state.interactions[ep][uid] ||= {};
    state.daily[ep][uid] ||= { reads:0, reacts:0, perAuthor:{} };
    state.points[ep][uid] ||= { reads:0, reacts:0, raw:0, eff:0 };
  }
  function grantRead(post){
    const ep=state.pool.epoch; ensureEpochStructures(ep);
    const uid=state.currentUserId; const authorId=post.authorId; if(authorId===uid) return;
    const caps=state.daily[ep][uid]; if(caps.reads>=ECONOMY.CAPS.READS) return;
    const fromAuthor=(caps.perAuthor[authorId]||0); if(fromAuthor>=ECONOMY.CAPS.PER_AUTHOR) return;
    const inter=state.interactions[ep][uid][post.id] ||= { read:false, react:false }; if(inter.read) return;
    inter.read=true; caps.reads+=1; caps.perAuthor[authorId]=fromAuthor+1;
    const p=state.points[ep][uid]; p.reads+=1; p.raw+=1; p.eff=Math.round(p.raw*(state.trust[uid]||1.0));
    post.views+=1; save(); renderHUD();
  }
  function grantReact(post){
    const ep=state.pool.epoch; ensureEpochStructures(ep);
    const uid=state.currentUserId; const authorId=post.authorId; if(authorId===uid) return;
    const caps=state.daily[ep][uid]; if(caps.reacts>=ECONOMY.CAPS.REACTS) return;
    const fromAuthor=(caps.perAuthor[authorId]||0); if(fromAuthor>=ECONOMY.CAPS.PER_AUTHOR) return;
    const inter=state.interactions[ep][uid][post.id] ||= { read:false, react:false }; if(inter.react) return;
    inter.react=true; caps.reacts+=1; caps.perAuthor[authorId]=fromAuthor+1;
    const p=state.points[ep][uid]; p.reacts+=1; p.raw+=3; p.eff=Math.round(p.raw*(state.trust[uid]||1.0));
    post.likes+=1; save(); renderAll(); toast('+3 балла!','ok'); RT.send('post:stats',{ id:post.id, likes:post.likes, views:post.views }); haptic('impact');
  }
  function attachReadObserver(){
    const io=new IntersectionObserver((entries)=>{
      for(const e of entries){
        const el=e.target; const postId=el.dataset.postId; const half=e.intersectionRatio>=.5;
        if(half){ readWatch.set(postId,{ seenAt:now() }); } else { readWatch.delete(postId); }
      }
    },{threshold:[0,.5,1]});
    document.querySelectorAll('.card[data-post-id]').forEach(el=> io.observe(el));
    setInterval(()=>{
      if(!visibilityOk) return;
      for(const [postId,ctx] of readWatch){
        if(now().getTime()-ctx.seenAt.getTime()>=2000){
          const post=state.posts.find(p=>p.id===postId);
          if(post){ grantRead(post); readWatch.delete(postId); }
        }
      }
    },600);
  }

  /* ========== SETTLEMENT ========== */
  function settlementTick(){
    if(now().getTime()<state.pool.endsAt.getTime()) return;
    const ep=state.pool.epoch; const nextEp=toUtcYMD(new Date(state.pool.endsAt));
    const points=state.points[ep]||{};
    const eligible=Object.entries(points).filter(([uid,p])=> (p.eff||0)>ECONOMY.MIN_POINTS);
    const sumEff=eligible.reduce((s,[,p])=> s+(p.eff||0),0);
    let poolTotal=state.pool.amount+(state.pool.dust||0);
    const payouts=[]; let used=0;
    if(sumEff>0 && poolTotal>0){
      for(const [uid,p] of eligible){
        const share=p.eff/sumEff; let amt=poolTotal*share; amt=Math.floor(amt*100)/100; used+=amt; payouts.push([uid,amt]);
      }
    }
    const dust=Math.max(0, poolTotal-used);
    for(const [uid,amt] of payouts){
      state.users[uid].diamonds=(state.users[uid].diamonds||0)+amt;
      (state.transactions[uid] ||= []).push({type:'reward', amount:amt, meta:{epoch:ep}, at:now()});
    }
    state.pool={ amount:0, dust, participants:0, epoch:nextEp, endsAt:epochEndsAt() };
    renderAll(); save(); toast('Эпоха закрыта. Выплаты начислены.','ok');
  }

  /* ========== RENDER ========== */
  const byId=(id)=> document.getElementById(id);
  function renderHUD(){
    const uid=state.currentUserId; const user=state.users[uid];
    const ep=state.pool.epoch; const P=state.points[ep]?.[uid] || {raw:0,eff:0};
    byId('balance-pill').textContent=user.diamonds;
    byId('points-pill').textContent=`${P.raw||0} RAW / ${P.eff||0} EFF`;
    const totalMs=24*3600*1000; const leftMs=state.pool.endsAt.getTime()-now().getTime();
    byId('epoch-eta').textContent=fmtClock(leftMs);
    byId('epoch-progress').style.width=`${Math.max(0, Math.min(1, 1-(leftMs/totalMs)))*100}%`;
    const following=state.social.following[uid]||new Set(); let on=0; for(const f of following){ if(isOnline(f)) on++; } byId('friends-online').textContent=on;

    // Profile
    byId('pf-avatar').textContent=avatarText(user); byId('pf-name').textContent=displayName(user); byId('pf-id').textContent=`ID: ${user.id}`;
    byId('pf-diamonds').textContent=user.diamonds;
    const stats=state.points[ep]?.[uid] || {reads:0,reacts:0,raw:0,eff:0};
    byId('pf-reads').textContent=stats.reads||0; byId('pf-reacts').textContent=stats.reacts||0; byId('pf-raw').textContent=stats.raw||0; byId('pf-eff').textContent=stats.eff||0;
    byId('pf-posts').textContent=state.posts.filter(p=>p.authorId===uid).length;

    // Pool
    byId('pool-amount').textContent=(state.pool.amount+(state.pool.dust||0)).toFixed(2);
    const eligible=Object.values(state.points[ep]||{}).filter(p=> (p.eff||0)>ECONOMY.MIN_POINTS).length; byId('pool-part').textContent=eligible;

    renderFriendsLists();
  }
  function sortPosts(){
    return [...state.posts].sort((a,b)=>{
      const ab=b.boostedAt? b.boostedAt.getTime():0; const aa=a.boostedAt? a.boostedAt.getTime():0;
      if(ab!==aa) return ab-aa; return b.createdAt.getTime()-a.createdAt.getTime();
    });
  }
  const escapeHtml=(s)=> s.replace(/[&<>\"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const avatarText=(u)=> (u.firstName||u.username||'U').slice(0,1).toUpperCase();
  const displayName=(u)=> u.firstName && u.lastName ? `${u.firstName} ${u.lastName}` : (u.firstName || `@${u.username}`);

  function renderFeed(){
    const list=byId('feed'); const itemsAll=sortPosts(); const uid=state.currentUserId;
    const following=state.social.following[uid]||new Set();
    const items = state.ui.feedFilter==='friends' ? itemsAll.filter(p=> p.authorId===uid || following.has(p.authorId)) : itemsAll;

    list.innerHTML = items.map((p,idx)=>{
      const author=state.users[p.authorId]||{firstName:'User'}; const isMine=p.authorId===uid;
      const liked=!!(state.interactions[state.pool.epoch]?.[uid]?.[p.id]?.react);
      const canBoost=isMine; const cdLeft=p.boostedAt?(p.boostedAt.getTime()+ECONOMY.BOOST_COOLDOWN_MS - now().getTime()):0;
      const followBtn=(!isMine && !isFollowing(uid,p.authorId))? `<button class="btn" onclick="follow('${uid}','${p.authorId}')"><i class='fa-solid fa-user-plus'></i></button>`:'';
      const onlineDot = isOnline(p.authorId)? '<span class="dot online"></span>':'';
      return `
      <article class="card" data-post-id="${p.id}" style="animation-delay:${Math.min(idx*40,240)}ms">
        <div class="row">
          <div class="user">
            <div class="avatar">${avatarText(author)}${onlineDot}</div>
            <div>
              <div class="name">${displayName(author)} ${author.isPremium?'<i class="fa-solid fa-star" style="color:var(--ok)"></i>':''} ${isMine?'<span class="muted">(Вы)</span>':''}</div>
              <div class="meta">${p.createdAt.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})} ${p.boostedAt? ' • <span class="badge rocket"><i class="fa-solid fa-rocket"></i> Boost</span>':''}</div>
            </div>
          </div>
          <div style="display:flex;gap:6px">${followBtn}<button class="btn" onclick="openReport('${p.id}')" title="Пожаловаться"><i class="fa-solid fa-flag"></i></button></div>
        </div>
        <div class="content">${escapeHtml(p.text)}</div>
        <div class="stats"><span><i class="fa-regular fa-eye"></i> ${p.views}</span><span><i class="fa-regular fa-heart"></i> ${p.likes}</span></div>
        <div class="actions">
          <button class="btn like ${liked?'liked':''}" ${isMine?'disabled':''} onclick="react(event,'${p.id}')"><span class="burst"></span><i class="${liked?'fa-solid':'fa-regular'} fa-heart"></i> Лайк</button>
          <button class="btn" ${!canBoost?'disabled':''} onclick="openBoost('${p.id}')"><i class="fa-solid fa-rocket"></i> Буст ${cdLeft>0?`(${fmtClock(cdLeft)})`:''}</button>
          <button class="btn" ${!isMine?'disabled':''} onclick="openPin('${p.id}')"><i class="fa-solid fa-thumbtack"></i> Закреп</button>
        </div>
      </article>`;
    }).join('');

    byId('feed-empty').style.display = items.length? 'none':'block';
    attachReadObserver(); renderPinned();
  }

  function renderPinned(){
    const slot=byId('pinned'); if(!state.pin.active){ slot.style.display='none'; byId('pin-cta').innerHTML=''; return; }
    const p=state.posts.find(x=> x.id===state.pin.active.postId); if(!p){ slot.style.display='none'; return; }
    const author=state.users[p.authorId]||{firstName:'User'}; slot.style.display='block';
    byId('pin-author').textContent=displayName(author); byId('pin-text').textContent=p.text;
    byId('pin-views').textContent=p.views; byId('pin-likes').textContent=p.likes;
    const hasQ=state.pin.queue.length>0; byId('pin-queue').style.display=hasQ? 'flex':'none';
    byId('queue-len').textContent=state.pin.queue.length;
    if(hasQ){ const items=state.pin.queue.map(q=> `${displayName(state.users[q.userId]||{firstName:'?'})}×${q.minutes}`).join(', '); const el=document.getElementById('queue-list'); if(el) el.textContent=items; }
    const left=state.pin.active.endsAt.getTime()-now().getTime(); byId('pin-timer').textContent=fmtClock(left);
    if(p.authorId===state.currentUserId){ byId('pin-cta').innerHTML = `<button class="btn" onclick="openPin('${p.id}')"><i class='fa-solid fa-plus'></i> Продлить 1 мин за 100 💎</button>` } else { byId('pin-cta').innerHTML='' }
  }

  function renderFriendsLists(){
    const uid=state.currentUserId;
    const flw=[...(state.social.following[uid]||new Set())].map(id=> `${displayName(state.users[id]||{firstName:'?'})} <a href='#' onclick="unfollow('${uid}','${id}');return false">(удалить)</a>`).join('<br/>') || '—';
    const frs=[...(state.social.followers[uid]||new Set())].map(id=> displayName(state.users[id]||{firstName:'?'}) ).join('<br/>') || '—';
    const f=byId('following-list'); const fr=byId('followers-list'); if(f) f.innerHTML=flw; if(fr) fr.innerHTML=frs;
  }

  /* ========== UI HELPERS ========== */
  function react(evt,postId){ const post=state.posts.find(p=>p.id===postId); if(!post) return; grantReact(post); if(evt && evt.currentTarget){ heartBurst(evt.currentTarget); } }
  function openReport(postId){ state.ui.currentPostId=postId; showModal(byId('modal-report')); }
  function sendReport(){ const type=byId('report-type').value; state.moderation.reports.push({postId:state.ui.currentPostId, type, at:now()}); save(); closeModal('modal-report'); toast('Жалоба отправлена','info'); }
  function buyPack(amount){ const uid=state.currentUserId; state.users[uid].diamonds+=amount; (state.transactions[uid] ||= []).push({type:'purchase', amount, meta:{method:byId('pay-method').value}, at:now()}); save(); renderHUD(); toast(`Куплено ${amount} 💎`,'ok'); haptic('success'); }
  function heartBurst(btn){ const burst=btn.querySelector('.burst'); if(!burst) return; for(let i=0;i<4;i++){ const el=document.createElement('div'); el.className='heart'; el.style.left=(35+Math.random()*30)+'%'; el.style.animationDelay=(i*60)+'ms'; el.innerHTML='<i class="fa-solid fa-heart"></i>'; burst.appendChild(el); setTimeout(()=> el.remove(), 800); } }
  function haptic(type){ try{ const h=Telegram?.WebApp?.HapticFeedback; if(!h) return; if(type==='success') h.notificationOccurred('success'); else if(type==='impact') h.impactOccurred('medium'); }catch(e){} }
  function showModal(el){ el.style.display='flex'; } function closeModal(id){ byId(id).style.display='none'; }
  function toast(msg,kind='ok'){ const t=document.createElement('div'); t.className=`t ${kind==='err'?'err':kind==='info'?'info':'ok'}`; t.textContent=msg; byId('toast').appendChild(t); setTimeout(()=> t.remove(), 2600); }
  function go(id){ document.querySelectorAll('.nav button').forEach(b=> b.classList.toggle('active', b.dataset.go===id)); document.querySelectorAll('.section').forEach(s=> s.classList.toggle('active', s.id===id)); }

  // Click handlers
  document.addEventListener('click',(e)=>{
    if(e.target.dataset.close!==undefined || e.target.closest('[data-close]')){ const m=e.target.closest('.modal'); if(m) m.style.display='none'; }
    const navBtn=e.target.closest('.nav button'); if(navBtn && navBtn.dataset.go){ go(navBtn.dataset.go); }
    const storePack=e.target.closest('#store-section [data-pack]'); if(storePack){ buyPack(parseInt(storePack.dataset.pack,10)); }
  });
  byId('create-btn').onclick=()=> showModal(byId('modal-create'));
  byId('post-submit').onclick=createPostFlow; byId('boost-confirm').onclick=doBoost; byId('pin-confirm').onclick=doPin; byId('report-send').onclick=sendReport;
  byId('tab-all').onclick=()=>{ state.ui.feedFilter='all'; byId('tab-all').style.boxShadow='var(--ring)'; byId('tab-friends').style.boxShadow='none'; renderFeed(); };
  byId('tab-friends').onclick=()=>{ state.ui.feedFilter='friends'; byId('tab-friends').style.boxShadow='var(--ring)'; byId('tab-all').style.boxShadow='none'; renderFeed(); };
  byId('friend-add').onclick=()=>{
    const v=byId('friend-input').value.trim(); if(!v) return;
    const uid=state.currentUserId; let targetId=null;
    if(v.startsWith('@')){ const name=v.slice(1); targetId=name; state.users[targetId] ||= {id:targetId, firstName:'@'+name, username:name, diamonds:0}; }
    else { targetId=String(v); state.users[targetId] ||= {id:targetId, firstName:'User '+targetId, username:'user'+targetId, diamonds:0}; }
    follow(uid,targetId); byId('friend-input').value='';
  };
  byId('goto-friends').onclick=()=> go('friends-section');
  byId('goto-store').onclick=()=> go('store-section');

  /* ========== REALTIME EVENTS ========== */
  RT.on((evt)=>{
    if(!evt||!evt.type) return;
    switch(evt.type){
      case 'post:new': {
        const p=deserializePost(evt.payload.post);
        state.users[p.authorId] ||= {id:p.authorId, firstName:'User '+p.authorId, username:'user'+p.authorId, diamonds:0};
        if(!state.posts.find(x=>x.id===p.id)){ state.posts.unshift(p); renderFeed(); save(); }
        break;
      }
      case 'post:boost': {
        const {id,boostedAt}=evt.payload; const p=state.posts.find(x=>x.id===id);
        if(p){ p.boostedAt=new Date(boostedAt); renderFeed(); save(); }
        break;
      }
      case 'post:stats': {
        const {id,likes,views}=evt.payload; const p=state.posts.find(x=>x.id===id);
        if(p){ p.likes=Math.max(p.likes,likes); p.views=Math.max(p.views,views); renderFeed(); save(); }
        break;
      }
      case 'pin:update': {
        const data=evt.payload;
        state.pin.active=data.active? { postId:data.active.postId, endsAt:new Date(data.active.endsAt) }:null;
        state.pin.queue=(data.queue||[]).map(q=> ({...q, enqueuedAt:new Date(q.enqueuedAt)}));
        renderPinned(); save(); break;
      }
      case 'social:follow': {
        const {from,to}=evt.payload;
        state.social.followers[to] ||= new Set(); state.social.followers[to].add(from);
        renderFriendsLists(); save(); break;
      }
      case 'social:unfollow': {
        const {from,to}=evt.payload; state.social.followers[to]?.delete(from); renderFriendsLists(); save(); break;
      }
      case 'presence:ping': {
        const {uid}=evt.payload; state.presence[uid]=Date.now(); renderHUD(); break;
      }
    }
  });

  function serializePost(p){ return { ...p, createdAt:p.createdAt.toISOString(), boostedAt:p.boostedAt? p.boostedAt.toISOString():null } }
  function deserializePost(p){ return { ...p, createdAt:new Date(p.createdAt), boostedAt:p.boostedAt? new Date(p.boostedAt):null } }

  /* ========== TICKERS / BOOT ========== */
  setInterval(()=>{ renderHUD(); pinTicker(); settlementTick(); renderPinned(); pingPresence(); }, 1000);

  applyTelegramTheme();
  if(!load()){ initUser(); } else { try{ initUser(); }catch(e){} }
  ensureSets();
  state.pool.epoch=toUtcYMD(); state.pool.endsAt=epochEndsAt(); ensureEpochStructures(state.pool.epoch);
  renderAll(); setTimeout(attachReadObserver,0);

  function renderAll(){ renderHUD(); renderFeed(); }
  } // end !__STOP_APP__
  </script>
</body>
</html>
