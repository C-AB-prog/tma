<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diamond Feed • TMA v1.7.1 (Telegram-only + Realtime)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Опционально для кросс-устройств: ?ably=YOUR_KEY&chan=diamond-feed -->
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root{
      --bg:#08090f;--bg-2:#0f1220;--card:#14182a;--muted:#9aa3b5;--text:#f3f5fb;
      --brand:#7aa2ff;--brand-2:#a276ff;--ok:#43d6a3;--warn:#ffb84d;--err:#ff6b6b;
      --radius:16px;--radius-lg:22px;--shadow:0 16px 60px rgba(0,0,0,.35);--ring:0 0 0 2px rgba(122,162,255,.4);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,.16), transparent 60%),
        radial-gradient(900px 400px at 100% 0%, rgba(162,118,255,.14), transparent 60%),
        linear-gradient(180deg,#090a12,#0b0e18 40%,#0a0d17);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',Inter,Roboto,Segoe UI,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .container{max-width:760px;margin:0 auto;padding:0 16px calc(100px + env(safe-area-inset-bottom))}
    .header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.2) blur(14px);
      background:linear-gradient(to bottom, rgba(9,10,18,.9), rgba(9,10,18,.55));
      border-bottom:1px solid rgba(255,255,255,.07)}
    .header-row{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 0}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:14px;
      background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 150deg, var(--brand) 360deg);
      display:grid;place-items:center;box-shadow:0 18px 36px rgba(122,162,255,.45)}
    .logo i{color:white}
    .title{font-weight:900;letter-spacing:.2px}
    .kpis{display:flex;gap:8px;align-items:center}
    .pill{display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.09);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      padding:8px 12px;border-radius:14px;font-size:13px;font-weight:800;box-shadow:inset 0 0 0 1px rgba(255,255,255,.02)}
    .pill i{opacity:.95}
    .hint{color:var(--muted);font-size:12px}
    .epochbar{height:3px;width:100%;background:rgba(255,255,255,.08)}
    .epochbar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand-2));transition:width .4s ease}
    .section{display:none;animation:fade .25s ease}.section.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .pinned{margin:16px 0;position:relative;border-radius:18px;overflow:hidden}
    .pinned::before{content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;
      background:linear-gradient(120deg, rgba(122,162,255,.5), rgba(162,118,255,.25) 40%, rgba(122,162,255,.5));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
    .pinned__card{position:relative;background:linear-gradient(180deg,rgba(122,162,255,.16),rgba(122,162,255,.04));backdrop-filter:blur(10px);border-radius:inherit}
    .pinned__head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px dashed rgba(255,255,255,.14)}
    .pinned__label{display:flex;gap:10px;align-items:center;color:var(--brand);font-weight:900}
    .pinned__timer{display:flex;gap:8px;align-items:center;background:rgba(122,162,255,.25);border:1px solid rgba(122,162,255,.45);
      padding:6px 10px;border-radius:10px;font-weight:900}
    .pinned__body{padding:16px}
    .pinned__meta{display:flex;gap:14px;color:var(--muted);font-size:13px;margin-top:8px}
    .queue{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;margin-top:8px}
    .card{position:relative;background:linear-gradient(180deg,#14182a,#121628);
      border-radius:var(--radius);padding:16px;margin:12px 0;box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.07);transition:transform .15s ease, box-shadow .25s ease}
    .card:hover{transform:translateY(-1px);box-shadow:0 20px 54px rgba(0,0,0,.45)}
    .card::after{content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;pointer-events:none;opacity:0;transition:opacity .2s ease;
      background:linear-gradient(120deg, rgba(122,162,255,.5), rgba(162,118,255,.3), rgba(122,162,255,.5));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
    .card:hover::after{opacity:.85}
    .row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .user{display:flex;gap:12px;align-items:center}
    .avatar{position:relative;width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;font-weight:900}
    .dot{position:absolute;right:-2px;bottom:-2px;width:12px;height:12px;border-radius:50%;border:2px solid var(--card)}.dot.online{background:var(--ok)}
    .name{font-weight:900}.meta{color:var(--muted);font-size:12px;margin-top:2px}
    .content{margin:12px 0 10px;line-height:1.6;font-size:15px}
    .stats{display:flex;gap:14px;color:var(--muted);font-size:12px}
    .actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px}
    .btn{position:relative;isolation:isolate;display:flex;gap:8px;align-items:center;justify-content:center;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.09);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));color:var(--text);font-weight:900;cursor:pointer;transition:transform .08s ease}
    .btn:active{transform:translateY(1px)} .btn:hover{box-shadow:var(--ring)} .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btn.like.liked{border-color:rgba(255,107,107,.4);background:linear-gradient(180deg, rgba(255,107,107,.2), rgba(255,255,255,.02));color:#ff8a92}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.13);font-size:12px}
    .badge.rocket{color:var(--ok);border-color:rgba(67,214,163,.4);background:linear-gradient(180deg, rgba(67,214,163,.18), rgba(255,255,255,.02))}
    .burst{position:absolute;inset:0;pointer-events:none}
    .heart{position:absolute;bottom:8px;left:50%;transform:translateX(-50%) scale(.8);opacity:0;animation:fly 700ms ease forwards}
    @keyframes fly{0%{opacity:0;transform:translate(-50%,0) scale(.6)}40%{opacity:1}100%{opacity:0;transform:translate(-50%,-36px) scale(1)}}
    .empty{padding:48px 20px;text-align:center;color:var(--muted)}
    .nav{position:fixed;left:0;right:0;bottom:0;backdrop-filter:blur(14px);background:linear-gradient(to top, rgba(9,10,18,.92), rgba(9,10,18,.6));
      border-top:1px solid rgba(255,255,255,.07);padding:10px 8px calc(12px + env(safe-area-inset-bottom));display:grid;grid-template-columns:repeat(6,1fr);gap:8px;z-index:60}
    .nav button{border:none;background:none;color:var(--muted);display:flex;flex-direction:column;gap:4px;align-items:center;padding:8px 6px;border-radius:10px;font-size:11px}
    .nav button.active{color:var(--brand);background:rgba(122,162,255,.16)}
    .fab{position:fixed;right:16px;bottom:calc(88px + env(safe-area-inset-bottom));width:60px;height:60px;border-radius:50%;display:grid;place-items:center;border:none;cursor:pointer;
      background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 160deg, var(--brand) 360deg); color:white;
      box-shadow:0 20px 56px rgba(122,162,255,.6);z-index:55}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.62);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:80}
    .modal__card{width:min(92vw,460px);max-height:84vh;overflow:auto;border-radius:18px;border:1px solid rgba(255,255,255,.09);background:var(--card);padding:18px}
    .modal__head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .modal__title{font-weight:900}.close{border:none;background:none;color:var(--muted);font-size:20px;cursor:pointer}
    .label{font-size:13px;color:var(--muted);margin:8px 0}
    .input,.textarea,select{width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,.09);background:#0f1324;color:var(--text)}
    .textarea{min-height:120px;resize:vertical}
    .submit{width:100%;margin-top:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat{background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);
      border-radius:16px;padding:16px;text-align:center}
    .stat .v{font-size:20px;font-weight:900}.muted{color:var(--muted)}
    .pool{margin:16px 0;padding:16px;border-radius:18px;border:1px solid rgba(67,214,163,.4);
      background:linear-gradient(180deg, rgba(67,214,163,.2), rgba(67,214,163,.05))}
    .tabs{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    .tab{padding:8px 10px;border:1px solid rgba(255,255,255,.09);border-radius:10px;background:rgba(255,255,255,.04);cursor:pointer;color:var(--muted);font-weight:800}
    .tab.active{color:var(--brand);box-shadow:var(--ring)}
    .toast{position:fixed;right:16px;top:86px;z-index:90;display:grid;gap:8px}
    .toast .t{padding:12px 14px;border-radius:12px;color:#0b0b0f;font-weight:900}
    .t.ok{background:#43d6a3}.t.err{background:#ff7f88}.t.info{background:#7aa2ff}
    @media(hover:hover){::-webkit-scrollbar{height:10px;width:10px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:10px}::-webkit-scrollbar-track{background:transparent}}
  </style>
</head>
<body>

  <!-- ===== Telegram-only Gate (обязателен) ===== -->
  <script>
    (function telegramOnlyGate(){
      const tg = window.Telegram?.WebApp;
      // Подставляем ник бота (без @). Если вдруг вставили с @ — уберём.
      let BOT = 't11stMini_bot';
      if (BOT.startsWith('@')) BOT = BOT.slice(1);

      if(!tg || !tg.initDataUnsafe?.user){
        const deepLink = `https://t.me/${BOT}?startapp=go`;
        document.body.innerHTML = `
          <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;
              background:#0b0b0f;color:#f2f4f8;font-family:-apple-system,BlinkMacSystemFont,Inter,Roboto,Segoe UI,Arial,sans-serif;
              text-align:center;padding:24px">
            <div style="max-width:520px;background:#141622;border:1px solid rgba(255,255,255,.08);
                border-radius:16px;padding:24px">
              <div style="font-size:22px;font-weight:900;margin-bottom:8px">Откройте через Telegram</div>
              <div style="color:#99a2b3;margin-bottom:16px">Это мини-приложение доступно только внутри Telegram. Нажмите кнопку ниже.</div>
              <a href="${deepLink}" style="display:inline-block;padding:12px 16px;border-radius:12px;
                  background:linear-gradient(135deg,#7aa2ff,#a276ff);color:white;font-weight:900;text-decoration:none">
                Открыть в Telegram
              </a>
              <div style="color:#99a2b3;font-size:12px;margin-top:10px">t.me/${BOT}</div>
            </div>
          </div>`;
        window.__STOP_APP__ = true;
        return;
      }
      window.__STOP_APP__ = false;
      try{ tg.ready(); tg.expand(); tg.disableVerticalSwipes?.(); }catch(e){}
    })();
  </script>

  <div class="toast" id="toast"></div>

  <header class="header">
    <div class="container">
      <div class="header-row">
        <div class="brand">
          <div class="logo"><i class="fa-solid fa-gem"></i></div>
          <div>
            <div class="title">Diamond Feed</div>
            <div class="hint">Эпоха заканчивается в <span id="epoch-utc">00:00 UTC</span> • осталось <span id="epoch-eta">--:--:--</span> • онлайн друзей: <span id="friends-online">0</span></div>
          </div>
        </div>
        <div class="kpis">
          <div class="pill"><i class="fa-solid fa-trophy"></i> <span id="points-pill">0 RAW / 0 EFF</span></div>
          <div class="pill"><i class="fa-solid fa-sack-dollar"></i> <span id="reward-pill">~0 💎</span></div>
          <div class="pill"><i class="fa-solid fa-gem"></i> <span id="balance-pill">0</span></div>
        </div>
      </div>
    </div>
    <div class="epochbar"><span id="epoch-progress"></span></div>
  </header>

  <main class="container">
    <section class="pinned" id="pinned" style="display:none">
      <div class="pinned__card">
        <div class="pinned__head">
          <div class="pinned__label"><i class="fa-solid fa-thumbtack"></i> Закреплено • <span id="pin-author">—</span></div>
          <div class="pinned__timer"><i class="fa-regular fa-clock"></i> <span id="pin-timer">01:00</span></div>
        </div>
        <div class="pinned__body">
          <div id="pin-text" class="content"></div>
          <div class="pinned__meta"><span><i class="fa-regular fa-eye"></i> <span id="pin-views">0</span></span>
            <span><i class="fa-regular fa-heart"></i> <span id="pin-likes">0</span></span></div>
          <div class="queue" id="pin-queue" style="display:none"><i class="fa-solid fa-list-ol"></i> В очереди: <span id="queue-len">0</span> • <span id="queue-list"></span></div>
          <div id="pin-cta" style="margin-top:10px"></div>
        </div>
      </div>
    </section>

    <section id="feed-section" class="section active">
      <div class="tabs" id="feed-tabs">
        <!-- По умолчанию активна вкладка "Все", чтобы свой пост был виден сразу -->
        <button class="tab" data-filter="friends"><i class="fa-solid fa-user-group"></i> Друзья</button>
        <button class="tab active" data-filter="all"><i class="fa-solid fa-globe"></i> Все</button>
      </div>
      <div id="feed"></div>
      <div class="empty" id="feed-empty" style="display:none">
        <i class="fa-regular fa-newspaper" style="font-size:42px"></i>
        <div style="margin-top:8px">Здесь будут посты. Нажмите «+» и опубликуйте первый пост.</div>
      </div>
    </section>

    <section id="lb-section" class="section">
      <div class="tabs">
        <button class="tab active" data-epoch="current">Сегодня</button>
        <button class="tab" data-epoch="prev">Вчера</button>
      </div>
      <div id="leaderboard"></div>
    </section>

    <section id="profile-section" class="section">
      <div class="card">
        <div class="row">
          <div class="user">
            <div class="avatar" id="pf-avatar">U</div>
            <div>
              <div class="name" id="pf-name">Пользователь</div>
              <div class="meta" id="pf-id">ID: —</div>
              <div class="meta"><i class="fa-solid fa-shield"></i> Подтвержден через Telegram</div>
            </div>
          </div>
          <div><button class="btn" id="btn-friends"><i class="fa-solid fa-user-plus"></i> Друзья</button></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div class="stat"><div class="v" id="pf-diamonds">0</div><div class="muted">Алмазов</div></div>
          <div class="stat"><div class="v" id="pf-posts">0</div><div class="muted">Постов</div></div>
          <div class="stat"><div class="v" id="pf-reads">0</div><div class="muted">Прочтений (RAW)</div></div>
          <div class="stat"><div class="v" id="pf-reacts">0</div><div class="muted">Реакций (RAW)</div></div>
          <div class="stat"><div class="v" id="pf-raw">0</div><div class="muted">Баллы (RAW)</div></div>
          <div class="stat"><div class="v" id="pf-eff">0</div><div class="muted">Баллы (EFF)</div></div>
        </div>
        <div class="pool"><div style="font-weight:900">Оценочная награда сегодня</div>
          <div class="name" id="pf-est">~0 💎</div><div class="muted">Прогноз при текущем пуле</div></div>
      </div>
    </section>

    <section id="pool-section" class="section">
      <div class="pool"><div class="name">Текущий пул: <span id="pool-amount">0</span> 💎</div>
        <div class="muted">Участников (>= MIN_POINTS): <span id="pool-part">0</span></div></div>
      <div class="card"><div class="name">Математика распределения</div>
        <div class="muted" style="margin-top:6px">Доля = Ваши баллы / ΣБаллов • Выплата = Пул × Доля • Округление до 0.01, «пыль» переносится</div></div>
    </section>
  </main>

  <nav class="nav">
    <button class="active" data-go="feed-section"><i class="fa-solid fa-home"></i><span>Лента</span></button>
    <button data-go="lb-section"><i class="fa-solid fa-ranking-star"></i><span>Топ</span></button>
    <button data-go="profile-section"><i class="fa-solid fa-user"></i><span>Профиль</span></button>
    <button data-go="pool-section"><i class="fa-solid fa-coins"></i><span>Пул</span></button>
    <button id="open-store"><i class="fa-solid fa-store"></i><span>Магазин</span></button>
    <button id="open-friends"><i class="fa-solid fa-user-group"></i><span>Друзья</span></button>
  </nav>

  <button class="fab" id="create-btn"><i class="fa-solid fa-plus"></i></button>

  <!-- Modals -->
  <div class="modal" id="modal-create"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Создать пост</div><button class="close" data-close>&times;</button></div>
    <label class="label">Текст (до 500 символов, без ссылок)</label>
    <textarea id="post-text" class="textarea" maxlength="500" placeholder="Поделитесь чем-то интересным…"></textarea>
    <button id="post-submit" class="btn submit">Опубликовать за 10 💎</button>
    <div class="muted" style="margin-top:6px">Будет списано 10 алмазов</div>
  </div></div>

  <div class="modal" id="modal-boost"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Буст поста</div><button class="close" data-close>&times;</button></div>
    <div class="label">Поднять пост в топ за 10 💎? (кулдаун 5 минут)</div>
    <button id="boost-confirm" class="btn submit">Поднять за 10 💎</button>
    <div class="muted" id="boost-hint"></div>
  </div></div>

  <div class="modal" id="modal-pin"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Закрепить пост</div><button class="close" data-close>&times;</button></div>
    <div class="label">1 минута закрепа = 100 💎. Если слот занят — ваш пост встанет в очередь FIFO. Повторные покупки продлевают время.</div>
    <button id="pin-confirm" class="btn submit">В очередь / Закрепить за 100 💎</button>
    <div class="muted">Списывается 100 алмазов за каждую минуту</div>
  </div></div>

  <div class="modal" id="modal-store"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Покупка алмазов</div><button class="close" data-close>&times;</button></div>
    <label class="label">Способ оплаты</label>
    <select id="pay-method"><option value="stars">Telegram Stars (iOS)</option><option value="ton">TON (Android/Desktop)</option></select>
    <div class="grid" style="margin-top:10px">
      <button class="btn" data-pack="100">100 💎 • ~1 TON</button>
      <button class="btn" data-pack="500">500 💎 • ~5 TON</button>
      <button class="btn" data-pack="1000">1000 💎 • ~10 TON</button>
      <button class="btn" data-pack="5000">5000 💎 • ~50 TON</button>
    </div>
    <div class="muted" style="margin-top:8px">Демо-оплата: средства зачисляются мгновенно (эмуляция)</div>
  </div></div>

  <div class="modal" id="modal-friends"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Друзья</div><button class="close" data-close>&times;</button></div>
    <div class="label">Добавить по User ID или @username</div>
    <div style="display:flex;gap:8px">
      <input id="friend-input" class="input" placeholder="например, 123456 или @username" />
      <button class="btn" id="friend-add">Добавить</button>
    </div>
    <div class="grid" style="margin-top:12px">
      <div class="stat" style="text-align:left">
        <div class="name">Вы подписаны</div><div id="following-list" class="muted" style="margin-top:6px"></div>
      </div>
      <div class="stat" style="text-align:left">
        <div class="name">Подписчики</div><div id="followers-list" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
    <div class="muted" style="margin-top:8px"><i class="fa-solid fa-circle-info"></i> В ленте «Друзья» показываются посты тех, на кого вы подписаны.</div>
  </div></div>

  <div class="modal" id="modal-report"><div class="modal__card">
    <div class="modal__head"><div class="modal__title">Пожаловаться</div><button class="close" data-close>&times;</button></div>
    <label class="label">Категория</label>
    <select id="report-type"><option>Спам</option><option>NSFW</option><option>Мошенничество</option><option>Оскорбления</option></select>
    <button id="report-send" class="btn submit">Отправить жалобу</button>
    <div class="muted">Жалоба отправится модераторам (демо)</div>
  </div></div>

  <script>
  if(!window.__STOP_APP__){
  /* === THEME === */
  function applyTelegramTheme(){
    try{
      const tp = Telegram?.WebApp?.themeParams || {};
      const set=(k,v)=> v && document.documentElement.style.setProperty(k,v);
      set('--bg',tp.bg_color); set('--bg-2',tp.secondary_bg_color);
      set('--card',tp.secondary_bg_color); set('--text',tp.text_color);
      set('--muted',tp.hint_color); set('--brand',tp.button_color);
    }catch(e){}
  }

  /* === ECONOMY / EPOCH === */
  const ECONOMY=Object.freeze({
    COST_POST:10, COST_BOOST:10, COST_PIN_PER_MIN:100,
    BOOST_COOLDOWN_MS:5*60*1000, POOL_SHARE:1.0, PLATFORM_FEE:0,
    MIN_POINTS:5, CAPS:{ READS:200, REACTS:100, PER_AUTHOR:20 }
  });
  const now=()=>new Date();
  const toUtcYMD=(d=now())=> new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString().slice(0,10);
  const epochEndsAt=()=> new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate()+1,0,0,0));
  const fmtClock=(ms)=>{ if(ms<0) ms=0; const s=Math.floor(ms/1000);
    const h=String(Math.floor(s/3600)).padStart(2,'0');
    const m=String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}` }

  /* === REALTIME (BC + Ably) === */
  const RT = (()=>{
    const listeners=new Set();
    const bc=('BroadcastChannel' in window)? new BroadcastChannel('diamond-feed-rt'):null;
    if(bc) bc.onmessage=(e)=> listeners.forEach(fn=> fn(e.data));

    let ably=null, chan=null;
    const qs=new URLSearchParams(location.search);
    const ablyKey=qs.get('ably'); const channelName=qs.get('chan')||'diamond-feed';

    async function initAbly(){
      if(!ablyKey || !window.Ably) return;
      try{
        ably = new Ably.Realtime.Promise(ablyKey);
        chan = ably.channels.get(channelName);
        chan.subscribe((msg)=>{
          const data = msg.data && msg.data.type ? msg.data : { type: msg.name, payload: msg.data, ts: Date.now() };
          listeners.forEach(fn=> fn(data));
        });
        try{
          const page = await chan.history({limit:100});
          const items = page?.items||[];
          for(let i=items.length-1;i>=0;i--){
            const m=items[i]; const data = m.data && m.data.type ? m.data : { type:m.name, payload:m.data, ts: Date.parse(m.timestamp) || Date.now() };
            listeners.forEach(fn=> fn(data));
          }
        }catch(e){}
      }catch(e){ console.warn('Ably init failed',e); }
    }
    initAbly();

    return {
      send:(type,payload)=>{
        const msg={type,payload,ts:Date.now()};
        if(chan){ try{ chan.publish(type,msg); }catch(e){} }
        if(bc) bc.postMessage(msg);
      },
      on:(fn)=> listeners.add(fn)
    };
  })();

  /* === STATE === */
  let state={
    users:{}, currentUserId:null, posts:[],
    interactions:{}, daily:{}, points:{}, trust:{},
    pool:{ amount:0, dust:0, participants:0, epoch:toUtcYMD(), endsAt:epochEndsAt() },
    pin:{ active:null, queue:[] },
    transactions:{}, moderation:{ reports:[] },
    social:{ following:{}, followers:{} },
    presence:{},
    ui:{ currentPostId:null, feedFilter:'all' } // по умолчанию "Все"
  };

  const save=()=> localStorage.setItem('diamond-feed-v171', JSON.stringify(state, (k,v)=> v instanceof Date ? {__t:'d',v:v.toISOString()}: v));
  const revive=(o)=>{ if(!o||typeof o!=='object') return o; if(o.__t==='d') return new Date(o.v); for(const k of Object.keys(o)) o[k]=revive(o[k]); return o; };
  const load=()=> { const raw=localStorage.getItem('diamond-feed-v171'); if(!raw) return false; try{ state=revive(JSON.parse(raw)); return true; }catch(e){ console.warn(e); return false; } };

  function ensureSets(){
    const F=state.social.following, R=state.social.followers;
    for(const uid of Object.keys(F)) if(!(F[uid] instanceof Set)) F[uid]=new Set(F[uid]);
    for(const uid of Object.keys(R)) if(!(R[uid] instanceof Set)) R[uid]=new Set(R[uid]);
  }

  /* === Strict Telegram user === */
  function initUser(){
    const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
    if(!u) throw new Error('No Telegram user');
    const id=String(u.id);
    if(!state.users[id]){
      state.users[id]={ id,
        firstName:u.first_name||'User', lastName:u.last_name||'',
        username:u.username||('user'+id), isPremium:!!u.is_premium, diamonds:250
      };
      state.trust[id]=1.0;
    }
    state.currentUserId=id;
    state.social.following[id] ||= new Set();
    state.social.followers[id] ||= new Set();
  }

  /* === Presence / Friends === */
  function pingPresence(){ const uid=state.currentUserId; state.presence[uid]=Date.now(); RT.send('presence:ping',{ uid }); }
  function isOnline(uid){ const last=state.presence[uid]||0; return Date.now()-last<30000; }
  function follow(me,target){
    if(me===target) return false;
    state.social.following[me] ||= new Set(); state.social.followers[target] ||= new Set();
    if(state.social.following[me].has(target)) return false;
    state.social.following[me].add(target); state.social.followers[target].add(me);
    save(); renderFriendsModal(); renderFeed(); toast('Добавлен в друзья');
    RT.send('social:follow',{from:me,to:target}); return true;
  }
  function unfollow(me,target){
    if(!state.social.following[me]?.has(target)) return false;
    state.social.following[me].delete(target); state.social.followers[target]?.delete(me);
    save(); renderFriendsModal(); renderFeed(); toast('Удалён из друзей','info');
    RT.send('social:unfollow',{from:me,to:target}); return true;
  }
  function isFollowing(me,target){ return !!state.social.following[me]?.has(target); }

  /* === Economy === */
  function spendDiamonds(userId,amount,meta){
    const u=state.users[userId]; if(!u||u.diamonds<amount) return false;
    u.diamonds-=amount;
    const toPool=Math.floor(amount*ECONOMY.POOL_SHARE*(1-ECONOMY.PLATFORM_FEE));
    state.pool.amount+=toPool;
    (state.transactions[userId] ||= []).push({type:'spend',amount,meta,at:now()});
    return true;
  }
  function publishPost(authorId,text){
    const post={ id:String(Date.now()+Math.random()), authorId, text, createdAt:now(), views:0, likes:0, boostedAt:null };
    state.posts.unshift(post); return post;
  }
  function createPostFlow(){
    const text=document.getElementById('post-text').value.trim();
    if(!text){ toast('Введите текст поста','err'); return; }
    if(/https?:\/\//i.test(text)){ toast('Ссылки запрещены в MVP','err'); return; }
    if(text.length>500){ toast('Слишком длинно','err'); return; }
    if(!spendDiamonds(state.currentUserId, ECONOMY.COST_POST, {op:'post'})){ toast('Недостаточно алмазов','err'); openStore(); return; }
    const p=publishPost(state.currentUserId,text);
    closeModal('modal-create'); document.getElementById('post-text').value='';
    renderAll(); save(); toast('Пост опубликован!'); RT.send('post:new',{ post: serializePost(p) }); haptic('success');
  }
  function openBoost(postId){
    state.ui.currentPostId=postId;
    const post=state.posts.find(p=>p.id===postId);
    const cdLeft=post?.boostedAt?(post.boostedAt.getTime()+ECONOMY.BOOST_COOLDOWN_MS - now().getTime()):0;
    byId('boost-hint').textContent=cdLeft>0?`Доступно через ${fmtClock(cdLeft)}`:'';
    showModal(byId('modal-boost'));
  }
  function doBoost(){
    const post=state.posts.find(p=>p.id===state.ui.currentPostId); if(!post) return;
    if(post.authorId!==state.currentUserId){ toast('Бустить может только автор','err'); return; }
    const cdLeft=post.boostedAt?(post.boostedAt.getTime()+ECONOMY.BOOST_COOLDOWN_MS - now().getTime()):0;
    if(cdLeft>0){ toast('Рано: кулдаун 5 минут','err'); return; }
    if(!spendDiamonds(state.currentUserId, ECONOMY.COST_BOOST, {op:'boost',postId:post.id})){ toast('Недостаточно алмазов','err'); closeModal('modal-boost'); openStore(); return; }
    post.boostedAt=now(); closeModal('modal-boost'); renderAll(); save(); toast('Пост поднят в топ');
    RT.send('post:boost',{ id:post.id, boostedAt:post.boostedAt.toISOString() }); haptic('success');
  }
  function openPin(postId){ state.ui.currentPostId=postId; showModal(byId('modal-pin')); }
  function doPin(){
    const postId=state.ui.currentPostId; const post=state.posts.find(p=>p.id===postId); if(!post) return;
    if(post.authorId!==state.currentUserId){ toast('Закрепляет только автор','err'); return; }
    if(!spendDiamonds(state.currentUserId, ECONOMY.COST_PIN_PER_MIN, {op:'pin',postId})){ toast('Недостаточно алмазов','err'); closeModal('modal-pin'); openStore(); return; }
    const plusMs=60*1000;
    if(state.pin.active && state.pin.active.postId===postId){ state.pin.active.endsAt=new Date(state.pin.active.endsAt.getTime()+plusMs); }
    else if(state.pin.queue.length && state.pin.queue[state.pin.queue.length-1].postId===postId){ state.pin.queue[state.pin.queue.length-1].minutes+=1; }
    else if(!state.pin.active){ state.pin.active={ postId, endsAt:new Date(now().getTime()+plusMs) } }
    else { state.pin.queue.push({ postId, userId:state.currentUserId, minutes:1, enqueuedAt:now() }); }
    closeModal('modal-pin'); renderAll(); save(); toast('Покупка закрепа успешна'); RT.send('pin:update', serializePin()); haptic('success');
  }
  function serializePin(){
    return { active: state.pin.active? { postId:state.pin.active.postId, endsAt:state.pin.active.endsAt.toISOString() }:null,
             queue: state.pin.queue.map(q=> ({...q, enqueuedAt:q.enqueuedAt.toISOString()})) };
  }
  function pinTicker(){
    if(!state.pin.active) return;
    const left=state.pin.active.endsAt.getTime()-now().getTime();
    if(left<=0){
      const next=state.pin.queue.shift();
      if(next){ state.pin.active={ postId:next.postId, endsAt:new Date(now().getTime()+next.minutes*60*1000) } }
      else { state.pin.active=null }
      renderAll(); save(); RT.send('pin:update', serializePin());
    }
  }

  /* === Points === */
  const readWatch=new Map(); let visibilityOk=document.visibilityState==='visible';
  window.addEventListener('visibilitychange',()=> visibilityOk=document.visibilityState==='visible');
  window.addEventListener('focus',()=> visibilityOk=true); window.addEventListener('blur',()=> visibilityOk=false);
  function ensureEpochStructures(ep){
    state.interactions[ep] ||= {}; state.daily[ep] ||= {}; state.points[ep] ||= {};
    const uid=state.currentUserId; state.interactions[ep][uid] ||= {};
    state.daily[ep][uid] ||= { reads:0, reacts:0, perAuthor:{} };
    state.points[ep][uid] ||= { reads:0, reacts:0, raw:0, eff:0 };
  }
  function grantRead(post){
    const ep=state.pool.epoch; ensureEpochStructures(ep);
    const uid=state.currentUserId; const authorId=post.authorId; if(authorId===uid) return;
    const caps=state.daily[ep][uid]; if(caps.reads>=ECONOMY.CAPS.READS) return;
    const fromAuthor=(caps.perAuthor[authorId]||0); if(fromAuthor>=ECONOMY.CAPS.PER_AUTHOR) return;
    const inter=state.interactions[ep][uid][post.id] ||= { read:false, react:false }; if(inter.read) return;
    inter.read=true; caps.reads+=1; caps.perAuthor[authorId]=fromAuthor+1;
    const p=state.points[ep][uid]; p.reads+=1; p.raw+=1; p.eff=Math.round(p.raw*(state.trust[uid]||1.0));
    post.views+=1; save(); renderHUD();
  }
  function grantReact(post){
    const ep=state.pool.epoch; ensureEpochStructures(ep);
    const uid=state.currentUserId; const authorId=post.authorId; if(authorId===uid) return;
    const caps=state.daily[ep][uid]; if(caps.reacts>=ECONOMY.CAPS.REACTS) return;
    const fromAuthor=(caps.perAuthor[authorId]||0); if(fromAuthor>=ECONOMY.CAPS.PER_AUTHOR) return;
    const inter=state.interactions[ep][uid][post.id] ||= { read:false, react:false }; if(inter.react) return;
    inter.react=true; caps.reacts+=1; caps.perAuthor[authorId]=fromAuthor+1;
    const p=state.points[ep][uid]; p.reacts+=1; p.raw+=3; p.eff=Math.round(p.raw*(state.trust[uid]||1.0));
    post.likes+=1; save(); renderAll(); toast('+3 балла!','ok'); RT.send('post:stats',{ id:post.id, likes:post.likes, views:post.views }); haptic('impact');
  }
  function attachReadObserver(){
    const io=new IntersectionObserver((entries)=>{
      for(const e of entries){
        const el=e.target; const postId=el.dataset.postId; const half=e.intersectionRatio>=.5;
        if(half){ readWatch.set(postId,{ seenAt:now() }); } else { readWatch.delete(postId); }
      }
    },{threshold:[0,.5,1]});
    document.querySelectorAll('.card[data-post-id]').forEach(el=> io.observe(el));
    setInterval(()=>{
      if(!visibilityOk) return;
      for(const [postId,ctx] of readWatch){
        if(now().getTime()-ctx.seenAt.getTime()>=2000){
          const post=state.posts.find(p=>p.id===postId);
          if(post){ grantRead(post); readWatch.delete(postId); }
        }
      }
    },600);
  }

  /* === Settlement (epoch close) === */
  function settlementTick(){
    if(now().getTime()<state.pool.endsAt.getTime()) return;
    const ep=state.pool.epoch; const nextEp=toUtcYMD(new Date(state.pool.endsAt));
    const points=state.points[ep]||{};
    const eligible=Object.entries(points).filter(([uid,p])=> (p.eff||0)>ECONOMY.MIN_POINTS);
    const sumEff=eligible.reduce((s,[,p])=> s+(p.eff||0),0);
    let poolTotal=state.pool.amount+(state.pool.dust||0);
    const payouts=[]; let used=0;
    if(sumEff>0 && poolTotal>0){
      for(const [uid,p] of eligible){
        const share=p.eff/sumEff; let amt=poolTotal*share; amt=Math.floor(amt*100)/100; used+=amt; payouts.push([uid,amt]);
      }
    }
    const dust=Math.max(0, poolTotal-used);
    for(const [uid,amt] of payouts){
      state.users[uid].diamonds=(state.users[uid].diamonds||0)+amt;
      (state.transactions[uid] ||= []).push({type:'reward', amount:amt, meta:{epoch:ep}, at:now()});
    }
    state.pool={ amount:0, dust, participants:0, epoch:nextEp, endsAt:epochEndsAt() };
    renderAll(); save(); toast('Эпоха закрыта. Выплаты начислены.','ok');
  }

  /* === RENDER === */
  const byId=(id)=> document.getElementById(id);
  function renderHUD(){
    const uid=state.currentUserId; const user=state.users[uid];
    const ep=state.pool.epoch; const P=state.points[ep]?.[uid] || {raw:0,eff:0};
    byId('balance-pill').textContent=user.diamonds;
    byId('points-pill').textContent=`${P.raw||0} RAW / ${P.eff||0} EFF`;
    const est=estimateReward(uid); byId('reward-pill').textContent=`~${est} 💎`;
    byId('epoch-utc').textContent='24:00 UTC';
    const totalMs=24*3600*1000; const leftMs=state.pool.endsAt.getTime()-now().getTime();
    byId('epoch-eta').textContent=fmtClock(leftMs);
    byId('epoch-progress').style.width=`${Math.max(0, Math.min(1, 1-(leftMs/totalMs)))*100}%`;
    const following=state.social.following[uid]||new Set(); let count=0; for(const f of following){ if(isOnline(f)) count++; } byId('friends-online').textContent=count;
    byId('pf-avatar').textContent=avatarText(user); byId('pf-name').textContent=displayName(user); byId('pf-id').textContent=`ID: ${user.id}`;
    byId('pf-diamonds').textContent=user.diamonds;
    const stats=state.points[ep]?.[uid] || {reads:0,reacts:0,raw:0,eff:0};
    byId('pf-reads').textContent=stats.reads||0; byId('pf-reacts').textContent=stats.reacts||0; byId('pf-raw').textContent=stats.raw||0; byId('pf-eff').textContent=stats.eff||0;
    byId('pf-posts').textContent=state.posts.filter(p=>p.authorId===uid).length; byId('pf-est').textContent=`~${est} 💎`;
    byId('pool-amount').textContent=(state.pool.amount+(state.pool.dust||0)).toFixed(2);
    const eligible=Object.values(state.points[ep]||{}).filter(p=> (p.eff||0)>ECONOMY.MIN_POINTS).length; byId('pool-part').textContent=eligible;
    renderFriendsLists();
  }
  function estimateReward(uid){
    const ep=state.pool.epoch; const userEff=state.points[ep]?.[uid]?.eff || 0;
    const sumEff=Object.values(state.points[ep]||{}).reduce((s,p)=> s+(p.eff||0),0);
    if(userEff<=0 || sumEff<=0) return 0;
    const total=state.pool.amount+(state.pool.dust||0);
    return Math.floor((total*(userEff/sumEff))*100)/100;
  }
  function sortPosts(){
    return [...state.posts].sort((a,b)=>{
      const ab=b.boostedAt? b.boostedAt.getTime():0; const aa=a.boostedAt? a.boostedAt.getTime():0;
      if(ab!==aa) return ab-aa; return b.createdAt.getTime()-a.createdAt.getTime();
    });
  }
  function avatarText(u){ return (u.firstName||u.username||'U').slice(0,1).toUpperCase() }
  function displayName(u){ return u.firstName && u.lastName ? `${u.firstName} ${u.lastName}` : (u.firstName || `@${u.username}`) }
  function renderFeed(){
    const list=byId('feed'); const itemsAll=sortPosts(); const uid=state.currentUserId;
    const following=state.social.following[uid]||new Set();
    const filter=state.ui.feedFilter;
    const items = filter==='friends' ? itemsAll.filter(p=> p.authorId===uid || following.has(p.authorId)) : itemsAll;
    list.innerHTML = items.map((p,idx)=>{
      const author=state.users[p.authorId]||{firstName:'User'}; const isMine=p.authorId===uid;
      const liked=!!(state.interactions[state.pool.epoch]?.[uid]?.[p.id]?.react);
      const canBoost=isMine; const cdLeft=p.boostedAt?(p.boostedAt.getTime()+ECONOMY.BOOST_COOLDOWN_MS - now().getTime()):0;
      const followBtn=(!isMine && !isFollowing(uid,p.authorId))? `<button class="btn" onclick="follow('${uid}','${p.authorId}')"><i class='fa-solid fa-user-plus'></i> В друзья</button>`:'';
      const onlineDot = isOnline(p.authorId)? '<span class="dot online"></span>':'';
      return `
      <article class="card" data-post-id="${p.id}" style="animation-delay:${Math.min(idx*40,240)}ms">
        <div class="row">
          <div class="user">
            <div class="avatar">${avatarText(author)}${onlineDot}</div>
            <div>
              <div class="name">${displayName(author)} ${author.isPremium?'<i class="fa-solid fa-star" style="color:var(--ok)"></i>':''} ${isMine?'<span class="muted">(Вы)</span>':''}</div>
              <div class="meta">${p.createdAt.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})} ${p.boostedAt? ' • <span class="badge rocket"><i class="fa-solid fa-rocket"></i> Boost</span>':''}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px">${followBtn}<button class="btn" onclick="openReport('${p.id}')" title="Пожаловаться"><i class="fa-solid fa-flag"></i></button></div>
        </div>
        <div class="content">${escapeHtml(p.text)}</div>
        <div class="stats"><span><i class="fa-regular fa-eye"></i> ${p.views}</span><span><i class="fa-regular fa-heart"></i> ${p.likes}</span></div>
        <div class="actions">
          <button class="btn like ${liked?'liked':''}" ${isMine?'disabled':''} onclick="react(event,'${p.id}')"><span class="burst"></span><i class="${liked?'fa-solid':'fa-regular'} fa-heart"></i> Лайк</button>
          <button class="btn" ${!canBoost?'disabled':''} onclick="openBoost('${p.id}')"><i class="fa-solid fa-rocket"></i> Буст ${cdLeft>0?`(${fmtClock(cdLeft)})`:''}</button>
          <button class="btn" ${!isMine?'disabled':''} onclick="openPin('${p.id}')"><i class="fa-solid fa-thumbtack"></i> Закреп</button>
        </div>
      </article>`;
    }).join('');
    byId('feed-empty').style.display = items.length? 'none':'block';
    attachReadObserver(); renderPinned();
  }
  function renderPinned(){
    const slot=byId('pinned'); if(!state.pin.active){ slot.style.display='none'; byId('pin-cta').innerHTML=''; return; }
    const p=state.posts.find(x=> x.id===state.pin.active.postId); if(!p){ slot.style.display='none'; return; }
    const author=state.users[p.authorId]||{firstName:'User'}; slot.style.display='block';
    byId('pin-author').textContent=displayName(author); byId('pin-text').textContent=p.text;
    byId('pin-views').textContent=p.views; byId('pin-likes').textContent=p.likes;
    const hasQ=state.pin.queue.length>0; byId('pin-queue').style.display=hasQ? 'flex':'none';
    byId('queue-len').textContent=state.pin.queue.length;
    if(hasQ){ const items=state.pin.queue.map(q=> `${displayName(state.users[q.userId]||{firstName:'?'})}×${q.minutes}`).join(', '); const el=document.getElementById('queue-list'); if(el) el.textContent=items; }
    const left=state.pin.active.endsAt.getTime()-now().getTime(); byId('pin-timer').textContent=fmtClock(left);
    if(p.authorId===state.currentUserId){ byId('pin-cta').innerHTML = `<button class="btn" onclick="openPin('${p.id}')"><i class='fa-solid fa-plus'></i> Продлить 1 мин за 100 💎</button>` } else { byId('pin-cta').innerHTML='' }
  }
  function renderLeaderboard(which=getActiveLbTab()){
    const lb=byId('leaderboard');
    const ep = which==='current'? state.pool.epoch : toUtcYMD(new Date(Date.parse(state.pool.epoch)+24*3600*1000-1));
    const entries=Object.entries(state.points[ep]||{}).map(([uid,p])=>({uid,p})).filter(x=> (x.p.eff||0)>0).sort((a,b)=> (b.p.eff||0)-(a.p.eff||0)).slice(0,100);
    lb.innerHTML = entries.map((x,i)=>{
      const u=state.users[x.uid]||{firstName:'User'}; const est = which==='current'? estimateReward(x.uid): 0;
      return `<div class="card"><div class="user"><div class="avatar" style="background:${rankBg(i+1)}">${i+1}</div><div style="margin-left:8px">
        <div class="name">${displayName(u)} ${x.uid===state.currentUserId?'<span class="muted">(Вы)</span>':''}</div>
        <div class="meta">${x.p.eff} баллов • ${which==='current'?`~${est} 💎`:'прошлая эпоха'}</div></div></div></div>`;
    }).join('') || `<div class="empty">Рейтинг пуст</div>`;
  }
  function rankBg(r){ return r===1? 'linear-gradient(135deg,#FFD700,#FFA500)' : r===2? 'linear-gradient(135deg,#C0C0C0,#A0A0A0)' : r===3? 'linear-gradient(135deg,#CD7F32,#A0522D)' : 'linear-gradient(135deg,var(--brand),var(--brand-2))' }
  function renderAll(){ renderHUD(); renderFeed(); renderLeaderboard(getActiveLbTab()); }
  function renderFriendsLists(){
    const uid=state.currentUserId;
    const flw=[...(state.social.following[uid]||new Set())].map(id=> displayName(state.users[id]||{firstName:'?'}) + ` <a href='#' onclick="unfollow('${uid}','${id}');return false">(удалить)</a>`).join('<br/>') || '—';
    const frs=[...(state.social.followers[uid]||new Set())].map(id=> displayName(state.users[id]||{firstName:'?'}) ).join('<br/>') || '—';
    const f=byId('following-list'); const fr=byId('followers-list'); if(f) f.innerHTML=flw; if(fr) fr.innerHTML=frs;
  }

  /* === UI helpers === */
  function react(evt,postId){ const post=state.posts.find(p=>p.id===postId); if(!post) return; grantReact(post); if(evt && evt.currentTarget){ heartBurst(evt.currentTarget); } }
  function openReport(postId){ state.ui.currentPostId=postId; showModal(byId('modal-report')); }
  function sendReport(){ const type=byId('report-type').value; state.moderation.reports.push({postId:state.ui.currentPostId, type, at:now()}); save(); closeModal('modal-report'); toast('Жалоба отправлена','info'); }
  function openStore(){ showModal(byId('modal-store')); }
  function buyPack(amount){ const uid=state.currentUserId; state.users[uid].diamonds+=amount; (state.transactions[uid] ||= []).push({type:'purchase', amount, meta:{method:byId('pay-method').value}, at:now()}); save(); renderHUD(); closeModal('modal-store'); toast(`Куплено ${amount} 💎`,'ok'); haptic('success'); }
  function heartBurst(btn){ const burst=btn.querySelector('.burst'); if(!burst) return; for(let i=0;i<4;i++){ const el=document.createElement('div'); el.className='heart'; el.style.left=(35+Math.random()*30)+'%'; el.style.animationDelay=(i*60)+'ms'; el.innerHTML='<i class="fa-solid fa-heart"></i>'; burst.appendChild(el); setTimeout(()=> el.remove(), 800); } }
  function haptic(type){ try{ const h=Telegram?.WebApp?.HapticFeedback; if(!h) return; if(type==='success') h.notificationOccurred('success'); else if(type==='impact') h.impactOccurred('medium'); }catch(e){} }
  function showModal(el){ el.style.display='flex'; } function closeModal(id){ byId(id).style.display='none'; }
  function toast(msg,kind='ok'){ const t=document.createElement('div'); t.className=`t ${kind==='err'?'err':kind==='info'?'info':'ok'}`; t.textContent=msg; byId('toast').appendChild(t); setTimeout(()=> t.remove(), 2800); }
  const escapeHtml=(s)=> s.replace(/[&<>\"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  document.addEventListener('click',(e)=>{
    if(e.target.dataset.close!==undefined || e.target.closest('[data-close]')){ const m=e.target.closest('.modal'); if(m) m.style.display='none'; }
    const navBtn=e.target.closest('.nav button'); if(navBtn && navBtn.dataset.go){ document.querySelectorAll('.nav button').forEach(b=> b.classList.remove('active')); navBtn.classList.add('active'); document.querySelectorAll('.section').forEach(s=> s.classList.remove('active')); byId(navBtn.dataset.go).classList.add('active'); }
    const tab=e.target.closest('.tabs .tab'); if(tab && tab.closest('#feed-tabs')){ document.querySelectorAll('#feed-tabs .tab').forEach(t=> t.classList.remove('active')); tab.classList.add('active'); state.ui.feedFilter=tab.dataset.filter; renderFeed(); }
    const lbtab=e.target.closest('.tabs .tab'); if(lbtab && !lbtab.closest('#feed-tabs')){ document.querySelectorAll('#lb-section .tab').forEach(t=> t.classList.remove('active')); lbtab.classList.add('active'); renderLeaderboard(getActiveLbTab()); }
    const storePack=e.target.closest('#modal-store [data-pack]'); if(storePack){ buyPack(parseInt(storePack.dataset.pack,10)); }
  });
  function getActiveLbTab(){ const active=Array.from(document.querySelectorAll('#lb-section .tab')).find(x=> x.classList.contains('active')); return active?.dataset.epoch || 'current'; }

  /* === Bindings === */
  byId('create-btn').onclick=()=> showModal(byId('modal-create'));
  byId('post-submit').onclick=createPostFlow; byId('boost-confirm').onclick=doBoost; byId('pin-confirm').onclick=doPin;
  byId('open-store').onclick=openStore; byId('open-friends').onclick=()=>{ showModal(byId('modal-friends')); renderFriendsModal(); };
  byId('btn-friends').onclick=()=>{ showModal(byId('modal-friends')); renderFriendsModal(); };
  byId('report-send').onclick=sendReport;
  byId('friend-add').onclick=()=>{
    const v=byId('friend-input').value.trim(); if(!v) return;
    const uid=state.currentUserId; let targetId=null;
    if(v.startsWith('@')){ const name=v.slice(1); targetId = name; state.users[targetId] ||= {id:targetId, firstName:'@'+name, username:name, diamonds:0}; }
    else { targetId=String(v); state.users[targetId] ||= {id:targetId, firstName:'User '+targetId, username:'user'+targetId, diamonds:0}; }
    follow(uid, targetId); byId('friend-input').value='';
  };

  /* === Realtime events === */
  RT.on((evt)=>{
    if(!evt||!evt.type) return;
    switch(evt.type){
      case 'post:new': {
        const p=deserializePost(evt.payload.post);
        state.users[p.authorId] ||= {id:p.authorId, firstName:'User '+p.authorId, username:'user'+p.authorId, diamonds:0};
        if(!state.posts.find(x=>x.id===p.id)){ state.posts.unshift(p); renderFeed(); save(); }
        break;
      }
      case 'post:boost': {
        const {id,boostedAt}=evt.payload; const p=state.posts.find(x=>x.id===id);
        if(p){ p.boostedAt=new Date(boostedAt); renderFeed(); save(); }
        break;
      }
      case 'post:stats': {
        const {id,likes,views}=evt.payload; const p=state.posts.find(x=>x.id===id);
        if(p){ p.likes=Math.max(p.likes,likes); p.views=Math.max(p.views,views); renderFeed(); save(); }
        break;
      }
      case 'pin:update': {
        const data=evt.payload;
        state.pin.active=data.active? { postId:data.active.postId, endsAt:new Date(data.active.endsAt) }:null;
        state.pin.queue=(data.queue||[]).map(q=> ({...q, enqueuedAt:new Date(q.enqueuedAt)}));
        renderPinned(); save(); break;
      }
      case 'social:follow': {
        const {from,to}=evt.payload;
        state.social.followers[to] ||= new Set(); state.social.followers[to].add(from);
        renderFriendsLists(); save(); break;
      }
      case 'social:unfollow': {
        const {from,to}=evt.payload; state.social.followers[to]?.delete(from); renderFriendsLists(); save(); break;
      }
      case 'presence:ping': {
        const {uid}=evt.payload; state.presence[uid]=Date.now(); renderHUD(); break;
      }
    }
  });

  function serializePost(p){ return { ...p, createdAt:p.createdAt.toISOString(), boostedAt:p.boostedAt? p.boostedAt.toISOString():null } }
  function deserializePost(p){ return { ...p, createdAt:new Date(p.createdAt), boostedAt:p.boostedAt? new Date(p.boostedAt):null } }

  /* === Tickers === */
  setInterval(()=>{ renderHUD(); pinTicker(); settlementTick(); renderPinned(); pingPresence(); }, 1000);

  /* === Boot === */
  applyTelegramTheme();
  if(!load()){ initUser(); }
  else { try{ initUser(); }catch(e){} }
  ensureSets();
  state.pool.epoch=toUtcYMD(); state.pool.endsAt=epochEndsAt(); ensureEpochStructures(state.pool.epoch);
  renderAll(); setTimeout(attachReadObserver,0);
  } // end if !__STOP_APP__
  </script>
</body>
</html>
