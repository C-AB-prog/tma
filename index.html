<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diamond Feed ‚Ä¢ TMA v1.2</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root{
      --bg:#0b0b0f;--bg-2:#12131a;--card:#141622;--muted:#99a2b3;--text:#f2f4f8;--brand:#7c8cff;--brand-2:#9a6bff;--ok:#43d6a3;--warn:#ffb84d;--err:#ff6b6b;
      --ring: 0 0 0 2px rgba(124,140,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 20% 0%, rgba(124,140,255,.13), transparent 60%),
      radial-gradient(900px 400px at 100% 0%, rgba(154,107,255,.12), transparent 60%),var(--bg);
      color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',Inter,Roboto,Segoe UI,Arial,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:0 16px 96px}

    /* Header */
    .header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.2) blur(12px);
      background:linear-gradient(to bottom, rgba(10,10,16,.8), rgba(10,10,16,.6));border-bottom:1px solid rgba(255,255,255,.06)}
    .header-row{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 0}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));
      display:grid;place-items:center;box-shadow:0 10px 24px rgba(124,140,255,.35)}
    .logo i{color:white}
    .title{font-weight:800;letter-spacing:.2px}

    .kpis{display:flex;gap:8px;align-items:center}
    .pill{display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      padding:8px 12px;border-radius:14px;font-size:13px;font-weight:700;}
    .pill i{opacity:.9}
    .hint{color:var(--muted);font-size:12px}

    /* Sections */
    .section{display:none;animation:fade .25s ease}
    .section.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    /* Pinned */
    .pinned{margin:16px 0;border:1px solid rgba(255,255,255,.08);border-radius:18px;overflow:hidden;background:linear-gradient(180deg,rgba(124,140,255,.14),rgba(124,140,255,.03));}
    .pinned__head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px dashed rgba(255,255,255,.12)}
    .pinned__label{display:flex;gap:10px;align-items:center;color:var(--brand);font-weight:800}
    .pinned__timer{display:flex;gap:8px;align-items:center;background:rgba(124,140,255,.25);border:1px solid rgba(124,140,255,.4);
      padding:6px 10px;border-radius:10px;font-weight:800}
    .pinned__body{padding:16px}
    .pinned__meta{display:flex;gap:14px;color:var(--muted);font-size:13px;margin-top:8px}
    .queue{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;margin-top:8px}

    /* Post card */
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:16px;margin:12px 0;box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .card:hover{box-shadow:0 14px 44px rgba(0,0,0,.33)}
    .row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .user{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;font-weight:800}
    .name{font-weight:800}
    .meta{color:var(--muted);font-size:12px;margin-top:2px}
    .content{margin:12px 0 10px;line-height:1.55;font-size:15px}
    .stats{display:flex;gap:14px;color:var(--muted);font-size:12px}

    .actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px}
    .btn{display:flex;gap:8px;align-items:center;justify-content:center;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));color:var(--text);font-weight:800;cursor:pointer}
    .btn:hover{box-shadow:var(--ring)}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btn.like.liked{border-color:rgba(255,107,107,.35);background:linear-gradient(180deg, rgba(255,107,107,.18), rgba(255,255,255,.02));color:#ff7f88}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);font-size:12px}
    .badge.rocket{color:var(--ok);border-color:rgba(67,214,163,.35);background:linear-gradient(180deg, rgba(67,214,163,.16), rgba(255,255,255,.02))}

    /* Empty */
    .empty{padding:48px 20px;text-align:center;color:var(--muted)}

    /* Bottom nav */
    .nav{position:fixed;left:0;right:0;bottom:0;backdrop-filter:blur(12px);background:linear-gradient(to top, rgba(10,10,16,.9), rgba(10,10,16,.6));
      border-top:1px solid rgba(255,255,255,.06);padding:10px 8px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px;z-index:60}
    .nav button{border:none;background:none;color:var(--muted);display:flex;flex-direction:column;gap:4px;align-items:center;padding:8px 6px;border-radius:10px;font-size:11px}
    .nav button.active{color:var(--brand);background:rgba(124,140,255,.14)}

    /* Floating create */
    .fab{position:fixed;right:16px;bottom:84px;width:60px;height:60px;border-radius:50%;display:grid;place-items:center;border:none;cursor:pointer;
      background:conic-gradient(from 180deg at 50% 50%, var(--brand) 0deg, var(--brand-2) 160deg, var(--brand) 360deg); color:white;
      box-shadow:0 16px 44px rgba(124,140,255,.55);z-index:55}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:80}
    .modal__card{width:min(92vw,420px);max-height:84vh;overflow:auto;border-radius:18px;border:1px solid rgba(255,255,255,.08);background:var(--card);padding:18px}
    .modal__head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .modal__title{font-weight:800}
    .close{border:none;background:none;color:var(--muted);font-size:20px;cursor:pointer}
    .label{font-size:13px;color:var(--muted);margin:8px 0}
    .input,.textarea,select{width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0f111a;color:var(--text)}
    .textarea{min-height:120px;resize:vertical}
    .submit{width:100%;margin-top:10px}

    /* Profile */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);
      border-radius:16px;padding:16px;text-align:center}
    .stat .v{font-size:20px;font-weight:900}
    .muted{color:var(--muted)}

    .pool{margin:16px 0;padding:16px;border-radius:18px;border:1px solid rgba(67,214,163,.35);
      background:linear-gradient(180deg, rgba(67,214,163,.16), rgba(67,214,163,.04))}

    /* Tabs (leaderboard) */
    .tabs{display:flex;gap:8px;margin:10px 0}
    .tab{padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:rgba(255,255,255,.03);cursor:pointer;color:var(--muted);font-weight:700}
    .tab.active{color:var(--brand);box-shadow:var(--ring)}

    /* Toast */
    .toast{position:fixed;right:16px;top:86px;z-index:90;display:grid;gap:8px}
    .toast .t{padding:12px 14px;border-radius:12px;color:#0b0b0f;font-weight:800}
    .t.ok{background:#43d6a3}
    .t.err{background:#ff7f88}
    .t.info{background:#7c8cff}
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <header class="header">
    <div class="container">
      <div class="header-row">
        <div class="brand">
          <div class="logo"><i class="fa-solid fa-gem"></i></div>
          <div>
            <div class="title">Diamond Feed</div>
            <div class="hint">–≠–ø–æ—Ö–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤ <span id="epoch-utc">00:00 UTC</span> ‚Ä¢ –æ—Å—Ç–∞–ª–æ—Å—å <span id="epoch-eta">--:--:--</span></div>
          </div>
        </div>
        <div class="kpis">
          <div class="pill"><i class="fa-solid fa-trophy"></i> <span id="points-pill">0 RAW / 0 EFF</span></div>
          <div class="pill"><i class="fa-solid fa-sack-dollar"></i> <span id="reward-pill">~0 üíé</span></div>
          <div class="pill"><i class="fa-solid fa-gem"></i> <span id="balance-pill">0</span></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Pinned slot -->
    <section class="pinned" id="pinned" style="display:none">
      <div class="pinned__head">
        <div class="pinned__label"><i class="fa-solid fa-thumbtack"></i> –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ ‚Ä¢ <span id="pin-author">‚Äî</span></div>
        <div class="pinned__timer"><i class="fa-regular fa-clock"></i> <span id="pin-timer">01:00</span></div>
      </div>
      <div class="pinned__body">
        <div id="pin-text" class="content"></div>
        <div class="pinned__meta"><span><i class="fa-regular fa-eye"></i> <span id="pin-views">0</span></span>
          <span><i class="fa-regular fa-heart"></i> <span id="pin-likes">0</span></span></div>
        <div class="queue" id="pin-queue" style="display:none"><i class="fa-solid fa-list-ol"></i> –í –æ—á–µ—Ä–µ–¥–∏: <span id="queue-len">0</span></div>
        <div id="pin-cta" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- FEED -->
    <section id="feed-section" class="section active">
      <div id="feed"></div>
      <div class="empty" id="feed-empty" style="display:none">
        <i class="fa-regular fa-newspaper" style="font-size:42px"></i>
        <div style="margin-top:8px">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ–ø—É–±–ª–∏–∫—É–µ—Ç –ø–æ—Å—Ç.</div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="lb-section" class="section">
      <div class="tabs">
        <button class="tab active" data-epoch="current">–°–µ–≥–æ–¥–Ω—è</button>
        <button class="tab" data-epoch="prev">–í—á–µ—Ä–∞</button>
      </div>
      <div id="leaderboard"></div>
    </section>

    <!-- PROFILE -->
    <section id="profile-section" class="section">
      <div class="card">
        <div class="row">
          <div class="user">
            <div class="avatar" id="pf-avatar">U</div>
            <div>
              <div class="name" id="pf-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
              <div class="meta" id="pf-id">ID: ‚Äî</div>
              <div class="meta"><i class="fa-solid fa-shield"></i> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —á–µ—Ä–µ–∑ Telegram</div>
            </div>
          </div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div class="stat"><div class="v" id="pf-diamonds">0</div><div class="muted">–ê–ª–º–∞–∑–æ–≤</div></div>
          <div class="stat"><div class="v" id="pf-posts">0</div><div class="muted">–ü–æ—Å—Ç–æ–≤</div></div>
          <div class="stat"><div class="v" id="pf-reads">0</div><div class="muted">–ü—Ä–æ—á—Ç–µ–Ω–∏–π (RAW)</div></div>
          <div class="stat"><div class="v" id="pf-reacts">0</div><div class="muted">–†–µ–∞–∫—Ü–∏–π (RAW)</div></div>
          <div class="stat"><div class="v" id="pf-raw">0</div><div class="muted">–ë–∞–ª–ª—ã (RAW)</div></div>
          <div class="stat"><div class="v" id="pf-eff">0</div><div class="muted">–ë–∞–ª–ª—ã (EFF)</div></div>
        </div>
        <div class="pool">
          <div style="font-weight:900">–û—Ü–µ–Ω–æ—á–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ —Å–µ–≥–æ–¥–Ω—è</div>
          <div class="name" id="pf-est">~0 üíé</div>
          <div class="muted">–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º –ø—É–ª–µ</div>
        </div>
      </div>
    </section>

    <!-- POOL -->
    <section id="pool-section" class="section">
      <div class="pool">
        <div class="name">–¢–µ–∫—É—â–∏–π –ø—É–ª: <span id="pool-amount">0</span> üíé</div>
        <div class="muted">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (>= MIN_POINTS): <span id="pool-part">0</span></div>
      </div>
      <div class="card">
        <div class="name">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</div>
        <div class="muted" style="margin-top:6px">–î–æ–ª—è = –í–∞—à–∏ –±–∞–ª–ª—ã / Œ£–ë–∞–ª–ª–æ–≤ ‚Ä¢ –í—ã–ø–ª–∞—Ç–∞ = –ü—É–ª √ó –î–æ–ª—è ‚Ä¢ –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 0.01, ¬´–ø—ã–ª—å¬ª –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å</div>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="nav">
    <button class="active" data-go="feed-section"><i class="fa-solid fa-home"></i><span>–õ–µ–Ω—Ç–∞</span></button>
    <button data-go="lb-section"><i class="fa-solid fa-ranking-star"></i><span>–¢–æ–ø</span></button>
    <button data-go="profile-section"><i class="fa-solid fa-user"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    <button data-go="pool-section"><i class="fa-solid fa-coins"></i><span>–ü—É–ª</span></button>
    <button id="open-store"><i class="fa-solid fa-store"></i><span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
  </nav>

  <!-- FAB -->
  <button class="fab" id="create-btn"><i class="fa-solid fa-plus"></i></button>

  <!-- Modals -->
  <div class="modal" id="modal-create">
    <div class="modal__card">
      <div class="modal__head"><div class="modal__title">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</div><button class="close" data-close>&times;</button></div>
      <label class="label">–¢–µ–∫—Å—Ç (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤, –±–µ–∑ —Å—Å—ã–ª–æ–∫)</label>
      <textarea id="post-text" class="textarea" maxlength="500" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —á–µ–º-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º‚Ä¶"></textarea>
      <button id="post-submit" class="btn submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞ 10 üíé</button>
      <div class="muted" style="margin-top:6px">–ë—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ 10 –∞–ª–º–∞–∑–æ–≤</div>
    </div>
  </div>

  <div class="modal" id="modal-boost">
    <div class="modal__card">
      <div class="modal__head"><div class="modal__title">–ë—É—Å—Ç –ø–æ—Å—Ç–∞</div><button class="close" data-close>&times;</button></div>
      <div class="label">–ü–æ–¥–Ω—è—Ç—å –ø–æ—Å—Ç –≤ —Ç–æ–ø –∑–∞ 10 üíé? (–∫—É–ª–¥–∞—É–Ω 5 –º–∏–Ω—É—Ç)</div>
      <button id="boost-confirm" class="btn submit">–ü–æ–¥–Ω—è—Ç—å –∑–∞ 10 üíé</button>
      <div class="muted" id="boost-hint"></div>
    </div>
  </div>

  <div class="modal" id="modal-pin">
    <div class="modal__card">
      <div class="modal__head"><div class="modal__title">–ó–∞–∫—Ä–µ–ø–∏—Ç—å –ø–æ—Å—Ç</div><button class="close" data-close>&times;</button></div>
      <div class="label">1 –º–∏–Ω—É—Ç–∞ –∑–∞–∫—Ä–µ–ø–∞ = 100 üíé. –ï—Å–ª–∏ —Å–ª–æ—Ç –∑–∞–Ω—è—Ç ‚Äî –≤–∞—à –ø–æ—Å—Ç –≤—Å—Ç–∞–Ω–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å FIFO. –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–æ–¥–ª–µ–≤–∞—é—Ç –≤—Ä–µ–º—è.</div>
      <button id="pin-confirm" class="btn submit">–í –æ—á–µ—Ä–µ–¥—å / –ó–∞–∫—Ä–µ–ø–∏—Ç—å –∑–∞ 100 üíé</button>
      <div class="muted">–°–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è 100 –∞–ª–º–∞–∑–æ–≤ –∑–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É</div>
    </div>
  </div>

  <div class="modal" id="modal-store">
    <div class="modal__card">
      <div class="modal__head"><div class="modal__title">–ü–æ–∫—É–ø–∫–∞ –∞–ª–º–∞–∑–æ–≤</div><button class="close" data-close>&times;</button></div>
      <label class="label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
      <select id="pay-method"><option value="stars">Telegram Stars (iOS)</option><option value="ton">TON (Android/Desktop)</option></select>
      <div class="grid" style="margin-top:10px">
        <button class="btn" data-pack="100">100 üíé ‚Ä¢ ~1 TON</button>
        <button class="btn" data-pack="500">500 üíé ‚Ä¢ ~5 TON</button>
        <button class="btn" data-pack="1000">1000 üíé ‚Ä¢ ~10 TON</button>
        <button class="btn" data-pack="5000">5000 üíé ‚Ä¢ ~50 TON</button>
      </div>
      <div class="muted" style="margin-top:8px">–î–µ–º–æ‚Äë–æ–ø–ª–∞—Ç–∞: —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (—ç–º—É–ª—è—Ü–∏—è)</div>
    </div>
  </div>

  <!-- Report modal (stub) -->
  <div class="modal" id="modal-report">
    <div class="modal__card">
      <div class="modal__head"><div class="modal__title">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div><button class="close" data-close>&times;</button></div>
      <label class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="report-type"><option>–°–ø–∞–º</option><option>NSFW</option><option>–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ</option><option>–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è</option></select>
      <button id="report-send" class="btn submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
      <div class="muted">–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º (–¥–µ–º–æ)</div>
    </div>
  </div>

  <script>
    /* ===== Constants per –¢–ó ===== */
    const ECONOMY = Object.freeze({
      COST_POST: 10,
      COST_BOOST: 10,
      COST_PIN_PER_MIN: 100,
      BOOST_COOLDOWN_MS: 5 * 60 * 1000,
      POOL_SHARE: 1.0,
      PLATFORM_FEE: 0,
      MIN_POINTS: 5,
      CAPS: { READS: 200, REACTS: 100, PER_AUTHOR: 20 }
    });

    /* ===== Helpers (time/epoch) ===== */
    const now = () => new Date();
    const toUtcYMD = (d = now()) => new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString().slice(0,10);
    const epochEndsAt = () => new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate()+1, 0,0,0));
    const fmtClock = (ms) => {
      if (ms < 0) ms = 0; const s = Math.floor(ms/1000);
      const h = String(Math.floor(s/3600)).padStart(2,'0');
      const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${h}:${m}:${ss}`;
    }

    /* ===== State ===== */
    let state = {
      users: {},
      currentUserId: null,
      posts: [], // {id, authorId, text, createdAt, views, likes, boostedAt}
      interactions: {}, // interactions[epoch][userId][postId] = { read: true, react: true }
      daily: {}, // daily[epoch][userId] = { reads:0, reacts:0, perAuthor: {authorId:count} }
      points: {}, // points[epoch][userId] = { reads:0, reacts:0, raw:0, eff:0 }
      trust: {}, // trust[userId] in [0.1..1.0]
      pool: { amount: 0, dust: 0, participants: 0, epoch: toUtcYMD(), endsAt: epochEndsAt() },
      pin: { active: null /* {postId, endsAt} */, queue: [] /* FIFO of {postId, userId, minutes, enqueuedAt} */ },
      transactions: {}, // transactions[userId] = [{type, amount, meta, at}]
      moderation: { reports: [] },
      ui: { currentPostId: null }
    };

    const save = () => {
      localStorage.setItem('diamond-feed-v12', JSON.stringify(state, (k,v)=> v instanceof Date ? {__t:'d',v:v.toISOString()}: v));
    };
    const reviveDates = (o)=>{
      if (!o || typeof o !== 'object') return o;
      if (o.__t==='d') return new Date(o.v);
      for (const k of Object.keys(o)) o[k] = reviveDates(o[k]);
      return o;
    }
    const load = () => {
      const raw = localStorage.getItem('diamond-feed-v12');
      if (!raw) return false;
      try { const parsed = reviveDates(JSON.parse(raw)); state = parsed; return true; } catch(e){ console.warn(e); return false; }
    }

    /* ===== User bootstrap (Telegram or mock) ===== */
    function initUser(){
      let u = null;
      try{ if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){ u = Telegram.WebApp.initDataUnsafe.user; }}catch(e){}
      if (!u){ u = { id: '1', first_name: 'Telegram', last_name:'User', username:'tg_user', is_premium:false } }
      const id = String(u.id);
      if (!state.users[id]){
        state.users[id] = { id, firstName: u.first_name||'User', lastName: u.last_name||'', username: u.username||'user', isPremium: !!u.is_premium, diamonds: 250 };
        state.trust[id] = 1.0;
      }
      state.currentUserId = id;

      // some demo users and posts
      if (Object.keys(state.users).length < 3){
        const demos = [
          {id:'2', firstName:'–ê–ª–µ–∫—Å–µ–π', username:'alexey_tg', isPremium:true, diamonds:420},
          {id:'3', firstName:'–ú–∞—Ä–∏—è', username:'maria_tg', isPremium:false, diamonds:150},
          {id:'4', firstName:'–î–º–∏—Ç—Ä–∏–π', username:'dmitry_tg', isPremium:true, diamonds:90},
        ];
        for (const du of demos){ state.users[du.id] = {...du}; state.trust[du.id] = 1.0 }
        if (!state.posts.length){
          publishPost('2', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ü–ª–∞—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã —Å–æ–∑–¥–∞—é—Ç –ø—É–ª –Ω–∞–≥—Ä–∞–¥ ‚Äî —á–∏—Ç–∞–π—Ç–µ –∏ —Ä–µ–∞–≥–∏—Ä—É–π—Ç–µ, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å.');
          publishPost('3', 'MVP: —Ç–µ–∫—Å—Ç –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤, –±–µ–∑ —Å—Å—ã–ª–æ–∫. –õ–∞–π–∫ = +3 –±–∞–ª–ª–∞, –ø—Ä–æ—á—Ç–µ–Ω–∏–µ = +1.');
        }
      }
    }

    /* ===== Econ helpers ===== */
    function spendDiamonds(userId, amount, meta){
      const u = state.users[userId];
      if (!u || u.diamonds < amount) return false;
      u.diamonds -= amount;
      // pool formation (after platform fee; share) ‚Äî only for paid actions
      const toPool = Math.floor(amount * ECONOMY.POOL_SHARE * (1-ECONOMY.PLATFORM_FEE));
      state.pool.amount += toPool;
      (state.transactions[userId] ||= []).push({type:'spend', amount, meta, at: now()});
      return true;
    }

    /* ===== Posts ===== */
    function publishPost(authorId, text){
      const post = { id: String(Date.now()+Math.random()), authorId, text, createdAt: now(), views: 0, likes: 0, boostedAt: null };
      state.posts.unshift(post);
      return post;
    }

    function createPostFlow(){
      const text = document.getElementById('post-text').value.trim();
      if (!text){ toast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞', 'err'); return; }
      if (/https?:\/\//i.test(text)){ toast('–°—Å—ã–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ MVP', 'err'); return; }
      if (text.length>500){ toast('–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ', 'err'); return; }
      if (!spendDiamonds(state.currentUserId, ECONOMY.COST_POST, {op:'post'})){
        toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤', 'err'); openStore(); return;
      }
      const p = publishPost(state.currentUserId, text);
      closeModal('modal-create');
      document.getElementById('post-text').value='';
      renderAll(); save();
      toast('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
    }

    /* ===== Boost (cooldown) ===== */
    function openBoost(postId){ state.ui.currentPostId = postId; const modal = byId('modal-boost');
      const post = state.posts.find(p=>p.id===postId);
      const cdLeft = post.boostedAt ? (post.boostedAt.getTime()+ECONOMY.BOOST_COOLDOWN_MS - now().getTime()) : 0;
      byId('boost-hint').textContent = cdLeft>0 ? `–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ ${fmtClock(cdLeft)}` : '';
      showModal(modal);
    }
    function doBoost(){
      const post = state.posts.find(p=>p.id===state.ui.currentPostId);
      if (!post) return;
      if (post.authorId !== state.currentUserId){ toast('–ë—É—Å—Ç–∏—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä (MVP)', 'err'); return; }
      const cdLeft = post.boostedAt ? (post.boostedAt.getTime()+ECONOMY.BOOST_COOLDOWN_MS - now().getTime()) : 0;
      if (cdLeft>0){ toast('–†–∞–Ω–æ: –∫—É–ª–¥–∞—É–Ω 5 –º–∏–Ω—É—Ç', 'err'); return; }
      if (!spendDiamonds(state.currentUserId, ECONOMY.COST_BOOST, {op:'boost', postId:post.id})){
        toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤', 'err'); closeModal('modal-boost'); openStore(); return;
      }
      post.boostedAt = now();
      closeModal('modal-boost');
      renderAll(); save();
      toast('–ü–æ—Å—Ç –ø–æ–¥–Ω—è—Ç –≤ —Ç–æ–ø');
    }

    /* ===== Pin (single slot + FIFO queue; multiply extends) ===== */
    function openPin(postId){ state.ui.currentPostId = postId; showModal(byId('modal-pin')); }
    function doPin(){
      const postId = state.ui.currentPostId; const post = state.posts.find(p=>p.id===postId); if (!post) return;
      if (post.authorId !== state.currentUserId){ toast('–ó–∞–∫—Ä–µ–ø–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä (MVP)', 'err'); return; }
      if (!spendDiamonds(state.currentUserId, ECONOMY.COST_PIN_PER_MIN, {op:'pin', postId})){
        toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤', 'err'); closeModal('modal-pin'); openStore(); return;
      }
      // If active pin is this post ‚Äî extend 1 minute. If it's in queue last ‚Äî extend. Else enqueue or take slot if free
      const plusMs = 60*1000;
      if (state.pin.active && state.pin.active.postId===postId){ state.pin.active.endsAt = new Date(state.pin.active.endsAt.getTime()+plusMs); }
      else if (state.pin.queue.length && state.pin.queue[state.pin.queue.length-1].postId===postId){ state.pin.queue[state.pin.queue.length-1].minutes += 1; }
      else if (!state.pin.active){ state.pin.active = { postId, endsAt: new Date(now().getTime()+plusMs) } }
      else { state.pin.queue.push({ postId, userId: state.currentUserId, minutes: 1, enqueuedAt: now() }); }
      closeModal('modal-pin'); renderAll(); save(); toast('–ü–æ–∫—É–ø–∫–∞ –∑–∞–∫—Ä–µ–ø–∞ —É—Å–ø–µ—à–Ω–∞');
    }

    function pinTicker(){
      if (!state.pin.active) return;
      const left = state.pin.active.endsAt.getTime()-now().getTime();
      if (left <= 0){
        // advance queue
        const next = state.pin.queue.shift();
        if (next){ state.pin.active = { postId: next.postId, endsAt: new Date(now().getTime() + next.minutes*60*1000) } }
        else { state.pin.active = null }
        renderAll(); save();
      }
    }

    /* ===== Reads (+1) with 50% visibility & 2s dwell, active tab ===== */
    const readWatch = new Map(); // postId -> { seenAt }
    let visibilityOk = document.visibilityState==='visible';
    window.addEventListener('visibilitychange', ()=> visibilityOk = document.visibilityState==='visible');
    window.addEventListener('focus', ()=> visibilityOk=true);
    window.addEventListener('blur', ()=> visibilityOk=false);

    function ensureEpochStructures(ep){
      state.interactions[ep] ||= {}; state.daily[ep] ||= {}; state.points[ep] ||= {};
      const uid = state.currentUserId;
      state.interactions[ep][uid] ||= {}; state.daily[ep][uid] ||= { reads:0, reacts:0, perAuthor:{} };
      state.points[ep][uid] ||= { reads:0, reacts:0, raw:0, eff:0 };
    }

    function grantRead(post){
      const ep = state.pool.epoch; ensureEpochStructures(ep);
      const uid = state.currentUserId; const authorId = post.authorId;
      if (authorId===uid) return; // self-read ignored
      const caps = state.daily[ep][uid];
      if (caps.reads >= ECONOMY.CAPS.READS) return;
      const fromAuthor = (caps.perAuthor[authorId]||0);
      if (fromAuthor >= ECONOMY.CAPS.PER_AUTHOR) return;
      const inter = state.interactions[ep][uid][post.id] ||= { read:false, react:false };
      if (inter.read) return; // unique
      inter.read = true;
      caps.reads += 1; caps.perAuthor[authorId] = fromAuthor + 1;
      const p = state.points[ep][uid]; p.reads += 1; p.raw += 1; p.eff = Math.round(p.raw*(state.trust[uid]||1.0));
      post.views += 1;
      save(); renderHUD();
    }

    function grantReact(post){
      const ep = state.pool.epoch; ensureEpochStructures(ep);
      const uid = state.currentUserId; const authorId = post.authorId;
      if (authorId===uid) return; // self-react ignored
      const caps = state.daily[ep][uid];
      if (caps.reacts >= ECONOMY.CAPS.REACTS) return;
      const fromAuthor = (caps.perAuthor[authorId]||0);
      if (fromAuthor >= ECONOMY.CAPS.PER_AUTHOR) return;
      const inter = state.interactions[ep][uid][post.id] ||= { read:false, react:false };
      if (inter.react) return; // unique
      inter.react = true;
      caps.reacts += 1; caps.perAuthor[authorId] = fromAuthor + 1;
      const p = state.points[ep][uid]; p.reacts += 1; p.raw += 3; p.eff = Math.round(p.raw*(state.trust[uid]||1.0));
      post.likes += 1;
      save(); renderAll(); toast('+3 –±–∞–ª–ª–∞!', 'ok');
    }

    function attachReadObserver(){
      const options = { root:null, rootMargin:'0px', threshold:[0, .5, 1] };
      const io = new IntersectionObserver((entries)=>{
        for (const e of entries){ const el = e.target; const postId = el.dataset.postId; const halfVisible = e.intersectionRatio >= .5;
          if (halfVisible){ readWatch.set(postId, { seenAt: now() }); } else { readWatch.delete(postId); }
        }
      }, options);
      document.querySelectorAll('.card[data-post-id]').forEach(el=> io.observe(el));
      // dwell checker
      setInterval(()=>{
        if (!visibilityOk) return;
        for (const [postId, ctx] of readWatch){ if (now().getTime()-ctx.seenAt.getTime() >= 2000){
            const post = state.posts.find(p=>p.id===postId); if (post){ grantRead(post); readWatch.delete(postId); }
        }}
      }, 600);
    }

    /* ===== Epoch settlement (reward distribution) ===== */
    function settlementTick(){
      if (now().getTime() < state.pool.endsAt.getTime()) return;
      // close epoch
      const ep = state.pool.epoch; const nextEp = toUtcYMD(new Date(state.pool.endsAt));
      const points = state.points[ep]||{}; const eligible = Object.entries(points).filter(([uid,p])=> (p.eff||0) > ECONOMY.MIN_POINTS);
      const sumEff = eligible.reduce((s, [,p])=> s + (p.eff||0), 0);
      let poolTotal = state.pool.amount + (state.pool.dust||0);
      const payouts = [];
      let used = 0;
      if (sumEff>0 && poolTotal>0){
        for (const [uid,p] of eligible){ const share = p.eff / sumEff; let amt = poolTotal * share; amt = Math.floor(amt*100)/100; used += amt; payouts.push([uid, amt]); }
      }
      const dust = Math.max(0, poolTotal - used);
      // credit users
      for (const [uid,amt] of payouts){ state.users[uid].diamonds = (state.users[uid].diamonds||0) + amt; (state.transactions[uid] ||= []).push({type:'reward', amount: amt, meta:{epoch:ep}, at: now()}); }
      // prep next epoch
      state.pool = { amount: 0, dust: dust, participants: 0, epoch: nextEp, endsAt: epochEndsAt() };
      state.pin = state.pin; // keep pin as is (doesn't reset at epoch)
      // keep points but rendering switches to current
      renderAll(); save(); toast('–≠–ø–æ—Ö–∞ –∑–∞–∫—Ä—ã—Ç–∞. –í—ã–ø–ª–∞—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã.', 'ok');
    }

    /* ===== Rendering ===== */
    const byId = (id)=> document.getElementById(id);

    function renderHUD(){
      const uid = state.currentUserId; const user = state.users[uid];
      const ep = state.pool.epoch; const P = state.points[ep]?.[uid] || {raw:0, eff:0};
      byId('balance-pill').textContent = user.diamonds;
      byId('points-pill').textContent = `${P.raw||0} RAW / ${P.eff||0} EFF`;
      const est = estimateReward(uid);
      byId('reward-pill').textContent = `~${est} üíé`;
      byId('epoch-utc').textContent = '24:00 UTC';
      byId('epoch-eta').textContent = fmtClock(state.pool.endsAt.getTime()-now().getTime());

      // profile
      byId('pf-avatar').textContent = avatarText(user);
      byId('pf-name').textContent = displayName(user);
      byId('pf-id').textContent = `ID: ${user.id}`;
      byId('pf-diamonds').textContent = user.diamonds;
      const stats = state.points[ep]?.[uid] || {reads:0, reacts:0, raw:0, eff:0};
      byId('pf-reads').textContent = stats.reads||0; byId('pf-reacts').textContent = stats.reacts||0;
      byId('pf-raw').textContent = stats.raw||0; byId('pf-eff').textContent = stats.eff||0;
      byId('pf-posts').textContent = state.posts.filter(p=>p.authorId===uid).length;
      byId('pf-est').textContent = `~${est} üíé`;

      // pool screen
      byId('pool-amount').textContent = (state.pool.amount + (state.pool.dust||0)).toFixed(2);
      const eligible = Object.values(state.points[ep]||{}).filter(p=> (p.eff||0) > ECONOMY.MIN_POINTS).length; byId('pool-part').textContent = eligible;
    }

    function estimateReward(uid){
      const ep = state.pool.epoch; const userEff = state.points[ep]?.[uid]?.eff || 0; const sumEff = Object.values(state.points[ep]||{}).reduce((s,p)=> s+(p.eff||0), 0);
      if (userEff<=0 || sumEff<=0) return 0; const total = state.pool.amount + (state.pool.dust||0);
      return Math.floor((total * (userEff/sumEff))*100)/100;
    }

    function sortPosts(){
      // pinned slot rendered separately; feed: boosted_at DESC then created_at DESC
      return [...state.posts].sort((a,b)=>{
        const ab = b.boostedAt? b.boostedAt.getTime():0; const aa = a.boostedAt? a.boostedAt.getTime():0;
        if (ab !== aa) return ab-aa; // desc
        return b.createdAt.getTime()-a.createdAt.getTime();
      });
    }

    function avatarText(u){ return (u.firstName||u.username||'U').slice(0,1).toUpperCase() }
    function displayName(u){ return u.firstName && u.lastName ? `${u.firstName} ${u.lastName}` : (u.firstName || `@${u.username}`) }

    function renderFeed(){
      const list = byId('feed');
      const items = sortPosts();
      list.innerHTML = items.map(p=>{
        const author = state.users[p.authorId];
        const isMine = p.authorId===state.currentUserId;
        const liked = !!(state.interactions[state.pool.epoch]?.[state.currentUserId]?.[p.id]?.react);
        const canBoost = isMine;
        const cdLeft = p.boostedAt ? (p.boostedAt.getTime()+ECONOMY.BOOST_COOLDOWN_MS - now().getTime()) : 0;
        return `
          <article class="card" data-post-id="${p.id}">
            <div class="row">
              <div class="user">
                <div class="avatar">${avatarText(author)}</div>
                <div>
                  <div class="name">${displayName(author)} ${author.isPremium?'<i class=\"fa-solid fa-star\" style=\"color:var(--ok)\"></i>':''} ${isMine?'<span class=\"muted\">(–í—ã)</span>':''}</div>
                  <div class="meta">${p.createdAt.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})} ${p.boostedAt? ' ‚Ä¢ <span class="badge rocket"><i class="fa-solid fa-rocket"></i> Boost</span>':''}</div>
                </div>
              </div>
              <button class="btn" onclick="openReport('${p.id}')" title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è"><i class="fa-solid fa-flag"></i></button>
            </div>
            <div class="content">${escapeHtml(p.text)}</div>
            <div class="stats"><span><i class="fa-regular fa-eye"></i> ${p.views}</span><span><i class="fa-regular fa-heart"></i> ${p.likes}</span></div>
            <div class="actions">
              <button class="btn like ${liked?'liked':''}" ${isMine? 'disabled':''} onclick="react('${p.id}')"><i class="${liked?'fa-solid':'fa-regular'} fa-heart"></i> –õ–∞–π–∫</button>
              <button class="btn" ${!canBoost? 'disabled':''} onclick="openBoost('${p.id}')"><i class="fa-solid fa-rocket"></i> –ë—É—Å—Ç ${cdLeft>0?`(${fmtClock(cdLeft)})`:''}</button>
              <button class="btn" ${!isMine? 'disabled':''} onclick="openPin('${p.id}')"><i class="fa-solid fa-thumbtack"></i> –ó–∞–∫—Ä–µ–ø</button>
            </div>
          </article>`;
      }).join('');

      byId('feed-empty').style.display = items.length? 'none':'block';
      attachReadObserver();
      renderPinned();
    }

    function renderPinned(){
      const slot = byId('pinned');
      if (!state.pin.active){ slot.style.display='none'; byId('pin-cta').innerHTML=''; return; }
      const p = state.posts.find(x=> x.id===state.pin.active.postId);
      if (!p){ slot.style.display='none'; return; }
      const author = state.users[p.authorId];
      slot.style.display='block';
      byId('pin-author').textContent = displayName(author);
      byId('pin-text').textContent = p.text;
      byId('pin-views').textContent = p.views; byId('pin-likes').textContent = p.likes;
      byId('pin-queue').style.display = state.pin.queue.length? 'flex':'none'; byId('queue-len').textContent = state.pin.queue.length;
      const left = state.pin.active.endsAt.getTime()-now().getTime(); byId('pin-timer').textContent = fmtClock(left);
      if (p.authorId===state.currentUserId){ byId('pin-cta').innerHTML = `<button class="btn" onclick="openPin('${p.id}')"><i class='fa-solid fa-plus'></i> –ü—Ä–æ–¥–ª–∏—Ç—å 1 –º–∏–Ω –∑–∞ 100 üíé</button>` } else { byId('pin-cta').innerHTML = '' }
    }

    function renderLeaderboard(which='current'){
      const lb = byId('leaderboard'); const ep = which==='current'? state.pool.epoch : toUtcYMD(new Date(Date.parse(state.pool.epoch)+24*3600*1000-1)); // prev stored
      const entries = Object.entries(state.points[ep]||{}).map(([uid,p])=>({uid, p})).filter(x=> (x.p.eff||0)>0).sort((a,b)=> (b.p.eff||0)-(a.p.eff||0)).slice(0,100);
      lb.innerHTML = entries.map((x,i)=>{
        const u = state.users[x.uid];
        const est = which==='current'? estimateReward(x.uid): 0;
        return `<div class="card">
          <div class="user"><div class="avatar" style="background:${rankBg(i+1)}">${i+1}</div>
            <div style="margin-left:8px"><div class="name">${displayName(u)} ${x.uid===state.currentUserId?'<span class=\"muted\">(–í—ã)</span>':''}</div>
            <div class="meta">${x.p.eff} –±–∞–ª–ª–æ–≤ ‚Ä¢ ${which==='current'?`~${est} üíé`: '–ø—Ä–æ—à–ª–∞—è —ç–ø–æ—Ö–∞'}</div></div></div>
        </div>`
      }).join('') || `<div class="empty">–†–µ–π—Ç–∏–Ω–≥ –ø—É—Å—Ç</div>`;
    }

    function rankBg(r){ return r===1? 'linear-gradient(135deg,#FFD700,#FFA500)': r===2? 'linear-gradient(135deg,#C0C0C0,#A0A0A0)': r===3? 'linear-gradient(135deg,#CD7F32,#A0522D)': 'linear-gradient(135deg,var(--brand),var(--brand-2))' }

    function renderAll(){ renderHUD(); renderFeed(); renderLeaderboard(getActiveLbTab()); }

    /* ===== Actions (UI bindings) ===== */
    function react(postId){ const post = state.posts.find(p=>p.id===postId); if (!post) return; grantReact(post); }

    function openReport(postId){ state.ui.currentPostId = postId; showModal(byId('modal-report')); }
    function sendReport(){ const type = byId('report-type').value; state.moderation.reports.push({postId: state.ui.currentPostId, type, at: now()}); save(); closeModal('modal-report'); toast('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', 'info'); }

    function openStore(){ showModal(byId('modal-store')); }
    function buyPack(amount){ const uid = state.currentUserId; state.users[uid].diamonds += amount; (state.transactions[uid] ||= []).push({type:'purchase', amount, meta:{method: byId('pay-method').value}, at: now()}); save(); renderHUD(); closeModal('modal-store'); toast(`–ö—É–ø–ª–µ–Ω–æ ${amount} üíé`, 'ok'); }

    /* ===== UI utils ===== */
    function showModal(el){ el.style.display='flex'; }
    function closeModal(id){ byId(id).style.display='none'; }
    function toast(msg, kind='ok'){ const t = document.createElement('div'); t.className = `t ${kind==='err'?'err':kind==='info'?'info':'ok'}`; t.textContent = msg; byId('toast').appendChild(t); setTimeout(()=> t.remove(), 2800); }
    const escapeHtml = (s)=> s.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

    /* ===== Event wiring ===== */
    document.addEventListener('click', (e)=>{ if (e.target.dataset.close!==undefined || e.target.closest('[data-close]')){ const m = e.target.closest('.modal'); if (m) m.style.display='none'; }
      const navBtn = e.target.closest('.nav button'); if (navBtn && navBtn.dataset.go){ document.querySelectorAll('.nav button').forEach(b=> b.classList.remove('active')); navBtn.classList.add('active'); document.querySelectorAll('.section').forEach(s=> s.classList.remove('active')); byId(navBtn.dataset.go).classList.add('active'); }
      const tab = e.target.closest('.tab'); if (tab){ document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active')); tab.classList.add('active'); renderLeaderboard(getActiveLbTab()); }
      const storePack = e.target.closest('#modal-store [data-pack]'); if (storePack){ buyPack(parseInt(storePack.dataset.pack,10)); }
    });

    function getActiveLbTab(){ return document.querySelector('.tabs .tab.active')?.dataset.epoch || 'current'; }

    byId('create-btn').onclick = ()=> showModal(byId('modal-create'));
    byId('post-submit').onclick = createPostFlow;
    byId('boost-confirm').onclick = doBoost;
    byId('pin-confirm').onclick = doPin;
    byId('open-store').onclick = openStore;
    byId('report-send').onclick = sendReport;

    /* ===== App loop (tickers) ===== */
    setInterval(()=>{ renderHUD(); pinTicker(); settlementTick(); renderPinned(); }, 1000);

    /* ===== Init ===== */
    if (!load()){ initUser(); }
    else { // revive Date objects in posts & pin
      state.posts = state.posts.map(p=> ({...p, createdAt: new Date(p.createdAt), boostedAt: p.boostedAt? new Date(p.boostedAt): null }));
      if (state.pin.active){ state.pin.active.endsAt = new Date(state.pin.active.endsAt) }
      if (Array.isArray(state.pin.queue)){ state.pin.queue = state.pin.queue.map(q=> ({...q, enqueuedAt: new Date(q.enqueuedAt)})) }
    }
    // ensure current epoch values
    state.pool.epoch = toUtcYMD(); state.pool.endsAt = epochEndsAt();
    ensureEpochStructures(state.pool.epoch);
    renderAll();
  </script>
</body>
</html>
